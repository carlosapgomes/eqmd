# Phase 4: Monitoring Dashboard Implementation Plan

## Executive Summary

**Objective**: Create a comprehensive security monitoring dashboard for administrators to detect and investigate suspicious database activity in real-time.

**Timeline**: 2-3 days  
**Priority**: MEDIUM (Security visibility)  
**Risk Level**: LOW (Read-only dashboard)

## Problem Statement

After implementing audit logging (Phase 1), soft deletes (Phase 2), and IP logging (Phase 3), administrators need:

- **Real-time visibility** into system activity
- **Pattern recognition** for suspicious behavior
- **Investigation tools** for incident response
- **Proactive alerts** for unusual activity
- **Historical analysis** capabilities

Based on your experience with database poisoning, a monitoring dashboard provides:
- **Early detection** of malicious activity
- **Visual patterns** that are hard to spot in logs
- **Quick investigation** capabilities
- **Evidence collection** for incident response

## Solution: Security Monitoring Dashboard

Comprehensive dashboard with:
- Real-time activity monitoring
- Suspicious activity detection
- Geographic access visualization
- User behavior analytics
- Investigation tools

## Implementation Plan

### Step 1: Dashboard Architecture

#### 1.1: Dashboard Models

```python
# apps/core/models/monitoring.py
from django.db import models
from django.utils import timezone
from django.contrib.auth import get_user_model
from datetime import timedelta

User = get_user_model()

class SecurityAlert(models.Model):
    """Security alerts generated by monitoring system."""
    
    ALERT_TYPES = [
        ('suspicious_activity', 'Suspicious Activity'),
        ('multiple_locations', 'Multiple Geographic Locations'),
        ('bulk_operations', 'Bulk Operations'),
        ('unusual_hours', 'Unusual Access Hours'),
        ('failed_permissions', 'Failed Permission Attempts'),
        ('rapid_changes', 'Rapid Data Changes'),
        ('deletion_attempts', 'Deletion Attempts'),
    ]
    
    SEVERITY_LEVELS = [
        ('low', 'Low'),
        ('medium', 'Medium'),
        ('high', 'High'),
        ('critical', 'Critical'),
    ]
    
    alert_type = models.CharField(max_length=30, choices=ALERT_TYPES)
    severity = models.CharField(max_length=10, choices=SEVERITY_LEVELS)
    title = models.CharField(max_length=200)
    description = models.TextField()
    
    # Related objects
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    
    # Alert status
    is_acknowledged = models.BooleanField(default=False)
    acknowledged_by = models.ForeignKey(
        User, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='acknowledged_alerts'
    )
    acknowledged_at = models.DateTimeField(null=True, blank=True)
    
    # Additional data
    metadata = models.JSONField(default=dict)  # Store additional context
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'core_security_alert'
        indexes = [
            models.Index(fields=['alert_type', 'created_at']),
            models.Index(fields=['severity', 'is_acknowledged']),
            models.Index(fields=['user', 'created_at']),
        ]
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.get_severity_display()}: {self.title}"
    
    def acknowledge(self, acknowledged_by):
        """Acknowledge this alert."""
        self.is_acknowledged = True
        self.acknowledged_by = acknowledged_by
        self.acknowledged_at = timezone.now()
        self.save()

class DashboardMetric(models.Model):
    """Store dashboard metrics for performance."""
    
    METRIC_TYPES = [
        ('daily_logins', 'Daily Logins'),
        ('patient_modifications', 'Patient Modifications'),
        ('failed_logins', 'Failed Logins'),
        ('geographic_access', 'Geographic Access'),
        ('deletion_attempts', 'Deletion Attempts'),
        ('bulk_operations', 'Bulk Operations'),
    ]
    
    metric_type = models.CharField(max_length=30, choices=METRIC_TYPES)
    date = models.DateField()
    value = models.IntegerField()
    metadata = models.JSONField(default=dict)
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'core_dashboard_metric'
        unique_together = ['metric_type', 'date']
        indexes = [
            models.Index(fields=['metric_type', 'date']),
        ]
    
    def __str__(self):
        return f"{self.get_metric_type_display()}: {self.value} ({self.date})"
```

#### 1.2: Alert Generation System

```python
# apps/core/monitoring/alert_generator.py
from django.utils import timezone
from datetime import timedelta, datetime
from collections import defaultdict
from apps.core.models.monitoring import SecurityAlert
from apps.core.models.session_tracking import UserAction, UserSession
from django.contrib.auth import get_user_model

User = get_user_model()

class SecurityAlertGenerator:
    """Generate security alerts based on activity patterns."""
    
    def __init__(self):
        self.alerts_created = []
    
    def generate_alerts(self, hours_back=24):
        """Generate alerts for suspicious activity in the last N hours."""
        cutoff_time = timezone.now() - timedelta(hours=hours_back)
        
        # Check different alert types
        self._check_multiple_locations(cutoff_time)
        self._check_bulk_operations(cutoff_time) 
        self._check_unusual_hours(cutoff_time)
        self._check_rapid_changes(cutoff_time)
        self._check_deletion_attempts(cutoff_time)
        
        return self.alerts_created
    
    def _check_multiple_locations(self, cutoff_time):
        """Check for users accessing from multiple countries."""
        user_countries = defaultdict(set)
        
        for action in UserAction.objects.filter(
            created_at__gte=cutoff_time,
            country__isnull=False
        ).exclude(country=''):
            user_countries[action.user.id].add(action.country)
        
        for user_id, countries in user_countries.items():
            if len(countries) > 2:  # More than 2 countries
                user = User.objects.get(id=user_id)
                
                # Check if we already have a recent alert for this user
                recent_alert = SecurityAlert.objects.filter(
                    user=user,
                    alert_type='multiple_locations',
                    created_at__gte=timezone.now() - timedelta(hours=6)
                ).exists()
                
                if not recent_alert:
                    alert = SecurityAlert.objects.create(
                        alert_type='multiple_locations',
                        severity='medium',
                        title=f'User {user.username} accessing from multiple countries',
                        description=f'User has accessed system from {len(countries)} different countries: {", ".join(countries)}',
                        user=user,
                        metadata={
                            'countries': list(countries),
                            'country_count': len(countries)
                        }
                    )
                    self.alerts_created.append(alert)
    
    def _check_bulk_operations(self, cutoff_time):
        """Check for bulk operations by single users."""
        user_actions = defaultdict(int)
        
        for action in UserAction.objects.filter(
            created_at__gte=cutoff_time,
            action_type__in=['patient_create', 'patient_update', 'patient_delete']
        ):
            user_actions[action.user.id] += 1
        
        for user_id, count in user_actions.items():
            if count > 20:  # More than 20 patient operations
                user = User.objects.get(id=user_id)
                
                recent_alert = SecurityAlert.objects.filter(
                    user=user,
                    alert_type='bulk_operations',
                    created_at__gte=timezone.now() - timedelta(hours=6)
                ).exists()
                
                if not recent_alert:
                    alert = SecurityAlert.objects.create(
                        alert_type='bulk_operations',
                        severity='high',
                        title=f'User {user.username} performed {count} operations',
                        description=f'User performed {count} patient operations in the last 24 hours',
                        user=user,
                        metadata={
                            'operation_count': count,
                            'time_period': '24h'
                        }
                    )
                    self.alerts_created.append(alert)
    
    def _check_unusual_hours(self, cutoff_time):
        """Check for access during unusual hours (e.g., midnight to 5 AM)."""
        unusual_actions = UserAction.objects.filter(
            created_at__gte=cutoff_time,
            created_at__time__range=('00:00', '05:00')
        ).select_related('user')
        
        user_night_actions = defaultdict(int)
        for action in unusual_actions:
            user_night_actions[action.user.id] += 1
        
        for user_id, count in user_night_actions.items():
            if count > 5:  # More than 5 actions during night hours
                user = User.objects.get(id=user_id)
                
                recent_alert = SecurityAlert.objects.filter(
                    user=user,
                    alert_type='unusual_hours',
                    created_at__gte=timezone.now() - timedelta(hours=12)
                ).exists()
                
                if not recent_alert:
                    alert = SecurityAlert.objects.create(
                        alert_type='unusual_hours',
                        severity='medium',
                        title=f'User {user.username} active during unusual hours',
                        description=f'User performed {count} actions between midnight and 5 AM',
                        user=user,
                        metadata={
                            'night_action_count': count,
                            'time_range': '00:00-05:00'
                        }
                    )
                    self.alerts_created.append(alert)
    
    def _check_rapid_changes(self, cutoff_time):
        """Check for rapid successive changes to same patient."""
        from apps.patients.models import Patient
        
        # Group actions by patient
        patient_actions = defaultdict(list)
        
        for action in UserAction.objects.filter(
            created_at__gte=cutoff_time,
            target_model='Patient',
            action_type='patient_update'
        ).order_by('created_at'):
            patient_actions[action.target_id].append(action)
        
        for patient_id, actions in patient_actions.items():
            if len(actions) > 10:  # More than 10 updates to same patient
                # Check if updates are rapid (within 1 hour)
                first_action = actions[0]
                last_action = actions[-1]
                time_diff = last_action.created_at - first_action.created_at
                
                if time_diff < timedelta(hours=1) and len(actions) > 5:
                    user = actions[-1].user  # Most recent user
                    
                    try:
                        patient = Patient.objects.get(id=patient_id)
                        patient_name = patient.name
                    except Patient.DoesNotExist:
                        patient_name = f"Patient {patient_id[:8]}..."
                    
                    recent_alert = SecurityAlert.objects.filter(
                        user=user,
                        alert_type='rapid_changes',
                        metadata__patient_id=patient_id,
                        created_at__gte=timezone.now() - timedelta(hours=2)
                    ).exists()
                    
                    if not recent_alert:
                        alert = SecurityAlert.objects.create(
                            alert_type='rapid_changes',
                            severity='medium',
                            title=f'Rapid changes to patient {patient_name}',
                            description=f'{len(actions)} updates to patient within {time_diff}',
                            user=user,
                            metadata={
                                'patient_id': patient_id,
                                'patient_name': patient_name,
                                'update_count': len(actions),
                                'time_span_minutes': int(time_diff.total_seconds() / 60)
                            }
                        )
                        self.alerts_created.append(alert)
    
    def _check_deletion_attempts(self, cutoff_time):
        """Check for deletion attempts."""
        deletion_actions = UserAction.objects.filter(
            created_at__gte=cutoff_time,
            action_type__in=['patient_delete', 'event_delete']
        ).select_related('user')
        
        user_deletions = defaultdict(int)
        for action in deletion_actions:
            user_deletions[action.user.id] += 1
        
        for user_id, count in user_deletions.items():
            if count > 3:  # More than 3 deletions
                user = User.objects.get(id=user_id)
                
                recent_alert = SecurityAlert.objects.filter(
                    user=user,
                    alert_type='deletion_attempts',
                    created_at__gte=timezone.now() - timedelta(hours=6)
                ).exists()
                
                if not recent_alert:
                    alert = SecurityAlert.objects.create(
                        alert_type='deletion_attempts',
                        severity='high',
                        title=f'Multiple deletions by {user.username}',
                        description=f'User attempted {count} deletions in the last 24 hours',
                        user=user,
                        metadata={
                            'deletion_count': count,
                        }
                    )
                    self.alerts_created.append(alert)
```

### Step 2: Dashboard Views

#### 2.1: Dashboard Main View

```python
# apps/core/views/monitoring.py
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import TemplateView
from django.http import JsonResponse
from django.utils import timezone
from datetime import timedelta, datetime
from collections import defaultdict
from apps.core.models.monitoring import SecurityAlert, DashboardMetric
from apps.core.models.session_tracking import UserAction, UserSession
from apps.core.monitoring.alert_generator import SecurityAlertGenerator

class SecurityDashboardView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Main security monitoring dashboard."""
    template_name = 'core/security_dashboard.html'
    
    def test_func(self):
        """Only superusers can access security dashboard."""
        return self.request.user.is_superuser
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Get recent alerts
        context['recent_alerts'] = SecurityAlert.objects.filter(
            is_acknowledged=False
        )[:10]
        
        # Get basic stats
        context['stats'] = self._get_dashboard_stats()
        
        # Get recent activity
        context['recent_activity'] = UserAction.objects.select_related(
            'user'
        )[:20]
        
        return context
    
    def _get_dashboard_stats(self):
        """Get dashboard statistics."""
        now = timezone.now()
        last_24h = now - timedelta(hours=24)
        last_7d = now - timedelta(days=7)
        
        return {
            'total_users': UserSession.objects.filter(
                created_at__gte=last_24h
            ).values('user').distinct().count(),
            
            'total_actions': UserAction.objects.filter(
                created_at__gte=last_24h
            ).count(),
            
            'suspicious_sessions': UserSession.objects.filter(
                is_suspicious=True,
                created_at__gte=last_7d
            ).count(),
            
            'unacknowledged_alerts': SecurityAlert.objects.filter(
                is_acknowledged=False
            ).count(),
            
            'countries_accessed': UserAction.objects.filter(
                created_at__gte=last_24h,
                country__isnull=False
            ).exclude(country='').values('country').distinct().count(),
            
            'deletion_attempts': UserAction.objects.filter(
                created_at__gte=last_24h,
                action_type__in=['patient_delete', 'event_delete']
            ).count(),
        }

class DashboardDataView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """AJAX endpoint for dashboard data."""
    
    def test_func(self):
        return self.request.user.is_superuser
    
    def get(self, request, *args, **kwargs):
        data_type = request.GET.get('type', 'activity')
        
        if data_type == 'activity':
            return self._get_activity_data()
        elif data_type == 'geographic':
            return self._get_geographic_data()
        elif data_type == 'alerts':
            return self._get_alerts_data()
        elif data_type == 'trends':
            return self._get_trends_data()
        
        return JsonResponse({'error': 'Invalid data type'})
    
    def _get_activity_data(self):
        """Get recent activity data."""
        last_24h = timezone.now() - timedelta(hours=24)
        
        activities = UserAction.objects.filter(
            created_at__gte=last_24h
        ).select_related('user').order_by('-created_at')[:50]
        
        data = []
        for activity in activities:
            data.append({
                'id': activity.id,
                'user': activity.user.username,
                'action': activity.get_action_type_display(),
                'target': activity.target_name or activity.target_model,
                'ip_address': activity.ip_address,
                'country': activity.country,
                'city': activity.city,
                'timestamp': activity.created_at.isoformat(),
                'success': activity.success,
                'is_suspicious': activity.is_suspicious,
            })
        
        return JsonResponse({'activities': data})
    
    def _get_geographic_data(self):
        """Get geographic access data."""
        last_7d = timezone.now() - timedelta(days=7)
        
        country_data = defaultdict(int)
        city_data = defaultdict(int)
        
        for action in UserAction.objects.filter(
            created_at__gte=last_7d,
            country__isnull=False
        ).exclude(country=''):
            country_data[action.country] += 1
            if action.city:
                city_data[f"{action.city}, {action.country}"] += 1
        
        return JsonResponse({
            'countries': dict(country_data),
            'cities': dict(city_data),
        })
    
    def _get_alerts_data(self):
        """Get alerts data."""
        alerts = SecurityAlert.objects.all()[:20]
        
        data = []
        for alert in alerts:
            data.append({
                'id': alert.id,
                'type': alert.get_alert_type_display(),
                'severity': alert.severity,
                'title': alert.title,
                'description': alert.description,
                'user': alert.user.username if alert.user else None,
                'ip_address': alert.ip_address,
                'is_acknowledged': alert.is_acknowledged,
                'created_at': alert.created_at.isoformat(),
            })
        
        return JsonResponse({'alerts': data})
    
    def _get_trends_data(self):
        """Get trend data for charts."""
        last_30d = timezone.now() - timedelta(days=30)
        
        # Daily activity counts
        daily_activity = defaultdict(int)
        
        for action in UserAction.objects.filter(created_at__gte=last_30d):
            date_str = action.created_at.date().isoformat()
            daily_activity[date_str] += 1
        
        # Convert to chart format
        dates = []
        counts = []
        for i in range(30):
            date = (timezone.now() - timedelta(days=29-i)).date()
            date_str = date.isoformat()
            dates.append(date_str)
            counts.append(daily_activity[date_str])
        
        return JsonResponse({
            'dates': dates,
            'activity_counts': counts,
        })

class AlertAcknowledgeView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Acknowledge security alerts."""
    
    def test_func(self):
        return self.request.user.is_superuser
    
    def post(self, request, alert_id):
        try:
            alert = SecurityAlert.objects.get(id=alert_id)
            alert.acknowledge(acknowledged_by=request.user)
            
            return JsonResponse({
                'success': True,
                'message': 'Alert acknowledged successfully'
            })
            
        except SecurityAlert.DoesNotExist:
            return JsonResponse({
                'success': False,
                'error': 'Alert not found'
            })

class GenerateAlertsView(LoginRequiredMixin, UserPassesTestMixin, TemplateView):
    """Manually trigger alert generation."""
    
    def test_func(self):
        return self.request.user.is_superuser
    
    def post(self, request):
        hours_back = int(request.POST.get('hours_back', 24))
        
        generator = SecurityAlertGenerator()
        alerts = generator.generate_alerts(hours_back=hours_back)
        
        return JsonResponse({
            'success': True,
            'alerts_generated': len(alerts),
            'message': f'Generated {len(alerts)} new alerts'
        })
```

### Step 3: Dashboard Templates

#### 3.1: Main Dashboard Template

```django
<!-- apps/core/templates/core/security_dashboard.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Security Dashboard{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/chart.js/chart.min.css' %}" rel="stylesheet">
<link href="{% static 'css/security-dashboard.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-shield-alt"></i> Security Dashboard
            </h1>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Active Users (24h)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.total_users }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Actions (24h)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.total_actions }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Suspicious Sessions
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.suspicious_sessions }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Unack. Alerts
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.unacknowledged_alerts }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Countries (24h)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.countries_accessed }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-globe fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-dark shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                                Deletions (24h)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.deletion_attempts }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-trash fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts and Alerts Row -->
    <div class="row">
        <!-- Activity Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Activity Trends (30 Days)</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshChart()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Alerts -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Alerts</h6>
                    <button class="btn btn-sm btn-outline-success" onclick="generateAlerts()">
                        <i class="fas fa-plus"></i> Generate
                    </button>
                </div>
                <div class="card-body">
                    <div id="alerts-container" style="max-height: 300px; overflow-y: auto;">
                        {% for alert in recent_alerts %}
                        <div class="alert alert-{{ alert.severity }} alert-dismissible fade show" role="alert">
                            <strong>{{ alert.get_alert_type_display }}</strong><br>
                            {{ alert.title }}<br>
                            <small class="text-muted">{{ alert.created_at|timesince }} ago</small>
                            {% if not alert.is_acknowledged %}
                            <button type="button" class="btn btn-sm btn-outline-secondary float-right" 
                                    onclick="acknowledgeAlert({{ alert.id }})">
                                Acknowledge
                            </button>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-muted">No recent alerts</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Activity</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="activity-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>IP Address</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recent_activity %}
                                <tr class="{% if activity.is_suspicious %}table-warning{% endif %}">
                                    <td>{{ activity.created_at|date:"M d, H:i" }}</td>
                                    <td>{{ activity.user.username }}</td>
                                    <td>{{ activity.get_action_type_display }}</td>
                                    <td>{{ activity.target_name|default:activity.target_model }}</td>
                                    <td><code>{{ activity.ip_address }}</code></td>
                                    <td>{{ activity.city }}, {{ activity.country }}</td>
                                    <td>
                                        {% if activity.success %}
                                            <span class="badge badge-success">Success</span>
                                        {% else %}
                                            <span class="badge badge-danger">Failed</span>
                                        {% endif %}
                                        {% if activity.is_suspicious %}
                                            <span class="badge badge-warning">Suspicious</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/chart.js/chart.min.js' %}"></script>
<script src="{% static 'js/security-dashboard.js' %}"></script>
<script>
// Initialize dashboard
$(document).ready(function() {
    SecurityDashboard.init();
});
</script>
{% endblock %}
```

#### 3.2: Dashboard JavaScript

```javascript
// static/js/security-dashboard.js
const SecurityDashboard = {
    chart: null,
    
    init: function() {
        this.initChart();
        this.setupAutoRefresh();
    },
    
    initChart: function() {
        const ctx = document.getElementById('activityChart').getContext('2d');
        
        // Load chart data
        fetch('/dashboard/data/?type=trends')
            .then(response => response.json())
            .then(data => {
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Daily Activity',
                            data: data.activity_counts,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
    },
    
    setupAutoRefresh: function() {
        // Refresh dashboard data every 30 seconds
        setInterval(() => {
            this.refreshActivity();
        }, 30000);
    },
    
    refreshActivity: function() {
        fetch('/dashboard/data/?type=activity')
            .then(response => response.json())
            .then(data => {
                this.updateActivityTable(data.activities);
            });
    },
    
    updateActivityTable: function(activities) {
        const tbody = document.querySelector('#activity-table tbody');
        tbody.innerHTML = '';
        
        activities.forEach(activity => {
            const row = document.createElement('tr');
            if (activity.is_suspicious) {
                row.classList.add('table-warning');
            }
            
            row.innerHTML = `
                <td>${new Date(activity.timestamp).toLocaleString()}</td>
                <td>${activity.user}</td>
                <td>${activity.action}</td>
                <td>${activity.target || activity.target_model || '-'}</td>
                <td><code>${activity.ip_address}</code></td>
                <td>${activity.city}, ${activity.country}</td>
                <td>
                    ${activity.success ? 
                        '<span class="badge badge-success">Success</span>' :
                        '<span class="badge badge-danger">Failed</span>'
                    }
                    ${activity.is_suspicious ? 
                        '<span class="badge badge-warning">Suspicious</span>' : ''
                    }
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
};

function refreshChart() {
    SecurityDashboard.initChart();
}

function acknowledgeAlert(alertId) {
    fetch(`/dashboard/alert/${alertId}/acknowledge/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error acknowledging alert: ' + data.error);
        }
    });
}

function generateAlerts() {
    fetch('/dashboard/generate-alerts/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new FormData(document.createElement('form'))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Generated ${data.alerts_generated} new alerts`);
            location.reload();
        } else {
            alert('Error generating alerts');
        }
    });
}
```

### Step 4: Automated Alert Generation

#### 4.1: Management Command

```python
# apps/core/management/commands/generate_security_alerts.py
from django.core.management.base import BaseCommand
from apps.core.monitoring.alert_generator import SecurityAlertGenerator

class Command(BaseCommand):
    help = 'Generate security alerts based on recent activity'
    
    def add_arguments(self, parser):
        parser.add_argument(
            '--hours',
            type=int,
            default=1,
            help='Check activity from last N hours'
        )
    
    def handle(self, *args, **options):
        generator = SecurityAlertGenerator()
        alerts = generator.generate_alerts(hours_back=options['hours'])
        
        self.stdout.write(
            self.style.SUCCESS(
                f'Generated {len(alerts)} security alerts'
            )
        )
        
        for alert in alerts:
            self.stdout.write(
                f"  {alert.get_severity_display()}: {alert.title}"
            )
```

#### 4.2: Cron Job Setup

```bash
# Add to crontab for automated alert generation
# Run every hour
0 * * * * cd /path/to/eqmd && uv run python manage.py generate_security_alerts --hours=1

# Run comprehensive check every 4 hours
0 */4 * * * cd /path/to/eqmd && uv run python manage.py generate_security_alerts --hours=4
```

### Step 5: URL Configuration

```python
# apps/core/urls.py
from django.urls import path
from apps.core.views.monitoring import (
    SecurityDashboardView, DashboardDataView, 
    AlertAcknowledgeView, GenerateAlertsView
)

app_name = 'core'

urlpatterns = [
    # ... existing URLs ...
    
    # Security Dashboard
    path('dashboard/', SecurityDashboardView.as_view(), name='security_dashboard'),
    path('dashboard/data/', DashboardDataView.as_view(), name='dashboard_data'),
    path('dashboard/alert/<int:alert_id>/acknowledge/', 
         AlertAcknowledgeView.as_view(), name='acknowledge_alert'),
    path('dashboard/generate-alerts/', 
         GenerateAlertsView.as_view(), name='generate_alerts'),
]
```

## Implementation Checklist

### Development Phase
- [ ] Create monitoring models (SecurityAlert, DashboardMetric)
- [ ] Implement alert generation system
- [ ] Create dashboard views and JSON endpoints
- [ ] Build dashboard template with charts
- [ ] Add JavaScript for real-time updates
- [ ] Create admin interfaces for alerts
- [ ] Implement automated alert generation
- [ ] Write comprehensive tests

### Configuration Phase  
- [ ] Add Chart.js dependencies
- [ ] Configure dashboard permissions  
- [ ] Set up cron jobs for automated alerts
- [ ] Configure dashboard refresh intervals
- [ ] Set up alert notification preferences

### Testing Phase
- [ ] Test alert generation logic
- [ ] Test dashboard data endpoints
- [ ] Test real-time dashboard updates
- [ ] Test alert acknowledgment system
- [ ] Verify permission restrictions
- [ ] Performance test with large datasets

### Deployment Phase
- [ ] Deploy dashboard to staging
- [ ] Verify dashboard functionality in staging
- [ ] Set up production cron jobs
- [ ] Train administrators on dashboard usage
- [ ] Deploy to production
- [ ] Monitor dashboard performance

## Expected Benefits

### Proactive Security
- **Real-time visibility** into system activity
- **Pattern detection** for suspicious behavior
- **Early warning system** for potential attacks
- **Automated alerting** for critical events

### Investigation Support
- **Comprehensive activity logs** with IP/location data
- **Visual patterns** easier to identify than raw logs  
- **Quick filtering and search** capabilities
- **Evidence collection** for incident response

### Operational Efficiency
- **Centralized monitoring** instead of log analysis
- **Automated alert generation** reduces manual monitoring
- **Visual dashboards** for non-technical stakeholders
- **Historical trend analysis** for capacity planning

## Success Metrics

- [ ] Dashboard loads under 3 seconds with 30 days of data
- [ ] Real-time updates work reliably
- [ ] Alert generation catches 95%+ of suspicious patterns  
- [ ] False positive rate under 10%
- [ ] Admin users can effectively investigate incidents
- [ ] Dashboard provides actionable security insights

This dashboard provides the visibility and investigation tools needed to detect and respond to the type of database abuse you experienced, with real-time monitoring and automated alerting capabilities.