# Multi-Instance Deployment Implementation Plan

**Objective**: Enable multiple EquipeMed deployments on the same machine without conflicts.

**Date**: 2025-01-24  
**Status**: Planning Phase

## Overview

This plan implements Option 3 (Container Prefix approach) to resolve conflicts in:

- Host machine port mapping (currently hardcoded to 8778)
- Docker volume names (currently generic names cause conflicts)
- Nginx static folder names (currently image-based only)

## Current State Analysis

### Existing Conflicts

1. **Port Mapping**: `docker-compose.yml:12` → `"8778:8000"` (hardcoded)
2. **Volume Names**: `docker-compose.yml:16-18` → `media_files`, `database`, `static_files`
3. **Container Names**: Default Docker Compose naming creates conflicts
4. **Health Checks**: Scripts reference hardcoded port 8778
5. **Static Folders**: Image-based naming may not be unique enough

### What Works Well

- ✅ Static files path already uses `INSTANCE_ID` based on image name
- ✅ User UID/GID configurable via `EQMD_UID`/`EQMD_GID`
- ✅ Image selection configurable via `EQMD_IMAGE`

## Implementation Plan

### Phase 1: Docker Compose Configuration

#### 1.1 Update docker-compose.yml

**Changes needed:**

```yaml
services:
  eqmd:
    container_name: ${CONTAINER_PREFIX:-eqmd}_app
    image: ${EQMD_IMAGE:-eqmd:latest}
    ports:
      - "${HOST_PORT:-8778}:8000"
    volumes:
      - ${CONTAINER_PREFIX:-eqmd}_media_files:/app/media
      - ${CONTAINER_PREFIX:-eqmd}_database:/app/database
      - ${CONTAINER_PREFIX:-eqmd}_static_files:/app/staticfiles

  static-init:
    container_name: ${CONTAINER_PREFIX:-eqmd}_static_init
    volumes:
      - ${CONTAINER_PREFIX:-eqmd}_static_files:/shared/static

  eqmd-dev:
    container_name: ${CONTAINER_PREFIX:-eqmd}_dev
    ports:
      - "${DEV_PORT:-8779}:8000"

volumes:
  ${CONTAINER_PREFIX:-eqmd}_database:
    name: ${CONTAINER_PREFIX:-eqmd}_database
  ${CONTAINER_PREFIX:-eqmd}_media_files:
    name: ${CONTAINER_PREFIX:-eqmd}_media_files
  ${CONTAINER_PREFIX:-eqmd}_static_files:
    name: ${CONTAINER_PREFIX:-eqmd}_static_files
```

**Files to modify:**

- `docker-compose.yml`

### Phase 2: Environment Configuration

#### 2.1 Update .env.example

**Add new variables:**

```bash
# Multi-deployment configuration
CONTAINER_PREFIX=eqmd
HOST_PORT=8778
DEV_PORT=8779

# Derived automatically (do not set manually)
# INSTANCE_SUFFIX=${CONTAINER_PREFIX}_${SANITIZED_IMAGE_NAME}
```

**Files to modify:**

- `.env.example`

#### 2.2 Enhanced Static Files Path Generation

**New logic for install-minimal.sh:**

```bash
# Multi-deployment configuration
CONTAINER_PREFIX=${CONTAINER_PREFIX:-eqmd}
INSTANCE_ID="${EQMD_IMAGE//[^a-zA-Z0-9]/_}"
STATIC_FILES_PATH="/var/www/${CONTAINER_PREFIX}_static_${INSTANCE_ID}"
```

**Files to modify:**

- `install-minimal.sh`
- `upgrade.sh`

### Phase 3: Installation Script Updates

#### 3.1 Enhanced Environment Prompting

**Add prompts in install-minimal.sh:**

```bash
# Multi-deployment configuration prompts
print_prompt "Enter container prefix (default: eqmd): "
read -r CONTAINER_PREFIX
CONTAINER_PREFIX=${CONTAINER_PREFIX:-eqmd}

print_prompt "Enter host port (default: 8778): "
read -r HOST_PORT
HOST_PORT=${HOST_PORT:-8778}

# Validate port is not in use
if netstat -ln | grep -q ":$HOST_PORT "; then
    print_error "Port $HOST_PORT is already in use"
    print_info "Please choose a different port"
    exit 1
fi
```

#### 3.2 Update .env Generation

**Enhanced .env creation:**

```bash
cat >.env <<EOF
# Generated by install-minimal.sh
DEBUG=False
SECRET_KEY=$SECRET_KEY
ALLOWED_HOSTS=$DOMAIN_NAME,www.$DOMAIN_NAME,localhost,127.0.0.1

# Multi-deployment configuration
CONTAINER_PREFIX=$CONTAINER_PREFIX
HOST_PORT=$HOST_PORT
DEV_PORT=$((HOST_PORT + 1))

# Registry configuration
REGISTRY=$REGISTRY
EQMD_IMAGE=$REGISTRY/$IMAGE_NAME:latest

# User configuration
EQMD_UID=$EQMD_UID
EQMD_GID=$EQMD_GID

# Hospital configuration
HOSPITAL_NAME=$HOSPITAL_NAME
HOSPITAL_ADDRESS=Update this address
HOSPITAL_PHONE=Update this phone
HOSPITAL_EMAIL=Update this email
HOSPITAL_PDF_FORMS_ENABLED=true

# Email (update for production)
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
EOF
```

#### 3.3 Dynamic Health Check URLs

**Replace hardcoded URLs:**

```bash
# Before
curl -f -s http://localhost:8778/health/

# After
curl -f -s http://localhost:$HOST_PORT/health/
```

**Files to modify:**

- `install-minimal.sh`
- `upgrade.sh`

### Phase 4: Documentation Updates

#### 4.1 Docker Production Deployment Guide

**Add multi-deployment section:**

````markdown
## Multi-Deployment Configuration

For multiple hospitals on the same server:

### Hospital A (Port 8778):

```bash
# In .env file
CONTAINER_PREFIX=hospital_a
HOST_PORT=8778
EQMD_IMAGE=ghcr.io/org/eqmd:hospital-a
```
````

### Hospital B (Port 8779)

```bash
# In .env file
CONTAINER_PREFIX=hospital_b
HOST_PORT=8779
EQMD_IMAGE=ghcr.io/org/eqmd:hospital-b
```

### Results

- **Volumes**: `hospital_a_database`, `hospital_b_database`, etc.
- **Static Files**: `/var/www/hospital_a_static_*`, `/var/www/hospital_b_static_*`
- **Containers**: `hospital_a_app`, `hospital_b_app`
- **Ports**: `8778`, `8779`

````

#### 4.2 Nginx Configuration Updates

**Update nginx.conf.example comments:**

```nginx
# Multi-deployment friendly configuration
# Static files path format: /var/www/{CONTAINER_PREFIX}_static_{INSTANCE_ID}/
# Examples:
#   Hospital A: /var/www/hospital_a_static_ghcr_io_org_eqmd_latest/
#   Hospital B: /var/www/hospital_b_static_ghcr_io_org_eqmd_latest/
````

**Files to modify:**

- `docs/deployment/docker-production-deployment.md`
- `nginx.conf.example`

### Phase 5: Testing and Validation

#### 5.1 Test Scenarios

**Scenario 1: Same Image, Different Ports**

```bash
# Hospital A
CONTAINER_PREFIX=hospital_a HOST_PORT=8778 ./install-minimal.sh

# Hospital B
CONTAINER_PREFIX=hospital_b HOST_PORT=8779 ./install-minimal.sh
```

**Expected Results:**

- Different container names: `hospital_a_app` vs `hospital_b_app`
- Different volumes: `hospital_a_database` vs `hospital_b_database`
- Different static paths: `/var/www/hospital_a_static_*` vs `/var/www/hospital_b_static_*`
- Different ports: `8778` vs `8779`

**Scenario 2: Different Images, Same Prefix Pattern**

```bash
# Version 1
CONTAINER_PREFIX=eqmd_v1 EQMD_IMAGE=ghcr.io/org/eqmd:v1.0 ./install-minimal.sh

# Version 2
CONTAINER_PREFIX=eqmd_v2 EQMD_IMAGE=ghcr.io/org/eqmd:v2.0 ./install-minimal.sh
```

#### 5.2 Conflict Detection

**Port conflict checking:**

```bash
# Check if port is available before installation
netstat -ln | grep ":$HOST_PORT " && echo "Port conflict detected"
```

**Volume conflict checking:**

```bash
# Check if volumes already exist
docker volume ls | grep "${CONTAINER_PREFIX}_" && echo "Volume prefix conflict"
```

**Static folder conflict checking:**

```bash
# Check if static folder exists
[ -d "/var/www/${CONTAINER_PREFIX}_static_*" ] && echo "Static folder conflict"
```

### Phase 6: Migration Strategy

#### 6.1 Existing Deployment Migration

**For existing single deployments:**

1. **Backup current deployment:**

   ```bash
   docker compose down
   docker volume ls  # Note current volume names
   ```

2. **Add multi-deployment variables to .env:**

   ```bash
   echo "CONTAINER_PREFIX=eqmd" >> .env
   echo "HOST_PORT=8778" >> .env
   ```

3. **Rename existing volumes (optional):**

   ```bash
   docker volume create eqmd_database
   docker volume create eqmd_media_files
   docker volume create eqmd_static_files

   # Copy data from old volumes if needed
   ```

4. **Deploy with new configuration:**

   ```bash
   docker compose up -d
   ```

#### 6.2 Backwards Compatibility

**Default values ensure backwards compatibility:**

- `CONTAINER_PREFIX=eqmd` (matches current behavior)
- `HOST_PORT=8778` (matches current behavior)
- Volume names default to current names with prefix

### Phase 7: Implementation Order

#### Step 1: Core Configuration (30 min)

1. Update `docker-compose.yml` with variables
2. Update `.env.example` with new variables
3. Test with default values (should be identical to current behavior)

#### Step 2: Installation Scripts (45 min)

1. Update `install-minimal.sh` prompting and path generation
2. Update `upgrade.sh` with dynamic ports and paths
3. Test single deployment with default values

#### Step 3: Multi-Deployment Testing (60 min)

1. Test two deployments on different ports
2. Verify volume separation
3. Verify static files separation
4. Test nginx configuration with multiple instances

#### Step 4: Documentation (30 min)

1. Update deployment documentation
2. Update nginx configuration examples
3. Create multi-deployment examples

#### Step 5: Validation (30 min)

1. Run conflict detection tests
2. Verify backwards compatibility
3. Test upgrade scenarios

## Success Criteria

### ✅ Technical Requirements

- [ ] Multiple deployments can run on same machine
- [ ] Each deployment uses unique ports
- [ ] Each deployment uses unique Docker volumes
- [ ] Each deployment uses unique nginx static folders
- [ ] No naming conflicts in containers, volumes, or folders
- [ ] Backwards compatibility maintained for existing deployments

### ✅ User Experience Requirements

- [ ] Installation script prompts for multi-deployment configuration
- [ ] Clear documentation for multi-deployment scenarios
- [ ] Error detection for port/volume conflicts
- [ ] Easy migration path for existing deployments

### ✅ Operational Requirements

- [ ] Each deployment can be updated independently
- [ ] Each deployment can be stopped/started independently
- [ ] Health checks work for all deployments
- [ ] Backup/restore works for each deployment individually

## Example Usage Scenarios

### Scenario A: Hospital with Staging Environment

```bash
# Production
CONTAINER_PREFIX=prod HOST_PORT=8778 EQMD_IMAGE=ghcr.io/hospital/eqmd:stable

# Staging
CONTAINER_PREFIX=staging HOST_PORT=8779 EQMD_IMAGE=ghcr.io/hospital/eqmd:beta
```

### Scenario B: Multi-Hospital Server

```bash
# Hospital A
CONTAINER_PREFIX=hospital_a HOST_PORT=8778 EQMD_IMAGE=ghcr.io/org/eqmd:latest

# Hospital B
CONTAINER_PREFIX=hospital_b HOST_PORT=8780 EQMD_IMAGE=ghcr.io/org/eqmd:latest

# Hospital C
CONTAINER_PREFIX=hospital_c HOST_PORT=8782 EQMD_IMAGE=ghcr.io/org/eqmd:latest
```

### Scenario C: Version Testing

```bash
# Current version
CONTAINER_PREFIX=current HOST_PORT=8778 EQMD_IMAGE=ghcr.io/org/eqmd:v2.1

# Test version
CONTAINER_PREFIX=test HOST_PORT=8779 EQMD_IMAGE=ghcr.io/org/eqmd:v3.0-rc1
```

## Risk Mitigation

### Risk 1: Port Conflicts

**Mitigation**: Automatic port availability checking in installation script

### Risk 2: Volume Data Loss During Migration

**Mitigation**: Clear backup procedures and optional volume migration scripts

### Risk 3: Nginx Configuration Complexity

**Mitigation**: Enhanced nginx.conf.example with multi-deployment examples

### Risk 4: Breaking Existing Deployments

**Mitigation**: Default values maintain exact current behavior

### Risk 5: Complex Troubleshooting

**Mitigation**: Enhanced logging with deployment prefix in all log messages

## Files to Modify

### Core Configuration

- [ ] `docker-compose.yml` - Add variable support for ports, volumes, container names
- [ ] `.env.example` - Add multi-deployment configuration variables

### Installation Scripts

- [ ] `install-minimal.sh` - Add prompting, port checking, enhanced path generation
- [ ] `upgrade.sh` - Dynamic port/path handling, enhanced static files management

### Documentation

- [ ] `docs/deployment/docker-production-deployment.md` - Multi-deployment section
- [ ] `nginx.conf.example` - Multi-deployment examples and improved comments

### New Files

- [ ] `prompts/multi-instance-deployment-plan.md` - This planning document
- [ ] `docs/deployment/multi-deployment-guide.md` - Detailed multi-deployment guide

## Timeline

**Total Estimated Time**: 3-4 hours

**Phase 1**: Configuration (30 min)  
**Phase 2**: Installation Scripts (45 min)  
**Phase 3**: Testing (60 min)  
**Phase 4**: Documentation (30 min)  
**Phase 5**: Validation (30 min)

**Dependencies**: None - all changes are additive and backwards compatible

**Review Points**: After Phase 1 (core configuration), After Phase 3 (full testing)

