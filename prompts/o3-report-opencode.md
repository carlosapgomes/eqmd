# Outpatient Prescription System – Code Analysis Report (opencode)

## Current Gaps vs. Requirements

### DrugTemplates app

1. `PrescriptionTemplate` model has no `usage_count` field.
2. `PrescriptionTemplateItem` wrongly keeps its own `created_at/updated_at` timestamps (should inherit parent).
3. CRUD/UI only implemented for `DrugTemplate`; none for `PrescriptionTemplate`.
4. Business-logic ownership questionable – template classes probably belong in OutpatientPrescriptions.

### OutpatientPrescriptions app

1. `OutpatientPrescription.copy_from_prescription_template` does not increment template usage.
2. No UI flow to duplicate a `PrescriptionTemplate` when creating a prescription; item list not editable post-copy.
3. Printable prescription document not implemented.
4. Permission checks missing to lock editing after status `finalized`.
5. Tests lack coverage for template duplication, print flow, and permission rules.

## Recommendations

1. **Relocate models** – Move `PrescriptionTemplate` & `PrescriptionTemplateItem` from DrugTemplates to OutpatientPrescriptions to align domain boundaries.
2. **Add `usage_count`** – IntegerField on `PrescriptionTemplate`; increment inside `OutpatientPrescription.copy_from_prescription_template`.
3. **Simplify timestamps** – Remove individual timestamps from `PrescriptionTemplateItem` and `PrescriptionItem`; rely on parent.
4. **Create wizard-style UI** – Steps: (a) choose template or blank, (b) edit medication formset (add/remove rows), (c) finalize prescription.
5. **Printable output** – Reuse existing Event print infrastructure to produce HTML→PDF with prescription header/footer CSS.
6. **Permissions** –
   • Only creator can edit/delete private templates.
   • Any user may use public templates.
   • When prescription status is `finalized`, disallow edits.
7. **Data migration** – Provide serializer/management command to migrate existing template records after model relocation.
8. **Test suite expansion** – Cover: duplication workflow, usage_count increments, permission enforcement, finalized read-only state, print view returns 200 & produces PDF.

---

Generated by opencode

