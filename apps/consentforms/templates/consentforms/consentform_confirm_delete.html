{% extends "base_app.html" %}
{% load static %}

{% block title %}Excluir Termo de Consentimento - {{ consentform.patient.name }}{% endblock %}

{% block extra_head %}
<style>
  .danger-zone {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 0.375rem;
    padding: 1.5rem;
  }

  .danger-icon {
    width: 64px;
    height: 64px;
    font-size: 2rem;
  }

  .patient-avatar {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }

  .consent-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    max-height: 220px;
    overflow-y: auto;
  }
</style>
{% endblock %}

{% block app_content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'apps.patients:patient_list' %}">
        <i class="bi bi-people me-1"></i>
        Pacientes
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'consentforms:consentform_detail' pk=consentform.pk %}">
        {{ consentform.patient.name }} - {{ consentform.event_datetime|date:"d/m/Y H:i" }}
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Excluir</li>
  </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">
    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
    Confirmar Exclusão
  </h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{% url 'consentforms:consentform_detail' pk=consentform.pk %}" class="btn btn-outline-secondary me-2">
      <i class="bi bi-eye me-1"></i>
      Ver Detalhes
    </a>
    <a href="{% url 'patients:patient_events_timeline' patient_id=consentform.patient.pk %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Timeline do Paciente
    </a>
  </div>
</div>

<div class="danger-zone mb-4">
  <div class="row align-items-center">
    <div class="col-auto">
      <div class="danger-icon bg-danger text-white rounded-circle d-flex align-items-center justify-content-center">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
    </div>
    <div class="col">
      <h4 class="text-danger mb-2">Atenção: Ação Irreversível</h4>
      <p class="mb-0">
        Você está prestes a excluir permanentemente este termo de consentimento.
        <strong>Esta ação não pode ser desfeita</strong> e todos os dados serão perdidos.
      </p>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">
      <i class="bi bi-file-text me-2"></i>
      Termo de Consentimento que será excluído
    </h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-muted mb-3">Informações do Paciente</h6>
        <div class="d-flex align-items-center mb-3">
          <div class="patient-avatar bg-medical-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
            {{ consentform.patient.name|first|upper }}
          </div>
          <div>
            <div class="fw-medium">{{ consentform.patient.name }}</div>
            <small class="text-muted">{{ consentform.patient.birthday|date:"d/m/Y" }}</small>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <h6 class="text-muted mb-3">Informações do Documento</h6>
        <dl class="row">
          <dt class="col-sm-5">Template:</dt>
          <dd class="col-sm-7">{{ consentform.template.name }}</dd>

          <dt class="col-sm-5">Data do Documento:</dt>
          <dd class="col-sm-7">{{ consentform.document_date|date:"d/m/Y" }}</dd>

          <dt class="col-sm-5">Criado por:</dt>
          <dd class="col-sm-7">
            {{ consentform.created_by.get_full_name|default:consentform.created_by.username }}
          </dd>

          <dt class="col-sm-5">Criado em:</dt>
          <dd class="col-sm-7">{{ consentform.created_at|date:"d/m/Y H:i" }}</dd>
        </dl>
      </div>
    </div>

    <div class="mt-3">
      <h6 class="text-muted mb-2">Descrição</h6>
      <p class="mb-3">{{ consentform.description }}</p>
    </div>

    <div class="mt-3">
      <h6 class="text-muted mb-2">Prévia do Conteúdo</h6>
      <div class="consent-preview">
        {{ consentform.rendered_markdown|linebreaks|truncatewords:50 }}
        {% if consentform.rendered_markdown|wordcount > 50 %}
        <div class="text-muted mt-2">
          <small>
            <i class="bi bi-three-dots"></i>
            Conteúdo truncado. Total: {{ consentform.rendered_markdown|wordcount }} palavras.
          </small>
        </div>
        {% endif %}
      </div>
    </div>

    {% if consentform.attachments.exists %}
    <div class="mt-3">
      <h6 class="text-muted mb-2">Anexos</h6>
      <ul class="list-unstyled mb-0">
        {% for attachment in consentform.attachments.all %}
          <li class="mb-1">
            {% if attachment.file_type == 'pdf' %}
              <i class="bi bi-file-earmark-pdf me-1 text-danger"></i>
            {% else %}
              <i class="bi bi-image me-1 text-primary"></i>
            {% endif %}
            {{ attachment.original_filename }}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-danger text-white">
    <h5 class="card-title mb-0">
      <i class="bi bi-trash me-2"></i>
      Confirmar Exclusão
    </h5>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      <div class="alert alert-warning" role="alert">
        <h6 class="alert-heading">
          <i class="bi bi-info-circle me-2"></i>
          Antes de continuar, confirme:
        </h6>
        <ul class="mb-0">
          <li>Você tem certeza de que deseja excluir este termo?</li>
          <li>Você entende que esta ação é irreversível?</li>
          <li>Você verificou se não há informações importantes que precisam ser preservadas?</li>
        </ul>
      </div>

      <div class="card border-warning bg-warning bg-opacity-10 mb-4 p-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="confirmDelete" required style="transform: scale(1.2);">
          <label class="form-check-label fs-5 fw-bold text-warning-emphasis" for="confirmDelete" style="cursor: pointer;">
            <strong>Sim, eu entendo que esta ação é irreversível e desejo excluir este termo permanentemente.</strong>
          </label>
          <div class="invalid-feedback">
            Você deve confirmar que entende as consequências desta ação.
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <button type="submit" class="btn btn-danger" id="deleteButton" disabled>
            <i class="bi bi-trash me-1"></i>
            Sim, Excluir Permanentemente
          </button>
        </div>
        <div>
          <a href="{% url 'consentforms:consentform_detail' pk=consentform.pk %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-x-circle me-1"></i>
            Cancelar
          </a>
          <a href="{% url 'consentforms:consentform_update' pk=consentform.pk %}" class="btn btn-medical-primary">
            <i class="bi bi-paperclip me-1"></i>
            Editar Anexos
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h6 class="card-title mb-0">
      <i class="bi bi-info-circle me-2"></i>
      Informações Importantes
    </h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6>O que acontece quando você exclui:</h6>
        <ul class="list-unstyled">
          <li><i class="bi bi-x-circle text-danger me-2"></i>O termo é removido permanentemente</li>
          <li><i class="bi bi-x-circle text-danger me-2"></i>Todo o conteúdo é perdido</li>
          <li><i class="bi bi-x-circle text-danger me-2"></i>Não é possível recuperar os dados</li>
          <li><i class="bi bi-x-circle text-danger me-2"></i>Os anexos são removidos junto com o termo</li>
        </ul>
      </div>
      <div class="col-md-6">
        <h6>Alternativas à exclusão:</h6>
        <ul class="list-unstyled">
          <li><i class="bi bi-paperclip text-primary me-2"></i>Atualizar anexos existentes</li>
          <li><i class="bi bi-file-text text-info me-2"></i>Gerar um novo termo</li>
          <li><i class="bi bi-archive text-warning me-2"></i>Manter o registro para referência</li>
          <li><i class="bi bi-chat-text text-success me-2"></i>Adicionar observações na timeline</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteButton = document.getElementById('deleteButton');

    confirmCheckbox.addEventListener('change', function() {
      deleteButton.disabled = !this.checked;

      if (this.checked) {
        deleteButton.classList.remove('btn-secondary');
        deleteButton.classList.add('btn-danger');
      } else {
        deleteButton.classList.remove('btn-danger');
        deleteButton.classList.add('btn-secondary');
      }
    });

    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
      if (!confirmCheckbox.checked) {
        event.preventDefault();
        event.stopPropagation();
        confirmCheckbox.classList.add('is-invalid');
      } else {
        const confirmed = confirm(
          'ÚLTIMA CONFIRMAÇÃO: Tem certeza absoluta de que deseja excluir este termo? ' +
          'Esta ação NÃO PODE ser desfeita.'
        );

        if (!confirmed) {
          event.preventDefault();
          event.stopPropagation();
        }
      }
    });
  });
</script>
{% endblock %}
