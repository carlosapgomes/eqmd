{% extends "base.html" %} {% load static %} {% block title %} {% if is_update
%}Editar Vídeo{% else %}Adicionar Vídeo{% endif %} - {{ patient.name }} {%
endblock %} {% block extra_css %}
<link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet" />
<link
  href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
  rel="stylesheet"
/>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            {% if is_update %}Editar Vídeo{% else %}Adicionar Vídeo{% endif %} -
            {{ patient.name }}
          </h5>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- FilePond Upload Area -->
            {% if not is_update %}
            <div class="mb-3">
              <label class="form-label">Arquivo de Vídeo</label>
              <input
                type="file"
                class="filepond"
                name="video"
                accept="video/*"
                data-max-file-size="100MB"
                data-max-files="1"
              />
              <div class="form-text">
                Formatos aceitos: MP4, MOV, WebM. Máximo 2 minutos, 100MB. O
                vídeo será convertido automaticamente para compatibilidade
                mobile.
              </div>
            </div>
            {% endif %}

            <!-- Form fields -->
            {{ form.as_p }}

            <div class="d-flex justify-content-between">
              <a
                href="{{ patient.get_timeline_url }}"
                class="btn btn-secondary"
              >
                <i class="bi bi-arrow-left"></i> Voltar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i>
                {% if is_update %}Atualizar{% else %}Adicionar{% endif %} Vídeo
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://unpkg.com/filepond/dist/filepond.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>

<script>
  // Register FilePond plugins
  FilePond.registerPlugin(
    FilePondPluginFileValidateType,
    FilePondPluginFileValidateSize,
  );

  // Initialize FilePond
  const inputElement = document.querySelector(".filepond");
  if (inputElement) {
    const pond = FilePond.create(inputElement, {
      server: {
        process: "/fp/process/",
        revert: "/fp/revert/",
        restore: "/fp/restore/",
        load: "/fp/load/",
        fetch: "/fp/fetch/",
      },
      acceptedFileTypes: [
        "video/mp4",
        "video/mov",
        "video/webm",
        "video/quicktime",
      ],
      maxFileSize: "100MB",
      maxFiles: 1,
      allowMultiple: false,
      labelIdle:
        'Arraste o vídeo aqui ou <span class="filepond--label-action">procure</span>',
      labelFileProcessing: "Processando...",
      labelFileProcessingComplete: "Processamento concluído",
      labelFileProcessingAborted: "Processamento cancelado",
      labelFileProcessingError: "Erro no processamento",
      labelFileWaitingForSize: "Aguardando tamanho",
      labelFileSizeNotAvailable: "Tamanho não disponível",
      onprocessfile: (error, file) => {
        if (!error) {
          // Set the upload ID in the hidden form field
          document.querySelector('input[name="upload_id"]').value =
            file.serverId;
        }
      },
    });
  }
</script>
{% endblock %}