{% load static %}

<!-- Multi-File Upload Interface -->
<div class="multi-upload-interface" data-upload-id="{{ upload_id|default:'default' }}">
    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
        <div class="upload-zone-content">
            <div class="upload-zone-icon">
                <i class="bi bi-cloud-upload display-4 text-medical-gray"></i>
            </div>
            <div class="upload-zone-text">
                <h5 class="text-medical-primary mb-2">
                    Arraste e solte suas imagens aqui
                </h5>
                <p class="text-muted mb-3">
                    ou <button type="button" class="btn btn-link p-0" id="selectFilesBtn">clique para selecionar</button>
                </p>
                <small class="text-muted">
                    {{ help_text|default:"Formatos suportados: JPG, PNG, WebP. Máximo 5MB por arquivo." }}
                </small>
            </div>
            <input type="file" 
                   id="fileInput" 
                   name="{{ field_name|default:'images' }}"
                   multiple 
                   accept="image/*"
                   class="d-none"
                   {{ field_attributes|safe }}>
        </div>
        
        <!-- Upload State Overlays -->
        <div class="upload-state-overlay upload-state-dragover d-none">
            <div class="upload-state-content">
                <i class="bi bi-plus-circle display-3 text-medical-primary"></i>
                <h5 class="text-medical-primary">Solte as imagens aqui</h5>
            </div>
        </div>
        
        <div class="upload-state-overlay upload-state-processing d-none">
            <div class="upload-state-content">
                <div class="spinner-border text-medical-primary mb-3" role="status">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <h5 class="text-medical-primary">Processando imagens...</h5>
            </div>
        </div>
    </div>
    
    <!-- Upload Queue -->
    <div class="upload-queue d-none" id="uploadQueue">
        <div class="upload-queue-header">
            <h6 class="fw-bold mb-0">
                <i class="bi bi-list-ol me-2"></i>
                Imagens Selecionadas
                <span class="badge bg-medical-primary ms-2" id="fileCount">0</span>
            </h6>
            <div class="upload-queue-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllBtn">
                    <i class="bi bi-x-circle me-1"></i>
                    Limpar Todas
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="addMoreBtn">
                    <i class="bi bi-plus-circle me-1"></i>
                    Adicionar Mais
                </button>
            </div>
        </div>
        
        <!-- File List -->
        <div class="upload-file-list" id="fileList">
            <!-- Files will be dynamically added here -->
        </div>
        
        <!-- Total Progress -->
        <div class="upload-total-progress" id="totalProgress" style="display: none;">
            <div class="progress-header">
                <span class="progress-text">Enviando arquivos...</span>
                <span class="progress-stats">
                    <span id="uploadedCount">0</span> / <span id="totalCount">0</span>
                </span>
            </div>
            <div class="progress">
                <div class="progress-bar bg-medical-primary" 
                     role="progressbar" 
                     id="totalProgressBar" 
                     style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Upload Summary -->
    <div class="upload-summary d-none" id="uploadSummary">
        <div class="alert alert-success border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-3 display-6"></i>
                <div>
                    <h6 class="alert-heading mb-1">Upload Concluído!</h6>
                    <p class="mb-0">
                        <span id="successCount">0</span> imagens foram enviadas com sucesso.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Display -->
    <div class="upload-errors d-none" id="uploadErrors">
        <div class="alert alert-danger border-0 shadow-sm">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Erros no Upload
            </h6>
            <ul class="mb-0" id="errorList">
                <!-- Errors will be listed here -->
            </ul>
        </div>
    </div>
</div>

<style>
/* Multi-Upload Interface Styling */
.multi-upload-interface {
    width: 100%;
}

/* Upload Zone */
.upload-zone {
    position: relative;
    border: 3px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 200px;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--medical-primary);
    background: rgba(var(--medical-primary-rgb), 0.05);
}

.upload-zone.dragover {
    border-style: solid;
    transform: scale(1.02);
}

.upload-zone-content {
    position: relative;
    z-index: 2;
}

.upload-zone-icon {
    margin-bottom: 1rem;
}

.upload-zone-text h5 {
    margin-bottom: 0.5rem;
}

/* Upload State Overlays */
.upload-state-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
    border-radius: 12px;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-state-content {
    text-align: center;
}

/* Upload Queue */
.upload-queue {
    margin-top: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
}

.upload-queue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.upload-queue-actions {
    display: flex;
    gap: 0.5rem;
}

/* File List */
.upload-file-list {
    max-height: 400px;
    overflow-y: auto;
}

.upload-file-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}

.upload-file-item:hover {
    background: #f8f9fa;
}

.upload-file-item:last-child {
    border-bottom: none;
}

.upload-file-preview {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #dee2e6;
    margin-right: 1rem;
    flex-shrink: 0;
}

.upload-file-info {
    flex: 1;
    min-width: 0;
}

.upload-file-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.upload-file-meta {
    font-size: 0.875rem;
    color: #6c757d;
    display: flex;
    gap: 1rem;
}

.upload-file-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: 1rem;
}

.upload-file-progress {
    width: 120px;
    margin-left: 1rem;
}

.upload-file-actions {
    display: flex;
    gap: 0.25rem;
    margin-left: 1rem;
}

/* File Status Icons */
.file-status-pending {
    color: #6c757d;
}

.file-status-uploading {
    color: var(--medical-primary);
}

.file-status-success {
    color: var(--medical-success);
}

.file-status-error {
    color: var(--medical-error);
}

/* Total Progress */
.upload-total-progress {
    padding: 1rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.progress-text {
    font-weight: 500;
}

.progress-stats {
    font-size: 0.875rem;
    color: #6c757d;
}

/* Sortable Functionality */
.upload-file-item.sortable-ghost {
    opacity: 0.3;
}

.upload-file-item.sortable-chosen {
    background: rgba(var(--medical-primary-rgb), 0.1);
}

.upload-file-item.sortable-drag {
    background: white;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: rotate(3deg);
}

.file-drag-handle {
    cursor: grab;
    padding: 0.5rem;
    color: #6c757d;
}

.file-drag-handle:active {
    cursor: grabbing;
}

/* Responsive Design */
@media (max-width: 768px) {
    .upload-zone {
        padding: 2rem 1rem;
    }
    
    .upload-queue-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
    }
    
    .upload-queue-actions {
        justify-content: center;
    }
    
    .upload-file-item {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
    
    .upload-file-preview {
        align-self: center;
        margin-right: 0;
    }
    
    .upload-file-progress,
    .upload-file-actions {
        margin-left: 0;
        justify-content: center;
    }
    
    .upload-file-meta {
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .upload-zone {
        padding: 1.5rem 1rem;
    }
    
    .upload-zone-icon {
        margin-bottom: 0.5rem;
    }
    
    .upload-zone-icon i {
        font-size: 2.5rem !important;
    }
    
    .upload-file-preview {
        width: 50px;
        height: 50px;
    }
    
    .upload-queue-actions .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    .upload-zone,
    .upload-file-item {
        transition: none;
    }
}

@media (prefers-contrast: high) {
    .upload-zone {
        border-width: 4px;
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
        border-width: 4px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .upload-zone {
        background: #212529;
        border-color: #495057;
    }
    
    .upload-queue {
        background: #212529;
        border-color: #495057;
    }
    
    .upload-queue-header,
    .upload-total-progress {
        background: #343a40;
    }
    
    .upload-file-item:hover {
        background: #343a40;
    }
}
</style>

<script>
// Multi-Upload Interface JavaScript
window.MultiUpload = (function() {
    let currentUploadId = 'default';
    let selectedFiles = [];
    let uploadProgress = {};
    let dragCounter = 0;
    
    function init(uploadId = 'default') {
        currentUploadId = uploadId;
        const container = document.querySelector(`[data-upload-id="${uploadId}"]`);
        if (!container) return;
        
        setupElements(container);
    }
    
    function setupElements(container) {
        const uploadZone = container.querySelector('#uploadZone');
        const fileInput = container.querySelector('#fileInput');
        const selectFilesBtn = container.querySelector('#selectFilesBtn');
        const uploadQueue = container.querySelector('#uploadQueue');
        const fileList = container.querySelector('#fileList');
        const clearAllBtn = container.querySelector('#clearAllBtn');
        const addMoreBtn = container.querySelector('#addMoreBtn');
        
        // File selection
        selectFilesBtn?.addEventListener('click', () => fileInput?.click());
        addMoreBtn?.addEventListener('click', () => fileInput?.click());
        fileInput?.addEventListener('change', handleFileSelect);
        
        // Drag and drop
        setupDragAndDrop(uploadZone);
        
        // Queue management
        clearAllBtn?.addEventListener('click', clearAllFiles);
        
        // Make file list sortable if SortableJS is available
        if (typeof Sortable !== 'undefined' && fileList) {
            Sortable.create(fileList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.file-drag-handle',
                onUpdate: function(evt) {
                    updateFileOrder();
                }
            });
        }
    }
    
    function setupDragAndDrop(uploadZone) {
        if (!uploadZone) return;
        
        uploadZone.addEventListener('dragenter', handleDragEnter);
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        
        // Prevent default drag behaviors on the document
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, preventDefaults, false);
        });
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function handleDragEnter(e) {
        dragCounter++;
        e.currentTarget.classList.add('dragover');
        showDragOverlay(true);
    }
    
    function handleDragOver(e) {
        e.dataTransfer.dropEffect = 'copy';
    }
    
    function handleDragLeave(e) {
        dragCounter--;
        if (dragCounter === 0) {
            e.currentTarget.classList.remove('dragover');
            showDragOverlay(false);
        }
    }
    
    function handleDrop(e) {
        dragCounter = 0;
        e.currentTarget.classList.remove('dragover');
        showDragOverlay(false);
        
        const files = Array.from(e.dataTransfer.files);
        processFiles(files);
    }
    
    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        processFiles(files);
        
        // Clear input to allow re-selecting the same files
        e.target.value = '';
    }
    
    function processFiles(files) {
        showProcessingOverlay(true);
        
        // Filter image files
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        
        if (imageFiles.length !== files.length) {
            showError('Alguns arquivos foram ignorados. Apenas imagens são aceitas.');
        }
        
        // Add to selected files
        imageFiles.forEach((file, index) => {
            const fileId = generateFileId();
            const fileData = {
                id: fileId,
                file: file,
                name: file.name,
                size: file.size,
                type: file.type,
                status: 'pending',
                progress: 0,
                preview: null,
                order: selectedFiles.length + index
            };
            
            selectedFiles.push(fileData);
            createFilePreview(fileData);
        });
        
        updateFileCount();
        showUploadQueue(true);
        showProcessingOverlay(false);
    }
    
    function createFilePreview(fileData) {
        // Create preview URL
        const reader = new FileReader();
        reader.onload = function(e) {
            fileData.preview = e.target.result;
            updateFileItem(fileData);
        };
        reader.readAsDataURL(fileData.file);
        
        // Create file item
        const fileItem = createFileItemHTML(fileData);
        const fileList = document.querySelector('#fileList');
        if (fileList) {
            fileList.appendChild(fileItem);
        }
    }
    
    function createFileItemHTML(fileData) {
        const div = document.createElement('div');
        div.className = 'upload-file-item';
        div.dataset.fileId = fileData.id;
        
        div.innerHTML = `
            <div class="file-drag-handle" title="Arrastar para reordenar">
                <i class="bi bi-grip-vertical"></i>
            </div>
            <img src="${fileData.preview || ''}" class="upload-file-preview" alt="Preview">
            <div class="upload-file-info">
                <div class="upload-file-name">${fileData.name}</div>
                <div class="upload-file-meta">
                    <span><i class="bi bi-hdd me-1"></i>${formatFileSize(fileData.size)}</span>
                    <span><i class="bi bi-file-earmark me-1"></i>${fileData.type}</span>
                </div>
            </div>
            <div class="upload-file-status">
                <i class="bi bi-clock file-status-pending" title="Aguardando"></i>
            </div>
            <div class="upload-file-progress">
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="upload-file-actions">
                <button type="button" class="btn btn-outline-danger btn-sm remove-file-btn" title="Remover">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        
        // Add event listeners
        const removeBtn = div.querySelector('.remove-file-btn');
        removeBtn.addEventListener('click', () => removeFile(fileData.id));
        
        return div;
    }
    
    function updateFileItem(fileData) {
        const fileItem = document.querySelector(`[data-file-id="${fileData.id}"]`);
        if (!fileItem) return;
        
        // Update preview
        if (fileData.preview) {
            const preview = fileItem.querySelector('.upload-file-preview');
            preview.src = fileData.preview;
        }
        
        // Update status
        const statusIcon = fileItem.querySelector('.upload-file-status i');
        const progressBar = fileItem.querySelector('.progress-bar');
        
        statusIcon.className = `bi ${getStatusIcon(fileData.status)} file-status-${fileData.status}`;
        statusIcon.title = getStatusText(fileData.status);
        progressBar.style.width = `${fileData.progress}%`;
    }
    
    function removeFile(fileId) {
        selectedFiles = selectedFiles.filter(file => file.id !== fileId);
        
        const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
        if (fileItem) {
            fileItem.remove();
        }
        
        updateFileCount();
        
        if (selectedFiles.length === 0) {
            showUploadQueue(false);
        }
    }
    
    function clearAllFiles() {
        selectedFiles = [];
        const fileList = document.querySelector('#fileList');
        if (fileList) {
            fileList.innerHTML = '';
        }
        updateFileCount();
        showUploadQueue(false);
    }
    
    function updateFileOrder() {
        const fileItems = document.querySelectorAll('.upload-file-item');
        fileItems.forEach((item, index) => {
            const fileId = item.dataset.fileId;
            const file = selectedFiles.find(f => f.id === fileId);
            if (file) {
                file.order = index;
            }
        });
        
        // Sort selectedFiles by order
        selectedFiles.sort((a, b) => a.order - b.order);
    }
    
    function updateFileCount() {
        const countBadge = document.querySelector('#fileCount');
        if (countBadge) {
            countBadge.textContent = selectedFiles.length;
        }
    }
    
    function showUploadQueue(show) {
        const uploadQueue = document.querySelector('#uploadQueue');
        if (uploadQueue) {
            uploadQueue.classList.toggle('d-none', !show);
        }
    }
    
    function showDragOverlay(show) {
        const overlay = document.querySelector('.upload-state-dragover');
        if (overlay) {
            overlay.classList.toggle('d-none', !show);
        }
    }
    
    function showProcessingOverlay(show) {
        const overlay = document.querySelector('.upload-state-processing');
        if (overlay) {
            overlay.classList.toggle('d-none', !show);
        }
    }
    
    function showError(message) {
        const errorContainer = document.querySelector('#uploadErrors');
        const errorList = document.querySelector('#errorList');
        
        if (errorContainer && errorList) {
            const li = document.createElement('li');
            li.textContent = message;
            errorList.appendChild(li);
            errorContainer.classList.remove('d-none');
        }
    }
    
    function generateFileId() {
        return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getStatusIcon(status) {
        const icons = {
            pending: 'bi-clock',
            uploading: 'bi-arrow-up-circle',
            success: 'bi-check-circle-fill',
            error: 'bi-x-circle-fill'
        };
        return icons[status] || 'bi-clock';
    }
    
    function getStatusText(status) {
        const texts = {
            pending: 'Aguardando',
            uploading: 'Enviando...',
            success: 'Enviado',
            error: 'Erro'
        };
        return texts[status] || 'Aguardando';
    }
    
    // Public API
    return {
        init: init,
        getFiles: () => selectedFiles,
        clearFiles: clearAllFiles,
        addFiles: processFiles,
        updateFileStatus: (fileId, status, progress = 0) => {
            const file = selectedFiles.find(f => f.id === fileId);
            if (file) {
                file.status = status;
                file.progress = progress;
                updateFileItem(file);
            }
        }
    };
})();

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all multi-upload interfaces
    const uploadContainers = document.querySelectorAll('.multi-upload-interface');
    uploadContainers.forEach(container => {
        const uploadId = container.dataset.uploadId || 'default';
        MultiUpload.init(uploadId);
    });
});
</script>