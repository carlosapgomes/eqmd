{% extends "events/partials/event_card_base.html" %}
{% load mediafiles_tags %}
{% load permission_tags %}

{% comment %}
VideoClip-specific event card template
Extends the base event card and adds video-specific content and actions
Parameters expected:
- event: The VideoClip event object
- event_data: Object containing event, can_edit, can_delete, excerpt
{% endcomment %}

{% block event_actions %}
<div class="btn-group btn-group-sm">
    <!-- Download Button -->
    <a href="{% url 'mediafiles:videoclip_download' event.pk %}" 
       class="btn btn-outline-secondary btn-sm"
       aria-label="Baixar vídeo original"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Baixar vídeo"
       download="{{ event.original_filename }}">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="visually-hidden">Baixar</span>
    </a>
    
    <!-- Detail View Button -->
    <a href="{{ event.get_absolute_url }}" 
       class="btn btn-outline-info btn-sm"
       aria-label="Ver detalhes completos do vídeo"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Ver detalhes">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        <span class="visually-hidden">Detalhes</span>
    </a>
    
    <!-- Edit Button -->
    {% if event_data.can_edit %}
        <a href="{{ event.get_edit_url }}" 
           class="btn btn-outline-warning btn-sm"
           aria-label="Editar vídeo"
           data-bs-toggle="tooltip" 
           data-bs-placement="top" 
           title="Editar vídeo">
            <i class="bi bi-pencil" aria-hidden="true"></i>
            <span class="visually-hidden">Editar</span>
        </a>
    {% endif %}
</div>
{% endblock event_actions %}

{% block event_content %}
<div class="videoclip-event-content">
    <!-- Video Preview with Icon -->
    <div class="video-preview-container mb-3">
        <div class="video-preview-card d-flex align-items-center p-3 bg-light rounded border cursor-pointer"
             data-video-id="{{ event.pk }}"
             data-bs-toggle="modal"
             data-bs-target="#videoModal{{ event.pk }}"
             role="button"
             tabindex="0"
             aria-label="Clique para reproduzir vídeo">
            
            <!-- Video Icon -->
            <div class="video-icon-container me-3 flex-shrink-0">
                <div class="video-icon-wrapper d-flex align-items-center justify-content-center bg-primary rounded-circle" 
                     style="width: 60px; height: 60px;">
                    <i class="bi bi-play-circle-fill text-white" style="font-size: 2rem;" aria-hidden="true"></i>
                </div>
            </div>
            
            <!-- Video Info -->
            <div class="video-info flex-grow-1">
                <div class="video-filename fw-semibold text-dark mb-1" style="font-size: 0.95rem;">
                    <i class="bi bi-camera-video me-2 text-primary" aria-hidden="true"></i>
                    {{ event.original_filename|default:"video.mp4" }}
                </div>
                
                <div class="video-details d-flex flex-wrap gap-3 small text-muted">
                    {% if event.duration %}
                    <span>
                        <i class="bi bi-clock me-1" aria-hidden="true"></i>
                        {{ event.duration|mediafiles_duration }}
                    </span>
                    {% endif %}
                    
                    {% if event.file_size %}
                    <span>
                        <i class="bi bi-hdd me-1" aria-hidden="true"></i>
                        {{ event.file_size|mediafiles_file_size }}
                    </span>
                    {% endif %}
                    
                    {% if event.width and event.height %}
                    <span>
                        <i class="bi bi-aspect-ratio me-1" aria-hidden="true"></i>
                        {{ event.width }}×{{ event.height }}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Play Arrow -->
            <div class="play-arrow-container flex-shrink-0 ms-2">
                <i class="bi bi-chevron-right text-primary" style="font-size: 1.25rem;" aria-hidden="true"></i>
            </div>
        </div>
    </div>
    
    <!-- Video Description -->
    {% if event.description %}
        <div class="video-description mb-3">
            <div class="description-content p-3 bg-white rounded border-start border-primary border-4">
                <h6 class="mb-2 text-primary">
                    <i class="bi bi-file-text me-2" aria-hidden="true"></i>
                    Descrição
                </h6>
                <p class="mb-0 text-dark lh-base">{{ event.description }}</p>
            </div>
        </div>
    {% endif %}
    
    <!-- Video Caption -->
    {% if event.caption %}
        <div class="video-caption mb-3">
            <div class="caption-content p-3 bg-info bg-opacity-10 rounded border-start border-info border-4">
                <h6 class="mb-2 text-info">
                    <i class="bi bi-chat-quote me-2" aria-hidden="true"></i>
                    Legenda
                </h6>
                <p class="mb-0 text-dark lh-base">{{ event.caption }}</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock event_content %}

{% block extra_html %}
<!-- Video Modal for inline playback -->
<div class="modal fade" id="videoModal{{ event.pk }}" tabindex="-1" aria-labelledby="videoModalLabel{{ event.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoModalLabel{{ event.pk }}">
                    <i class="bi bi-camera-video me-2"></i>
                    {{ event.description|default:"Vídeo" }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <video class="w-100" controls preload="metadata" id="modalVideo{{ event.pk }}">
                    <source src="{% url 'mediafiles:videoclip_stream' event.pk %}" type="video/mp4">
                    <p class="text-center p-4">
                        Seu navegador não suporta o elemento de vídeo. 
                        <a href="{% url 'mediafiles:videoclip_download' event.pk %}" class="btn btn-primary btn-sm ms-2">
                            <i class="bi bi-download me-1"></i>
                            Baixar Vídeo
                        </a>
                    </p>
                </video>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">
                        {% if event.duration %}
                        <i class="bi bi-clock me-1"></i>
                        {{ event.duration|mediafiles_duration }}
                        {% endif %}
                        {% if event.file_size %}
                        <i class="bi bi-hdd ms-3 me-1"></i>
                        {{ event.file_size|mediafiles_file_size }}
                        {% endif %}
                    </small>
                </div>
                <a href="{% url 'mediafiles:videoclip_download' event.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-download me-1"></i>
                    Download
                </a>
                <a href="{{ event.get_absolute_url }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-info-circle me-1"></i>
                    Ver Detalhes
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock extra_html %}

{% block extra_css %}
<style>
/* VideoClip Event Card Specific Styles */
.videoclip-event-content {
    position: relative;
}

/* Video Preview Card */
.video-preview-container {
    margin: 1rem 0;
}

.video-preview-card {
    transition: all 0.2s ease-in-out;
    border: 1px solid #dee2e6 !important;
    cursor: pointer;
}

.video-preview-card:hover {
    background-color: #f8f9fa !important;
    border-color: #007bff !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.15);
}

.video-preview-card:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
}

.video-icon-wrapper {
    transition: transform 0.2s ease;
}

.video-preview-card:hover .video-icon-wrapper {
    transform: scale(1.1);
}

.video-filename {
    word-break: break-word;
    line-height: 1.3;
}

.video-details {
    line-height: 1.4;
}

.play-arrow-container {
    transition: transform 0.2s ease;
}

.video-preview-card:hover .play-arrow-container {
    transform: translateX(3px);
}

/* Description and Caption Styling */
.description-content, .caption-content {
    transition: all 0.2s ease;
}

.description-content:hover, .caption-content:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.description-content h6, .caption-content h6 {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.description-content p, .caption-content p {
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 0;
}


/* Responsive Design */
@media (max-width: 768px) {
    .video-icon-wrapper {
        width: 50px !important;
        height: 50px !important;
    }
    
    .video-icon-wrapper i {
        font-size: 1.75rem !important;
    }
    
    .video-filename {
        font-size: 0.9rem;
    }
    
    .video-details {
        font-size: 0.8rem;
    }
}

@media (max-width: 576px) {
    .video-preview-card {
        flex-direction: column;
        text-align: center;
    }
    
    .video-icon-container {
        margin-right: 0 !important;
        margin-bottom: 1rem;
    }
    
    .play-arrow-container {
        display: none;
    }
    
    .description-content, .caption-content {
        padding: 1rem;
    }
}
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Prevent multiple initialization
        if (window.videoClipModalInitialized) {
            return;
        }
        window.videoClipModalInitialized = true;
        
        // Handle video preview card click to open modal
        const videoPreviewCards = document.querySelectorAll('.video-preview-card');

        videoPreviewCards.forEach(previewCard => {
            previewCard.addEventListener('click', function(e) {
                // Prevent click if it's on an action button
                if (e.target.closest('.btn') || e.target.closest('.dropdown')) {
                    return;
                }

                // Get the video ID from the data attribute
                const videoId = this.dataset.videoId;
                if (!videoId) {
                    console.error('Video ID not found!');
                    return;
                }

                // Check if modal exists
                const modalElement = document.getElementById('videoModal' + videoId);
                if (!modalElement) {
                    console.error('Video modal not found for ID:', videoId);
                    return;
                }

                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap is not loaded!');
                    return;
                }

                // Open video modal
                const videoModal = new bootstrap.Modal(modalElement);
                videoModal.show();
            });
        });

    // Handle video modal events for all video modals
    const videoModals = document.querySelectorAll('[id^="videoModal"]');
    
    videoModals.forEach(function(videoModal) {
        const modalVideo = videoModal.querySelector('[id^="modalVideo"]');
        
        if (modalVideo) {
            videoModal.addEventListener('shown.bs.modal', function () {
                // Focus on the modal for keyboard navigation
                this.focus();
            });

            videoModal.addEventListener('hide.bs.modal', function () {
                // Remove focus from any focused element within the modal before closing
                const focusedElement = this.querySelector(':focus');
                if (focusedElement) {
                    focusedElement.blur();
                }
            });
            
            videoModal.addEventListener('hidden.bs.modal', function () {
                // Pause video when modal closes and reset to beginning
                modalVideo.pause();
                modalVideo.currentTime = 0;
                
                // Ensure modal backdrop is properly removed
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                // Restore body scroll and remove modal-related classes
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            });

            // Handle close button clicks specifically
            const closeButton = videoModal.querySelector('.btn-close');
            if (closeButton) {
                closeButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.blur(); // Remove focus immediately
                    
                    const modalInstance = bootstrap.Modal.getInstance(videoModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                });
            }
            
            // Close modal with Escape key
            videoModal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    const focusedElement = this.querySelector(':focus');
                    if (focusedElement) {
                        focusedElement.blur();
                    }
                    
                    const modalInstance = bootstrap.Modal.getInstance(this);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });
        }
    });


    // Initialize tooltips for video action buttons
    const tooltips = document.querySelectorAll('.videoclip-event-content [data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });

        // Handle keyboard navigation for video preview cards
        videoPreviewCards.forEach(previewCard => {
            previewCard.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

    // Video player controls enhancement
    const videos = document.querySelectorAll('video');
    videos.forEach(video => {
        // Add loading indicator
        video.addEventListener('loadstart', function() {
            this.style.cursor = 'wait';
        });

        video.addEventListener('canplay', function() {
            this.style.cursor = 'default';
        });

        // Error handling
        video.addEventListener('error', function() {
            console.error('Video loading error:', this.error);
            console.log('Video source:', this.src);
            console.log('Video mime type:', this.querySelector('source')?.type);
            
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-warning text-center m-3';
            
            // Provide specific help for MOV files
            const sourceElement = this.querySelector('source');
            const mimeType = sourceElement?.type;
            let helpText = 'Erro ao carregar o vídeo.';
            
            if (mimeType === 'video/quicktime') {
                helpText = 'Este arquivo MOV pode não ser compatível com seu navegador.';
            }
            
            errorMsg.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${helpText}
                <br>
                <div class="mt-2">
                    <a href="${this.querySelector('source')?.src}" class="btn btn-primary btn-sm me-2" download>
                        <i class="bi bi-download me-1"></i>
                        Baixar Vídeo
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="this.closest('.modal-body').querySelector('video').load()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Tentar Novamente
                    </button>
                </div>
            `;
            this.parentNode.replaceChild(errorMsg, this);
        });
    });
    
    } catch (error) {
        console.error('Error in VideoClip script:', error);
    }
});
</script>
{% endblock extra_js %}
