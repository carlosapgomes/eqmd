{% extends "events/partials/event_card_base.html" %}
{% load mediafiles_tags %}
{% load permission_tags %}

{% comment %}
PhotoSeries-specific event card template
Extends the base event card and adds PhotoSeries-specific content and actions
{% endcomment %}

{% block event_actions %}
<div class="btn-group btn-group-sm">
    <!-- View Button -->
    <a href="{% url 'mediafiles:photoseries_detail' event.pk %}" 
       class="btn btn-outline-primary btn-sm"
       aria-label="Visualizar série de fotos completa"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Ver série completa">
        <i class="bi bi-eye" aria-hidden="true"></i>
        <span class="visually-hidden">Visualizar</span>
    </a>
    
    <!-- Download Button -->
    <a href="{% url 'mediafiles:photoseries_download' event.pk %}" 
       class="btn btn-outline-success btn-sm"
       aria-label="Baixar série de fotos"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Baixar série (ZIP)">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="visually-hidden">Baixar</span>
    </a>
    
    <!-- Edit Button -->
    {% if event_data.can_edit %}
        <a href="{% url 'mediafiles:photoseries_update' event.pk %}" 
           class="btn btn-outline-warning btn-sm"
           aria-label="Editar série de fotos"
           data-bs-toggle="tooltip" 
           data-bs-placement="top" 
           title="Editar série">
            <i class="bi bi-pencil" aria-hidden="true"></i>
            <span class="visually-hidden">Editar</span>
        </a>
    {% endif %}
</div>
{% endblock event_actions %}

{% block event_content %}
<div class="photoseries-content">
    <!-- Series Description -->
    {% if event.description %}
    <p class="event-excerpt mb-2">{{ event.description }}</p>
    {% endif %}
    
    <!-- Primary Photo Thumbnail -->
    <div class="photoseries-thumbnail-container">
        {% with primary_thumbnail=event.get_primary_thumbnail photos=event.get_ordered_photos %}
        {% if primary_thumbnail and photos %}
        <div class="photoseries-thumbnail-wrapper" 
             data-gallery-id="timeline-photoseries-{{ event.pk }}"
             data-photo-index="0"
             data-trigger="lightbox"
             style="cursor: pointer;"
             tabindex="0"
             role="button"
             aria-label="Abrir série de fotos em lightbox">
            <img src="{{ primary_thumbnail }}" 
                 class="photoseries-thumbnail" 
                 alt="Primeira foto da série"
                 loading="lazy"
                 data-full-url="{% url 'mediafiles:serve_file' photos.0.id %}"
                 data-filename="{{ photos.0.original_filename }}"
                 data-size="{{ photos.0.get_display_size }}"
                 data-dimensions="{{ photos.0.get_dimensions_display }}"
                 data-mime-type="{{ photos.0.mime_type }}">
            
            <!-- Photo Count Overlay -->
            <div class="photoseries-overlay">
                <div class="photoseries-count-badge">
                    <i class="bi bi-images me-1"></i>
                    {{ event.get_photo_count }}
                </div>
            </div>
            
            <!-- Click to View Overlay -->
            <div class="photoseries-view-overlay">
                <div class="photoseries-view-content">
                    <i class="bi bi-eye display-6 text-white mb-2"></i>
                    <p class="text-white small mb-0">Clique para visualizar série</p>
                </div>
            </div>
        </div>
        
        <!-- Hidden photo data for lightbox -->
        <div class="d-none" data-gallery-id="timeline-photoseries-{{ event.pk }}">
            {% for photo in photos %}
            <div class="gallery-item" 
                 data-photo-index="{{ forloop.counter0 }}"
                 data-photo-id="{{ photo.id }}">
                <img src="{% url 'mediafiles:serve_file' photo.id %}" 
                     class="gallery-thumbnail"
                     alt="{{ photo.original_filename }}"
                     data-full-url="{% url 'mediafiles:serve_file' photo.id %}"
                     data-download-url="{% url 'mediafiles:photo_download' photo.id %}"
                     data-filename="{{ photo.original_filename }}"
                     data-size="{{ photo.get_display_size }}"
                     data-dimensions="{{ photo.get_dimensions_display }}"
                     data-mime-type="{{ photo.mime_type }}">
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- No Photo Placeholder -->
        <div class="photoseries-placeholder">
            <i class="bi bi-images display-4 text-muted"></i>
            <p class="text-muted small mb-0">Série sem fotos</p>
        </div>
        {% endif %}
        {% endwith %}
    </div>
    
    <!-- Series Caption -->
    {% if event.caption %}
    <p class="text-muted small mt-1 mb-0">{{ event.caption }}</p>
    {% endif %}
</div>
{% endblock event_content %}

{% block event_metadata %}
<small class="text-muted">
    <i class="bi bi-person me-1" aria-hidden="true"></i>
    <span aria-label="Criado por">{{ event.created_by.get_full_name }}</span>
    {% if event.created_by.profession %}
        <span aria-label="Profissão">({{ event.created_by.profession }})</span>
    {% endif %}
    <span class="badge bg-secondary ms-2">
        {{ event.get_photo_count }} foto{{ event.get_photo_count|pluralize:"s" }}
    </span>
</small>
{% if event.updated_at != event.created_at %}
    <small class="text-muted">
        <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
        <time datetime="{{ event.updated_at|date:'c' }}">
            Editado em {{ event.updated_at|date:"d/m/Y H:i" }}
        </time>
    </small>
{% endif %}
{% endblock event_metadata %}