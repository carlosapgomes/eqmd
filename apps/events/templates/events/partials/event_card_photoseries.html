{% extends "events/partials/event_card_base.html" %}
{% load mediafiles_tags %}
{% load permission_tags %}

{% comment %}
PhotoSeries-specific event card template
Extends the base event card and adds PhotoSeries-specific content and actions
{% endcomment %}

{% block event_actions %}
<div class="btn-group btn-group-sm">
    <!-- View Button -->
    <a href="{% url 'mediafiles:photoseries_detail' event.pk %}" 
       class="btn btn-outline-primary btn-sm"
       aria-label="Visualizar série de fotos completa"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Ver série completa">
        <i class="bi bi-eye" aria-hidden="true"></i>
        <span class="visually-hidden">Visualizar</span>
    </a>
    
    <!-- Download Button -->
    <a href="{% url 'mediafiles:photoseries_download' event.pk %}" 
       class="btn btn-outline-success btn-sm"
       aria-label="Baixar série de fotos"
       data-bs-toggle="tooltip" 
       data-bs-placement="top" 
       title="Baixar série (ZIP)">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="visually-hidden">Baixar</span>
    </a>
    
    <!-- Edit Button -->
    {% if event_data.can_edit %}
        <a href="{% url 'mediafiles:photoseries_update' event.pk %}" 
           class="btn btn-outline-warning btn-sm"
           aria-label="Editar série de fotos"
           data-bs-toggle="tooltip" 
           data-bs-placement="top" 
           title="Editar série">
            <i class="bi bi-pencil" aria-hidden="true"></i>
            <span class="visually-hidden">Editar</span>
        </a>
    {% endif %}
</div>
{% endblock event_actions %}

{% block event_content %}
<div class="photoseries-content">
    <!-- Primary Photo Thumbnail -->
    <div class="photoseries-thumbnail-container mb-3 d-flex justify-content-center">
        {% with primary_thumbnail=event.get_primary_thumbnail photos=event.get_ordered_photos %}
        {% if primary_thumbnail and photos %}
        <div class="photoseries-thumbnail-wrapper" 
             data-gallery-id="timeline-photoseries-{{ event.pk }}"
             data-photo-index="0"
             data-trigger="lightbox"
             style="cursor: pointer;"
             tabindex="0"
             role="button"
             aria-label="Abrir série de fotos em lightbox">
            <img src="{{ primary_thumbnail }}" 
                 class="photoseries-thumbnail" 
                 alt="Primeira foto da série"
                 loading="lazy"
                 data-full-url="{% url 'mediafiles:serve_file' photos.0.id %}"
                 data-filename="{{ photos.0.original_filename }}"
                 data-size="{{ photos.0.get_display_size }}"
                 data-dimensions="{{ photos.0.get_dimensions_display }}"
                 data-mime-type="{{ photos.0.mime_type }}">
            
            <!-- Photo Count Overlay -->
            <div class="photoseries-overlay">
                <div class="photoseries-count-badge">
                    <i class="bi bi-images me-1"></i>
                    {{ event.get_photo_count }}
                </div>
            </div>
            
        </div>
        
        <!-- JSON data for lightbox (Primary method) -->
        <script type="application/json" id="photoSeriesData-{{ event.pk }}">
        {
            "photos": [
                {% for photo in photos %}
                {
                    "id": "{{ photo.id }}",
                    "url": "{% url 'mediafiles:serve_file' photo.id %}",
                    "downloadUrl": "{% url 'mediafiles:photo_download' photo.id %}",
                    "filename": "{{ photo.original_filename|escapejs }}",
                    "size": "{{ photo.get_display_size }}",
                    "dimensions": "{{ photo.get_dimensions_display }}",
                    "mimeType": "{{ photo.mime_type }}",
                    "index": {{ forloop.counter }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            "totalPhotos": {{ photos.count }},
            "galleryId": "timeline-photoseries-{{ event.pk }}"
        }
        </script>

        <!-- Hidden photo data for lightbox (Fallback method) -->
        <div class="d-none gallery-data" data-gallery-id="timeline-photoseries-{{ event.pk }}">
            {% for photo in photos %}
            <div class="gallery-item" 
                 data-photo-index="{{ forloop.counter0 }}"
                 data-photo-id="{{ photo.id }}">
                <img src="{% url 'mediafiles:serve_file' photo.id %}" 
                     class="gallery-thumbnail"
                     alt="{{ photo.original_filename }}"
                     data-full-url="{% url 'mediafiles:serve_file' photo.id %}"
                     data-download-url="{% url 'mediafiles:photo_download' photo.id %}"
                     data-filename="{{ photo.original_filename }}"
                     data-size="{{ photo.get_display_size }}"
                     data-dimensions="{{ photo.get_dimensions_display }}"
                     data-mime-type="{{ photo.mime_type }}">
            </div>
            {% empty %}
            <!-- Debug: No photos found -->
            <div class="debug-no-photos">No photos in series</div>
            {% endfor %}
        </div>
        {% else %}
        <!-- No Photo Placeholder -->
        <div class="photoseries-placeholder">
            <i class="bi bi-images display-4 text-muted"></i>
            <p class="text-muted small mb-0">Série sem fotos</p>
        </div>
        {% endif %}
        {% endwith %}
    </div>
    
    <!-- Series Description -->
    {% if event.description %}
        <div class="photoseries-description mb-2">
            <p class="mb-0">{{ event.description }}</p>
        </div>
    {% endif %}
    
    <!-- Series Caption -->
    {% if event.caption %}
        <div class="photoseries-caption mb-2">
            <small class="text-muted">
                <i class="bi bi-chat-quote me-1" aria-hidden="true"></i>
                {{ event.caption }}
            </small>
        </div>
    {% endif %}
    
    <!-- Series Metadata -->
    <div class="photoseries-metadata">
        <div class="row g-2 small text-muted">
            {% with primary_photo=event.get_ordered_photos.first %}
            {% if primary_photo %}
            <div class="col-sm-6">
                <i class="bi bi-file-earmark-image me-1" aria-hidden="true"></i>
                <span>{{ primary_photo.original_filename }}</span>
            </div>
            {% endif %}
            {% endwith %}
            <div class="col-sm-3">
                <i class="bi bi-images me-1" aria-hidden="true"></i>
                <span>{{ event.get_photo_count }} foto{{ event.get_photo_count|pluralize:"s" }}</span>
            </div>
            <div class="col-sm-3">
                <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>
                <span>{{ event.created_at|date:"d/m/Y" }}</span>
            </div>
        </div>
    </div>
</div>
{% endblock event_content %}

{% block event_metadata %}
<small class="text-muted">
    <i class="bi bi-person me-1" aria-hidden="true"></i>
    <span aria-label="Criado por">{{ event.created_by.get_full_name }}</span>
    {% if event.created_by.profession %}
        <span aria-label="Profissão">({{ event.created_by.profession }})</span>
    {% endif %}
    <span class="badge bg-secondary ms-2">
        {{ event.get_photo_count }} foto{{ event.get_photo_count|pluralize:"s" }}
    </span>
</small>
{% if event.updated_at != event.created_at %}
    <small class="text-muted">
        <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
        <time datetime="{{ event.updated_at|date:'c' }}">
            Editado em {{ event.updated_at|date:"d/m/Y H:i" }}
        </time>
    </small>
{% endif %}
{% endblock event_metadata %}