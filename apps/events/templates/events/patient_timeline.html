{% extends "base_app.html" %}
{% load permission_tags %}
{% load static %}

{% block title %}Timeline - {{ patient.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'events/css/print.css' %}" media="print">
<style>
.timeline-card {
    border-left: 4px solid var(--bs-primary);
    transition: all 0.2s ease;
}
.timeline-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
.event-type-badge {
    font-size: 0.75rem;
    font-weight: 600;
}
.event-excerpt {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
}
.filter-panel {
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}
.timeline-container {
    max-width: 800px;
}
.event-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}
.timeline-card:hover .event-actions {
    opacity: 1;
}
@media (max-width: 768px) {
    .event-actions {
        opacity: 1; /* Always show on mobile */
    }
}
</style>
{% endblock %}

{% block content %}
<div class="timeline-container" role="main" aria-label="Timeline de eventos do paciente">
    
    <!-- Add skip navigation -->
    <a class="visually-hidden-focusable" href="#timeline-content">Pular para timeline</a>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="text-medical-primary mb-1">
                        <i class="bi bi-clock-history me-2" aria-hidden="true"></i>
                        Timeline de Eventos
                    </h1>
                    <p class="text-muted mb-0">
                        <a href="{% url 'apps.patients:patient_detail' patient.pk %}" class="text-decoration-none">
                            {{ patient.name }}
                        </a>
                        <span class="mx-2" aria-hidden="true">•</span>
                        {% if filtered_count != total_events %}
                            {{ filtered_count }} de {{ total_events }} eventos
                        {% else %}
                            {{ total_events }} evento{{ total_events|pluralize }}
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'apps.patients:patient_detail' patient.pk %}" 
                       class="btn btn-outline-medical-primary"
                       aria-label="Voltar à página do paciente {{ patient.name }}">
                        <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
                        Voltar ao Paciente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filters Panel -->
        <div class="col-lg-3 mb-4">
            <div class="filter-panel p-3">
                <h2 class="text-medical-primary mb-3 h5">
                    <i class="bi bi-funnel me-2" aria-hidden="true"></i>
                    Filtros
                </h2>
                
                <form method="get" id="timeline-filters" role="search" aria-label="Filtros da timeline">
                    <fieldset>
                        <legend class="visually-hidden">Filtros de eventos</legend>
                        
                        <!-- Event Type Filter -->
                        <div class="mb-3" role="group" aria-labelledby="event-types-label">
                            <label id="event-types-label" class="form-label fw-semibold">Tipos de Evento</label>
                            {% for value, label in event_type_choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="types" value="{{ value }}" id="type_{{ value }}"
                                           {% if value|stringformat:"s" in current_filters.types %}checked{% endif %}
                                           aria-describedby="type-{{ value }}-desc">
                                    <label class="form-check-label" for="type_{{ value }}">
                                        {{ label }}
                                    </label>
                                    <span id="type-{{ value }}-desc" class="visually-hidden">
                                        {% with count=event_counts_by_type|get_item:value %}
                                            {{ count|default:0 }} evento{{ count|pluralize }}
                                        {% endwith %}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Quick Date Filters -->
                        <div class="mb-3">
                            <fieldset>
                                <legend class="form-label fw-semibold">Período</legend>
                                <div class="btn-group-vertical d-grid gap-1" role="radiogroup" aria-label="Selecionar período">
                                    <input type="radio" class="btn-check" name="quick_date" value="" id="all_time"
                                           {% if not current_filters.quick_date %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="all_time">Todos</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="24h" id="last_24h"
                                           {% if current_filters.quick_date == '24h' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_24h">Últimas 24h</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="7d" id="last_7d"
                                           {% if current_filters.quick_date == '7d' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_7d">Últimos 7 dias</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="30d" id="last_30d"
                                           {% if current_filters.quick_date == '30d' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_30d">Últimos 30 dias</label>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Custom Date Range -->
                        <div class="mb-3">
                            <fieldset>
                                <legend class="form-label fw-semibold">Período Personalizado</legend>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label for="date_from" class="visually-hidden">Data inicial</label>
                                        <input type="date" class="form-control form-control-sm" 
                                               id="date_from" name="date_from" 
                                               value="{{ current_filters.date_from }}"
                                               aria-label="Data inicial do período">
                                    </div>
                                    <div class="col-6">
                                        <label for="date_to" class="visually-hidden">Data final</label>
                                        <input type="date" class="form-control form-control-sm" 
                                               id="date_to" name="date_to" 
                                               value="{{ current_filters.date_to }}"
                                               aria-label="Data final do período">
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Creator Filter -->
                        {% if available_creators %}
                        <div class="mb-3">
                            <label for="creator" class="form-label fw-semibold">Criado por</label>
                            <select name="creator" id="creator" class="form-select form-select-sm" 
                                    aria-label="Filtrar eventos por profissional">
                                <option value="">Todos os profissionais</option>
                                {% for creator in available_creators %}
                                    <option value="{{ creator.id }}" 
                                            {% if creator.id|stringformat:"s" == current_filters.creator %}selected{% endif %}>
                                        {{ creator.first_name }} {{ creator.last_name }}
                                        {% if creator.profession %} ({{ creator.profession }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <!-- Filter Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-medical-primary btn-sm"
                                    aria-label="Aplicar filtros selecionados">
                                <i class="bi bi-search me-1" aria-hidden="true"></i>
                                Aplicar Filtros
                            </button>
                            <a href="{% url 'apps.patients:patient_events_timeline' patient.pk %}" 
                               class="btn btn-outline-secondary btn-sm"
                               aria-label="Remover todos os filtros">
                                <i class="bi bi-arrow-counterclockwise me-1" aria-hidden="true"></i>
                                Limpar Filtros
                            </a>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>

        <!-- Timeline Content -->
        <div class="col-lg-9">
            <div class="timeline-container">
                {% if events_with_permissions %}
                    <!-- Events Timeline -->
                    <div id="timeline-content" class="timeline-events" role="feed" 
                         aria-label="Lista de eventos médicos" aria-live="polite">
                         
                        {% for event_data in events_with_permissions %}
                            {% with event=event_data.event %}
                            <article class="timeline-card card card-medical mb-3" 
                                     role="article"
                                     aria-labelledby="event-{{ event.pk }}-title"
                                     aria-describedby="event-{{ event.pk }}-content">
                                
                                <div class="card-body">
                                    <!-- Event Header -->
                                    <header class="d-flex align-items-start justify-content-between mb-2">
                                        <div class="d-flex align-items-center">
                                            <h3 id="event-{{ event.pk }}-title" class="h6 mb-0 me-2">
                                                <span class="badge {{ event.get_event_type_badge_class }} event-type-badge">
                                                    <i class="{{ event.get_event_type_icon }} me-1" aria-hidden="true"></i>
                                                    {{ event.get_event_type_display }}
                                                </span>
                                            </h3>
                                            <time datetime="{{ event.created_at|date:'c' }}" 
                                                  class="text-muted small">
                                                <i class="bi bi-clock me-1" aria-hidden="true"></i>
                                                {{ event.created_at|date:"d/m/Y H:i" }}
                                            </time>
                                        </div>
                                        
                                        <!-- Event Actions -->
                                        <div class="event-actions" role="group" 
                                             aria-label="Ações para {{ event.get_event_type_display }}">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'events:patient_events_list' event.patient.pk %}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   aria-label="Visualizar {{ event.get_event_type_display }} completo">
                                                    <i class="bi bi-eye" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Visualizar</span>
                                                </a>
                                                {% if event_data.can_edit %}
                                                    <a href="#" 
                                                       class="btn btn-outline-warning btn-sm"
                                                       aria-label="Editar {{ event.get_event_type_display }}">
                                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                                        <span class="visually-hidden">Editar</span>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </header>

                                    <!-- Event Content -->
                                    <div id="event-{{ event.pk }}-content" class="event-content">
                                        <p class="event-excerpt">{{ event_data.excerpt }}</p>
                                    </div>

                                    <!-- Event Metadata -->
                                    <footer class="d-flex align-items-center justify-content-between mt-2 pt-2 border-top">
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1" aria-hidden="true"></i>
                                            <span aria-label="Criado por">{{ event.created_by.get_full_name }}</span>
                                            {% if event.created_by.profession %}
                                                <span aria-label="Profissão">({{ event.created_by.profession }})</span>
                                            {% endif %}
                                        </small>
                                        {% if event.updated_at != event.created_at %}
                                            <small class="text-muted">
                                                <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
                                                <time datetime="{{ event.updated_at|date:'c' }}">
                                                    Editado em {{ event.updated_at|date:"d/m/Y H:i" }}
                                                </time>
                                            </small>
                                        {% endif %}
                                    </footer>
                                </div>
                            </article>
                            {% endwith %}
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                        <nav aria-label="Timeline pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                            
                            <!-- Pagination Info -->
                            <div class="text-center text-muted mt-2">
                                <small>
                                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    ({{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} eventos)
                                </small>
                            </div>
                        </nav>
                    {% endif %}

                {% else %}
                    <!-- Empty State -->
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-clock-history text-muted" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-muted mb-3">Nenhum evento encontrado</h4>
                        {% if current_filters.types or current_filters.quick_date or current_filters.date_from or current_filters.date_to or current_filters.creator %}
                            <p class="text-muted mb-3">
                                Nenhum evento corresponde aos filtros selecionados.
                            </p>
                            <a href="{% url 'apps.patients:patient_events_timeline' patient.pk %}" 
                               class="btn btn-outline-medical-primary">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                Limpar Filtros
                            </a>
                        {% else %}
                            <p class="text-muted mb-3">
                                Este paciente ainda não possui eventos registrados.
                            </p>
                            <a href="{% url 'events:patient_events_list' patient.pk %}" 
                               class="btn btn-medical-primary">
                                <i class="bi bi-plus-circle me-2"></i>
                                Criar Primeiro Evento
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Print header (hidden by default, shown only when printing) -->
<div class="print-header d-none">
    <h1>Timeline de Eventos - {{ patient.name }}</h1>
    <p>Data de impressão: {% now "d/m/Y H:i" %}</p>
    <hr>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'events/js/accessibility.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit filters on change
    const filterForm = document.getElementById('timeline-filters');
    const filterInputs = filterForm.querySelectorAll('input[type="checkbox"], input[type="radio"], select');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Debounce for better UX
            setTimeout(() => {
                filterForm.submit();
            }, 100);
        });
    });
    
    // Date inputs submit on change (not immediate for better UX)
    const dateInputs = filterForm.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Clear quick date selection when custom dates are used
            const quickDateInputs = filterForm.querySelectorAll('input[name="quick_date"]');
            quickDateInputs.forEach(radio => {
                if (radio.value !== '') {
                    radio.checked = false;
                }
            });
        });
    });
    
    // Clear custom dates when quick date is selected
    const quickDateInputs = filterForm.querySelectorAll('input[name="quick_date"]');
    quickDateInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value !== '') {
                const dateInputs = filterForm.querySelectorAll('input[type="date"]');
                dateInputs.forEach(dateInput => {
                    dateInput.value = '';
                });
            }
        });
    });
});
</script>
{% endblock %}