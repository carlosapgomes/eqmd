{% extends "base_app.html" %}
{% load permission_tags %}
{% load event_tags %}
{% load static %}

{% block title %}Timeline - {{ patient.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'events/css/print.css' %}" media="print">
<style>
.timeline-card {
    border-left: 4px solid var(--bs-primary);
    transition: all 0.2s ease;
}
.timeline-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
.event-type-badge {
    font-size: 0.75rem;
    font-weight: 600;
}
.event-excerpt {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
}
.filter-panel {
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

/* Desktop sticky filters */
@media (min-width: 992px) {
    .filter-panel {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
}
/* Desktop: full width within column, Mobile: constrained width */
@media (min-width: 992px) {
    .timeline-container {
        max-width: none; /* Use full available width on desktop */
        padding-left: 1rem; /* Add some left padding for better spacing from sidebar */
    }
    
    .timeline-card {
        margin-bottom: 1.5rem; /* Better spacing between cards on desktop */
    }
}
@media (max-width: 991.98px) {
    .timeline-container {
        max-width: 800px; /* Constrain width on mobile/tablet */
        margin: 0 auto; /* Center on mobile */
    }
}
.event-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}
.timeline-card:hover .event-actions {
    opacity: 1;
}
@media (max-width: 768px) {
    .event-actions {
        opacity: 1; /* Always show on mobile */
    }
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
}
.dropdown-item.disabled {
    color: #6c757d !important;
    pointer-events: none;
    background-color: transparent;
}
.dropdown-item.disabled:hover {
    background-color: transparent;
}
.dropdown-item .text-muted.ms-auto {
    font-size: 0.75rem;
    font-style: italic;
}
.dropdown-menu {
    min-width: 280px;
}
.dropdown-header {
    font-weight: 600;
    color: var(--bs-primary);
    font-size: 0.875rem;
}
.dropdown-item {
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
}
.dropdown-item i {
    width: 1.25rem;
    text-align: center;
}

/* Mobile filter enhancements */
@media (max-width: 991.98px) {
    .filter-panel {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #ffffff;
    }
    
    #mobile-filters .filter-panel {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .collapse.show {
        animation: slideDown 0.3s ease-out;
    }
    
    .collapse:not(.show) {
        animation: slideUp 0.3s ease-out;
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

/* Improved mobile filter toggle button */
#mobile-filter-toggle {
    border: 1px solid var(--bs-primary);
    transition: all 0.2s ease;
}

#mobile-filter-toggle:hover {
    background-color: var(--bs-primary);
    color: white;
}

#mobile-filter-toggle i {
    transition: transform 0.2s ease;
}

/* Better spacing for mobile form elements */
@media (max-width: 575.98px) {
    .filter-panel .form-check {
        margin-bottom: 0.75rem;
    }
    
    .filter-panel .btn-group-vertical .btn {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .d-flex.gap-2 {
        gap: 0.75rem !important;
    }
}

/* Mobile header improvements */
@media (max-width: 767.98px) {
    /* Improve title hierarchy and spacing on mobile */
    .d-block.d-md-none h1.h4 {
        font-size: 1.25rem;
        line-height: 1.3;
        margin-bottom: 0.75rem;
    }
    
    .d-block.d-md-none h1.h4 i {
        font-size: 1.1rem;
    }
    
    /* Better patient info styling */
    .d-block.d-md-none p.small {
        font-size: 0.875rem;
        line-height: 1.4;
    }
    
    /* Optimize button spacing and sizing */
    .d-flex.flex-column.gap-2 {
        gap: 0.75rem !important;
    }
    
    .d-flex.flex-column.gap-2 .btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        border-radius: 6px;
    }
    
    /* Ensure proper touch targets */
    .d-flex.flex-column.gap-2 .btn {
        min-height: 44px; /* Recommended minimum touch target size */
    }
    
    /* Better visual hierarchy with improved spacing */
    .d-block.d-md-none .mb-3 {
        margin-bottom: 1rem !important;
    }
}

/* Enhanced button styling for mobile */
@media (max-width: 575.98px) {
    .d-flex.flex-column.gap-2 .btn {
        font-size: 0.875rem;
        padding: 0.65rem 1rem;
    }
    
    /* Better spacing between title and patient info */
    .d-block.d-md-none h1.h4 {
        margin-bottom: 0.5rem;
    }
    
    .d-block.d-md-none p.small {
        margin-bottom: 0.25rem;
    }
}

/* Mobile filters optimization */
@media (max-width: 991.98px) {
    /* Compact mobile filter toggle */
    .d-lg-none .d-flex.align-items-center.justify-content-between {
        background-color: rgba(var(--bs-light-rgb), 0.3);
        transition: all 0.2s ease;
    }
    
    .d-lg-none .d-flex.align-items-center.justify-content-between:hover {
        background-color: rgba(var(--bs-light-rgb), 0.5);
    }
    
    /* Optimize filter icon and text spacing */
    .d-lg-none .bi-funnel {
        font-size: 0.875rem;
    }
    
    .d-lg-none .text-medical-primary {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    /* Better badge styling */
    .d-lg-none .badge {
        font-size: 0.65rem;
        padding: 0.25em 0.5em;
    }
    
    /* Smooth chevron rotation */
    #mobile-filter-toggle i.bi-chevron-down,
    #mobile-filter-toggle i.bi-chevron-up {
        transition: transform 0.2s ease;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block app_content %}
<div class="timeline-container" role="main" aria-label="Timeline de eventos do paciente">
    
    <!-- Add skip navigation -->
    <a class="visually-hidden-focusable" href="#timeline-content">Pular para timeline</a>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <!-- Mobile Header Layout -->
            <div class="d-block d-md-none">
                <!-- Title Section -->
                <div class="mb-3">
                    <h1 class="text-medical-primary mb-2 h4">
                        <i class="bi bi-clock-history me-2" aria-hidden="true"></i>
                        Timeline de Eventos
                    </h1>
                    <p class="text-muted mb-0 small">
                        <a href="{% url 'apps.patients:patient_detail' patient.pk %}" class="text-decoration-none">
                            {{ patient.name }}
                        </a>
                        <span class="mx-1" aria-hidden="true">•</span>
                        {% if filtered_count != total_events %}
                            {{ filtered_count }} de {{ total_events }} eventos
                        {% else %}
                            {{ total_events }} evento{{ total_events|pluralize }}
                        {% endif %}
                    </p>
                </div>
                
                <!-- Action Buttons Section -->
                <div class="d-flex flex-column gap-2">
                    <!-- Create Event Dropdown - Mobile -->
                    {% if user.is_authenticated %}
                    <div class="dropdown">
                        <button class="btn btn-medical-primary dropdown-toggle btn-sm w-100" type="button" 
                                id="createEventDropdownMobile" data-bs-toggle="dropdown" aria-expanded="false"
                                aria-label="Criar novo evento para {{ patient.name }}">
                            <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                            Criar Evento
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="createEventDropdownMobile">
                            <!-- Clinical Notes Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-journal-medical me-1" aria-hidden="true"></i>
                                Notas Clínicas
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}">
                                        <i class="bi bi-journal-text me-2 text-medical-success" aria-hidden="true"></i>
                                        Evolução
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'historyandphysicals:historyandphysical_create' patient.pk %}">
                                        <i class="bi bi-clipboard2-heart me-2 text-medical-info" aria-hidden="true"></i>
                                        Anamnese e Exame Físico
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'apps.simplenotes:patient_simplenote_create' patient.pk %}">
                                        <i class="bi bi-sticky me-2 text-medical-warning" aria-hidden="true"></i>
                                        Nota/Observação
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Exams Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-clipboard2-data me-1" aria-hidden="true"></i>
                                Exames
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-clipboard2-data me-2 text-muted" aria-hidden="true"></i>
                                        Resultado de Exame
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-clipboard2-check me-2 text-muted" aria-hidden="true"></i>
                                        Requisição de Exame
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Media Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-camera me-1" aria-hidden="true"></i>
                                Mídia
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:photo_create' patient.pk %}">
                                        <i class="bi bi-camera me-2 text-medical-primary" aria-hidden="true"></i>
                                        Imagem
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:photoseries_create' patient.pk %}">
                                        <i class="bi bi-images me-2 text-info" aria-hidden="true"></i>
                                        Série de Fotos
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:videoclip_create' patient.pk %}">
                                        <i class="bi bi-play-circle me-2 text-primary" aria-hidden="true"></i>
                                        Vídeo Curto
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- PDF Forms Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-file-earmark-pdf me-1" aria-hidden="true"></i>
                                Formulários PDF
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'pdf_forms:form_select' patient.pk %}">
                                        <i class="bi bi-file-earmark-pdf me-2 text-danger" aria-hidden="true"></i>
                                        Formulário PDF
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Reports Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-file-text me-1" aria-hidden="true"></i>
                                Relatórios
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-door-open me-2 text-muted" aria-hidden="true"></i>
                                        Relatório de Alta
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'outpatientprescriptions:outpatientprescription_create_for_patient' patient_uuid=patient.pk %}">
                                        <i class="bi bi-prescription2 me-2 text-medical-light" aria-hidden="true"></i>
                                        Receita
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-file-text me-2 text-muted" aria-hidden="true"></i>
                                        Relatório
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'apps.patients:patient_detail' patient.pk %}" 
                       class="btn btn-outline-medical-primary btn-sm w-100"
                       aria-label="Voltar à página do paciente {{ patient.name }}">
                        <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
                        Voltar ao Paciente
                    </a>
                </div>
            </div>
            
            <!-- Desktop Header Layout -->
            <div class="d-none d-md-flex align-items-center justify-content-between">
                <div>
                    <h1 class="text-medical-primary mb-1">
                        <i class="bi bi-clock-history me-2" aria-hidden="true"></i>
                        Timeline de Eventos
                    </h1>
                    <p class="text-muted mb-0">
                        <a href="{% url 'apps.patients:patient_detail' patient.pk %}" class="text-decoration-none">
                            {{ patient.name }}
                        </a>
                        <span class="mx-2" aria-hidden="true">•</span>
                        {% if filtered_count != total_events %}
                            {{ filtered_count }} de {{ total_events }} eventos
                        {% else %}
                            {{ total_events }} evento{{ total_events|pluralize }}
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <!-- Create Event Dropdown - Desktop -->
                    {% if user.is_authenticated %}
                    <div class="dropdown">
                        <button class="btn btn-medical-primary dropdown-toggle" type="button" 
                                id="createEventDropdownDesktop" data-bs-toggle="dropdown" aria-expanded="false"
                                aria-label="Criar novo evento para {{ patient.name }}">
                            <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                            Criar Evento
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="createEventDropdownDesktop">
                            <!-- Clinical Notes Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-journal-medical me-1" aria-hidden="true"></i>
                                Notas Clínicas
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}">
                                        <i class="bi bi-journal-text me-2 text-medical-success" aria-hidden="true"></i>
                                        Evolução
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'historyandphysicals:historyandphysical_create' patient.pk %}">
                                        <i class="bi bi-clipboard2-heart me-2 text-medical-info" aria-hidden="true"></i>
                                        Anamnese e Exame Físico
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'apps.simplenotes:patient_simplenote_create' patient.pk %}">
                                        <i class="bi bi-sticky me-2 text-medical-warning" aria-hidden="true"></i>
                                        Nota/Observação
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Exams Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-clipboard2-data me-1" aria-hidden="true"></i>
                                Exames
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-clipboard2-data me-2 text-muted" aria-hidden="true"></i>
                                        Resultado de Exame
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-clipboard2-check me-2 text-muted" aria-hidden="true"></i>
                                        Requisição de Exame
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Media Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-camera me-1" aria-hidden="true"></i>
                                Mídia
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:photo_create' patient.pk %}">
                                        <i class="bi bi-camera me-2 text-medical-primary" aria-hidden="true"></i>
                                        Imagem
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:photoseries_create' patient.pk %}">
                                        <i class="bi bi-images me-2 text-info" aria-hidden="true"></i>
                                        Série de Fotos
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'mediafiles:videoclip_create' patient.pk %}">
                                        <i class="bi bi-play-circle me-2 text-primary" aria-hidden="true"></i>
                                        Vídeo Curto
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- PDF Forms Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-file-earmark-pdf me-1" aria-hidden="true"></i>
                                Formulários PDF
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'pdf_forms:form_select' patient.pk %}">
                                        <i class="bi bi-file-earmark-pdf me-2 text-danger" aria-hidden="true"></i>
                                        Formulário PDF
                                    </a>
                                </li>
                            {% endif %}
                            
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Reports Section -->
                            <li><h6 class="dropdown-header">
                                <i class="bi bi-file-text me-1" aria-hidden="true"></i>
                                Relatórios
                            </h6></li>
                            {% if perms.events.add_event %}
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-door-open me-2 text-muted" aria-hidden="true"></i>
                                        Relatório de Alta
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'outpatientprescriptions:outpatientprescription_create_for_patient' patient_uuid=patient.pk %}">
                                        <i class="bi bi-prescription2 me-2 text-medical-light" aria-hidden="true"></i>
                                        Receita
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item disabled" href="#" aria-disabled="true">
                                        <i class="bi bi-file-text me-2 text-muted" aria-hidden="true"></i>
                                        Relatório
                                        <small class="text-muted ms-auto">Em breve</small>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'apps.patients:patient_detail' patient.pk %}" 
                       class="btn btn-outline-medical-primary"
                       aria-label="Voltar à página do paciente {{ patient.name }}">
                        <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
                        Voltar ao Paciente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mobile Filter Toggle (shown only on mobile) -->
        <div class="col-12 d-lg-none mb-3">
            <div class="d-flex align-items-center justify-content-between py-2 px-3 rounded border border-secondary-subtle">
                <div class="d-flex align-items-center">
                    <i class="bi bi-funnel me-2 text-medical-primary" aria-hidden="true"></i>
                    <span class="text-medical-primary">Filtros</span>
                    <!-- Filter count badges -->
                    <div class="ms-2" id="filter-badges">
                        {% if current_filters.types or current_filters.quick_date or current_filters.date_from or current_filters.date_to or current_filters.creator %}
                            <span class="badge bg-medical-primary rounded-pill" id="filter-count">
                                Ativos
                            </span>
                        {% endif %}
                    </div>
                </div>
                <button class="btn btn-outline-medical-primary" type="button" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                        data-bs-toggle="collapse" data-bs-target="#mobile-filters" 
                        aria-expanded="false" aria-controls="mobile-filters"
                        id="mobile-filter-toggle">
                    <i class="bi bi-chevron-down" aria-hidden="true"></i>
                    <span class="visually-hidden">Expandir filtros</span>
                </button>
            </div>
            
            <!-- Collapsible Mobile Filters -->
            <div class="collapse mt-2" id="mobile-filters">
                <div class="filter-panel p-3">
                    <form method="get" id="mobile-timeline-filters" role="search" aria-label="Filtros da timeline">
                        <fieldset>
                            <legend class="visually-hidden">Filtros de eventos</legend>
                            
                            <!-- Event Type Filter -->
                            <div class="mb-3" role="group" aria-labelledby="mobile-event-types-label">
                                <label id="mobile-event-types-label" class="form-label fw-semibold">Tipos de Evento</label>
                                {% for value, label in event_type_choices %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="types" value="{{ value }}" id="mobile_type_{{ value }}"
                                               {% if value|stringformat:"s" in current_filters.types %}checked{% endif %}
                                               aria-describedby="mobile-type-{{ value }}-desc">
                                        <label class="form-check-label" for="mobile_type_{{ value }}">
                                            {{ label }}
                                        </label>
                                        <span id="mobile-type-{{ value }}-desc" class="visually-hidden">
                                            {% with count=event_counts_by_type|get_item:value %}
                                                {{ count|default:0 }} evento{{ count|pluralize }}
                                            {% endwith %}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Quick Date Filters -->
                            <div class="mb-3">
                                <fieldset>
                                    <legend class="form-label fw-semibold">Período</legend>
                                    <div class="btn-group-vertical d-grid gap-1" role="radiogroup" aria-label="Selecionar período">
                                        <input type="radio" class="btn-check" name="quick_date" value="" id="mobile_all_time"
                                               {% if not current_filters.quick_date %}checked{% endif %}>
                                        <label class="btn btn-outline-secondary btn-sm" for="mobile_all_time">Todos</label>
                                        
                                        <input type="radio" class="btn-check" name="quick_date" value="24h" id="mobile_last_24h"
                                               {% if current_filters.quick_date == '24h' %}checked{% endif %}>
                                        <label class="btn btn-outline-secondary btn-sm" for="mobile_last_24h">Últimas 24h</label>
                                        
                                        <input type="radio" class="btn-check" name="quick_date" value="7d" id="mobile_last_7d"
                                               {% if current_filters.quick_date == '7d' %}checked{% endif %}>
                                        <label class="btn btn-outline-secondary btn-sm" for="mobile_last_7d">Últimos 7 dias</label>
                                        
                                        <input type="radio" class="btn-check" name="quick_date" value="30d" id="mobile_last_30d"
                                               {% if current_filters.quick_date == '30d' %}checked{% endif %}>
                                        <label class="btn btn-outline-secondary btn-sm" for="mobile_last_30d">Últimos 30 dias</label>
                                    </div>
                                </fieldset>
                            </div>

                            <!-- Custom Date Range -->
                            <div class="mb-3">
                                <fieldset>
                                    <legend class="form-label fw-semibold">Período Personalizado</legend>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label for="mobile_date_from" class="visually-hidden">Data inicial</label>
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="mobile_date_from" name="date_from" 
                                                   value="{{ current_filters.date_from }}"
                                                   aria-label="Data inicial do período">
                                        </div>
                                        <div class="col-6">
                                            <label for="mobile_date_to" class="visually-hidden">Data final</label>
                                            <input type="date" class="form-control form-control-sm" 
                                                   id="mobile_date_to" name="date_to" 
                                                   value="{{ current_filters.date_to }}"
                                                   aria-label="Data final do período">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>

                            <!-- Creator Filter -->
                            {% if available_creators %}
                            <div class="mb-3">
                                <label for="mobile_creator" class="form-label fw-semibold">Criado por</label>
                                <select name="creator" id="mobile_creator" class="form-select form-select-sm" 
                                        aria-label="Filtrar eventos por profissional">
                                    <option value="">Todos os profissionais</option>
                                    {% for creator in available_creators %}
                                        <option value="{{ creator.id }}" 
                                                {% if creator.id|stringformat:"s" == current_filters.creator %}selected{% endif %}>
                                            {{ creator.first_name }} {{ creator.last_name }}
                                            {% if creator.profession %} ({{ creator.profession }}){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Filter Actions -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-medical-primary btn-sm"
                                        aria-label="Aplicar filtros selecionados">
                                    <i class="bi bi-search me-1" aria-hidden="true"></i>
                                    Aplicar Filtros
                                </button>
                                <a href="{% url 'apps.patients:patient_events_timeline' patient.pk %}" 
                                   class="btn btn-outline-secondary btn-sm"
                                   aria-label="Remover todos os filtros">
                                    <i class="bi bi-arrow-counterclockwise me-1" aria-hidden="true"></i>
                                    Limpar Filtros
                                </a>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>

        <!-- Desktop Filters Panel (hidden on mobile) -->
        <div class="col-lg-3 mb-4 d-none d-lg-block">
            <div class="filter-panel p-3">
                <h2 class="text-medical-primary mb-3 h5">
                    <i class="bi bi-funnel me-2" aria-hidden="true"></i>
                    Filtros
                </h2>
                
                <form method="get" id="timeline-filters" role="search" aria-label="Filtros da timeline">
                    <fieldset>
                        <legend class="visually-hidden">Filtros de eventos</legend>
                        
                        <!-- Event Type Filter -->
                        <div class="mb-3" role="group" aria-labelledby="event-types-label">
                            <label id="event-types-label" class="form-label fw-semibold">Tipos de Evento</label>
                            {% for value, label in event_type_choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="types" value="{{ value }}" id="type_{{ value }}"
                                           {% if value|stringformat:"s" in current_filters.types %}checked{% endif %}
                                           aria-describedby="type-{{ value }}-desc">
                                    <label class="form-check-label" for="type_{{ value }}">
                                        {{ label }}
                                    </label>
                                    <span id="type-{{ value }}-desc" class="visually-hidden">
                                        {% with count=event_counts_by_type|get_item:value %}
                                            {{ count|default:0 }} evento{{ count|pluralize }}
                                        {% endwith %}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Quick Date Filters -->
                        <div class="mb-3">
                            <fieldset>
                                <legend class="form-label fw-semibold">Período</legend>
                                <div class="btn-group-vertical d-grid gap-1" role="radiogroup" aria-label="Selecionar período">
                                    <input type="radio" class="btn-check" name="quick_date" value="" id="all_time"
                                           {% if not current_filters.quick_date %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="all_time">Todos</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="24h" id="last_24h"
                                           {% if current_filters.quick_date == '24h' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_24h">Últimas 24h</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="7d" id="last_7d"
                                           {% if current_filters.quick_date == '7d' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_7d">Últimos 7 dias</label>
                                    
                                    <input type="radio" class="btn-check" name="quick_date" value="30d" id="last_30d"
                                           {% if current_filters.quick_date == '30d' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary btn-sm" for="last_30d">Últimos 30 dias</label>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Custom Date Range -->
                        <div class="mb-3">
                            <fieldset>
                                <legend class="form-label fw-semibold">Período Personalizado</legend>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label for="date_from" class="visually-hidden">Data inicial</label>
                                        <input type="date" class="form-control form-control-sm" 
                                               id="date_from" name="date_from" 
                                               value="{{ current_filters.date_from }}"
                                               aria-label="Data inicial do período">
                                    </div>
                                    <div class="col-6">
                                        <label for="date_to" class="visually-hidden">Data final</label>
                                        <input type="date" class="form-control form-control-sm" 
                                               id="date_to" name="date_to" 
                                               value="{{ current_filters.date_to }}"
                                               aria-label="Data final do período">
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Creator Filter -->
                        {% if available_creators %}
                        <div class="mb-3">
                            <label for="creator" class="form-label fw-semibold">Criado por</label>
                            <select name="creator" id="creator" class="form-select form-select-sm" 
                                    aria-label="Filtrar eventos por profissional">
                                <option value="">Todos os profissionais</option>
                                {% for creator in available_creators %}
                                    <option value="{{ creator.id }}" 
                                            {% if creator.id|stringformat:"s" == current_filters.creator %}selected{% endif %}>
                                        {{ creator.first_name }} {{ creator.last_name }}
                                        {% if creator.profession %} ({{ creator.profession }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <!-- Filter Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-medical-primary btn-sm"
                                    aria-label="Aplicar filtros selecionados">
                                <i class="bi bi-search me-1" aria-hidden="true"></i>
                                Aplicar Filtros
                            </button>
                            <a href="{% url 'apps.patients:patient_events_timeline' patient.pk %}" 
                               class="btn btn-outline-secondary btn-sm"
                               aria-label="Remover todos os filtros">
                                <i class="bi bi-arrow-counterclockwise me-1" aria-hidden="true"></i>
                                Limpar Filtros
                            </a>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>

        <!-- Timeline Content -->
        <div class="col-12 col-lg-9">
            <div class="timeline-container w-100">
                {% if events_with_permissions %}
                    <!-- Events Timeline -->
                    <div id="timeline-content" class="timeline-events" role="feed" 
                         aria-label="Lista de eventos médicos" aria-live="polite">
                         
                        {% for event_data in events_with_permissions %}
                            {% with event=event_data.event %}
                                {% comment %}
                                Use appropriate event card template based on event type
                                HistoryAndPhysical events (event_type=0) get the specialized template with duplicate button
                                DailyNote events (event_type=1) get the specialized template with duplicate button
                                SimpleNote events (event_type=2) get the specialized template with duplicate button
                                Photo events (event_type=3) get the specialized template with photo display and modal
                                Prescription events (event_type=7) get the specialized template with medication summary
                                PhotoSeries events (event_type=9) get the specialized template with photo series display
                                VideoClip events (event_type=10) get the specialized template with video player
                                All other events use the default template
                                {% endcomment %}
                                {% if event.event_type == 0 %}
                                    {% include "events/partials/event_card_historyandphysical.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 1 %}
                                    {% include "events/partials/event_card_dailynote.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 2 %}
                                    {% include "events/partials/event_card_simplenote.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 3 %}
                                    {% include "events/partials/event_card_photo.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 7 %}
                                    {% include "events/partials/event_card_prescription.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 9 %}
                                    {% include "events/partials/event_card_photoseries.html" with event=event event_data=event_data %}
                                {% elif event.event_type == 10 %}
                                    {% include "events/partials/event_card_videoclip.html" with event=event event_data=event_data %}
                                {% else %}
                                    {% include "events/partials/event_card_default.html" with event=event event_data=event_data %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                        <nav aria-label="Timeline pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                            
                            <!-- Pagination Info -->
                            <div class="text-center text-muted mt-2">
                                <small>
                                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    ({{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} eventos)
                                </small>
                            </div>
                        </nav>
                    {% endif %}

                {% else %}
                    <!-- Empty State -->
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-clock-history text-muted" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-muted mb-3">Nenhum evento encontrado</h4>
                        {% if current_filters.types or current_filters.quick_date or current_filters.date_from or current_filters.date_to or current_filters.creator %}
                            <p class="text-muted mb-3">
                                Nenhum evento corresponde aos filtros selecionados.
                            </p>
                            <a href="{% url 'apps.patients:patient_events_timeline' patient.pk %}" 
                               class="btn btn-outline-medical-primary">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                Limpar Filtros
                            </a>
                        {% else %}
                            <p class="text-muted mb-3">
                                Este paciente ainda não possui eventos registrados.
                            </p>
                            <a href="{% url 'events:patient_events_list' patient.pk %}" 
                               class="btn btn-medical-primary">
                                <i class="bi bi-plus-circle me-2"></i>
                                Criar Primeiro Evento
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Print header (hidden by default, shown only when printing) -->
<div class="print-header d-none">
    <h1>Timeline de Eventos - {{ patient.name }}</h1>
    <p>Data de impressão: {% now "d/m/Y H:i" %}</p>
    <hr>
</div>

<!-- Photo Modal for viewing photos in full size -->
{% include "mediafiles/partials/photo_modal.html" %}

<!-- Photo Lightbox Modal for PhotoSeries -->
{% include "mediafiles/partials/photo_lightbox.html" %}

</div>
{% endblock %}

{% block page_specific_scripts %}
<!-- Load mediafiles bundles for timeline functionality -->
<script src="{% static 'mediafiles-bundle.js' %}"></script>
<!-- PDF Download functionality for prescription event cards -->
<script src="{% static 'js/pdf-download.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize mediafiles functionality for timeline
    if (typeof MediaFiles !== 'undefined') {
        MediaFiles.init();
    }
    
    // PhotoSeries timeline functionality
    
    function initializeTimelinePhotoSeries() {
        const photoSeriesThumbnails = document.querySelectorAll('.photoseries-thumbnail-wrapper');
        
        photoSeriesThumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function(e) {
                // Prevent click if it's on an action button
                if (e.target.closest('.btn') || e.target.closest('.dropdown')) {
                    return;
                }
                
                // Check if this thumbnail should trigger lightbox
                const trigger = this.getAttribute('data-trigger');
                const galleryId = this.getAttribute('data-gallery-id');
                
                if (trigger === 'lightbox' && galleryId && window.PhotoLightbox && window.PhotoLightbox.open) {
                    e.preventDefault();
                    try {
                        PhotoLightbox.open(0, galleryId);
                        return;
                    } catch (error) {
                        // Fall through to detail page navigation
                    }
                }
                
                // Fallback to detail page navigation
                const timelineCard = this.closest('.timeline-card');
                if (timelineCard) {
                    const ariaLabel = timelineCard.getAttribute('aria-labelledby');
                    if (ariaLabel) {
                        const eventId = ariaLabel.replace('event-', '').replace('-title', '');
                        const detailUrl = `/mediafiles/photo-series/${eventId}/`;
                        window.location.href = detailUrl;
                    }
                }
            });
            
            // Add keyboard accessibility
            if (!thumbnail.hasAttribute('tabindex')) {
                thumbnail.setAttribute('tabindex', '0');
            }
            if (!thumbnail.hasAttribute('role')) {
                thumbnail.setAttribute('role', 'button');
            }
            if (!thumbnail.hasAttribute('aria-label')) {
                thumbnail.setAttribute('aria-label', 'Visualizar série de fotos');
            }
            
            thumbnail.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    }
    
    initializeTimelinePhotoSeries();
});
</script>
{% endblock page_specific_scripts %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize both desktop and mobile filter forms
    const desktopFilterForm = document.getElementById('timeline-filters');
    const mobileFilterForm = document.getElementById('mobile-timeline-filters');
    const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
    const mobileFiltersCollapse = document.getElementById('mobile-filters');
    
    // Function to setup form interactions
    function setupFormInteractions(form) {
        if (!form) return;
        
        const filterInputs = form.querySelectorAll('input[type="checkbox"], input[type="radio"], select');
        
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Debounce for better UX
                setTimeout(() => {
                    form.submit();
                }, 100);
            });
        });
        
        // Date inputs submit on change (not immediate for better UX)
        const dateInputs = form.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Clear quick date selection when custom dates are used
                const quickDateInputs = form.querySelectorAll('input[name="quick_date"]');
                quickDateInputs.forEach(radio => {
                    if (radio.value !== '') {
                        radio.checked = false;
                    }
                });
            });
        });
        
        // Clear custom dates when quick date is selected
        const quickDateInputs = form.querySelectorAll('input[name="quick_date"]');
        quickDateInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.value !== '') {
                    const dateInputs = form.querySelectorAll('input[type="date"]');
                    dateInputs.forEach(dateInput => {
                        dateInput.value = '';
                    });
                }
            });
        });
    }
    
    // Setup both forms
    setupFormInteractions(desktopFilterForm);
    setupFormInteractions(mobileFilterForm);
    
    // Mobile-specific enhancements
    if (mobileFilterToggle && mobileFiltersCollapse) {
        // Update toggle button icon and text based on collapse state
        mobileFiltersCollapse.addEventListener('show.bs.collapse', function() {
            const icon = mobileFilterToggle.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-chevron-up';
            }
            mobileFilterToggle.setAttribute('aria-expanded', 'true');
        });
        
        mobileFiltersCollapse.addEventListener('hide.bs.collapse', function() {
            const icon = mobileFilterToggle.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-chevron-down';
            }
            mobileFilterToggle.setAttribute('aria-expanded', 'false');
        });
        
        // Auto-collapse mobile filters after form submission
        if (mobileFilterForm) {
            mobileFilterForm.addEventListener('submit', function() {
                // Small delay to allow form submission, then collapse
                setTimeout(() => {
                    const collapse = new bootstrap.Collapse(mobileFiltersCollapse, {
                        hide: true
                    });
                }, 150);
            });
        }
    }
});
</script>
{% endblock %}
