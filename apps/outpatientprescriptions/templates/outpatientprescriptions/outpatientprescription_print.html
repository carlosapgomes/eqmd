{% load static %}
{% load hospital_tags %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receita M√©dica - {{ prescription.patient.name }} - {{ prescription.prescription_date|date:"d/m/Y" }}</title>
    <link rel="stylesheet" href="{% static 'outpatientprescriptions/css/prescription_print.css' %}">
    <style>
        /* Page-specific customizations */
        .prescription-page-items {
            min-height: 400px;
        }
    </style>
</head>
<body>
    <button class="print-button no-print" onclick="window.print()">
        üñ®Ô∏è Imprimir
    </button>
    
    <div class="header">
        <div class="hospital-branding">
            {% hospital_logo as logo_url %}
            {% if logo_url %}
                <img src="{{ logo_url }}" alt="Logo do Hospital" class="hospital-logo">
            {% endif %}
            <div>
                <div class="hospital-name">{% hospital_name %}</div>
                <div class="hospital-details">
                    {% hospital_address %} | {% hospital_phone %} | {% hospital_email %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="patient-info">
        <div class="patient-info-row">
            <div class="patient-info-cell" style="width: 40%;">
                <div class="patient-info-label">Nome do Paciente:</div>
                <div>{{ prescription.patient.name }}</div>
            </div>
            <div class="patient-info-cell" style="width: 30%;">
                <div class="patient-info-label">CPF:</div>
                <div>{{ prescription.patient.fiscal_number|default:"‚Äî" }}</div>
            </div>
            <div class="patient-info-cell" style="width: 30%;">
                <div class="patient-info-label">Cart√£o SUS:</div>
                <div>{{ prescription.patient.health_card_number|default:"‚Äî" }}</div>
            </div>
        </div>
        <div class="patient-info-row">
            <div class="patient-info-cell">
                <div class="patient-info-label">Data de Nascimento:</div>
                <div>{{ prescription.patient.birth_date|date:"d/m/Y"|default:"‚Äî" }}</div>
            </div>
            <div class="patient-info-cell">
                <div class="patient-info-label">Data da Receita:</div>
                <div>{{ prescription.prescription_date|date:"d/m/Y" }}</div>
            </div>
            <div class="patient-info-cell">
                <div class="patient-info-label">Status:</div>
                <div>{{ prescription.get_status_display|default:"‚Äî" }}</div>
            </div>
        </div>
    </div>
    
    <div class="prescription-content">
        
        {% comment "Pagination logic for prescription items" %}
        {% regroup prescription_items|slice:":8" by forloop.counter0|floordiv:8 as pages %}
        {% endcomment %}
        
        <div class="prescription-items">
            {% for item in prescription_items %}
            {% comment "Start new page every 8 items for better pagination" %}
            {% endcomment %}
            {% if forloop.counter0|divisibleby:8 and not forloop.first %}
                </div>
                
                <div class="page-break"></div>
                
                <div class="continuation-header">
                    <strong>{{ prescription.patient.name }}</strong> - Continua√ß√£o da Receita M√©dica<br>
                    Data: {{ prescription.prescription_date|date:"d/m/Y" }} - Dr(a). {{ prescription.created_by.get_full_name|default:prescription.created_by.username }}
                </div>
                
                <div class="prescription-items">
            {% endif %}
            
            <div class="prescription-item">
                <div class="item-order">{{ forloop.counter }}.</div>
                <div class="drug-name">{{ item.drug_name }}</div>
                {% if item.presentation %}
                <div class="drug-presentation">{{ item.presentation }}</div>
                {% endif %}
                {% if item.usage_instructions %}
                <div class="usage-instructions"><strong>Uso:</strong> {{ item.usage_instructions }}</div>
                {% endif %}
                {% if item.quantity %}
                <div class="quantity"><strong>Quantidade:</strong> {{ item.quantity }}</div>
                {% endif %}
            </div>
            {% empty %}
            <div class="prescription-item">
                <div>Nenhum medicamento prescrito.</div>
            </div>
            {% endfor %}
        </div>
        
        {% if prescription.instructions %}
        <div class="instructions-section">
            <div class="instructions-header">INSTRU√á√ïES GERAIS:</div>
            <div class="instructions-text">{{ prescription.instructions }}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Page signature that will appear on every page -->
    <div class="page-signature">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div><strong>Data:</strong> ____/____/________</div>
            <div><strong>Local:</strong> _____________________________</div>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <div>_________________________________________________</div>
            <div style="margin-top: 5px;">
                <strong>{{ prescription.created_by.get_full_name|default:prescription.created_by.username }}</strong><br>
                {{ prescription.created_by.profession|default:"M√©dico" }} - CRM: _______________<br>
                <strong>Assinatura e Carimbo</strong>
            </div>
        </div>
    </div>
    
    <div class="page-footer">
        <div class="hospital-footer-info">
            {% hospital_name %} - {% hospital_address %}<br>
            Tel: {% hospital_phone %} | Email: {% hospital_email %}
        </div>
        <div style="margin-top: 5px; font-size: 9px;">
            Esta √© uma receita m√©dica v√°lida conforme regulamenta√ß√£o vigente.
        </div>
        <div class="sistema-credit">
            criado por EquipeMed
        </div>
    </div>
    
    <script>
        // Auto-focus print button for keyboard navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-print when accessed with print parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('print') === 'true') {
                window.print();
            }
        });
    </script>
</body>
</html>