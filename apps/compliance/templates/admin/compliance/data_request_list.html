{% extends "base.html" %}
{% load static %}

{% block title %}Solicitações LGPD - Admin{% endblock %}

{% block extra_css %}
<style>
  .admin-header {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 1.5rem 0;
  }
  
  .status-badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
  
  .overdue {
    background-color: #dc3545 !important;
  }
  
  .due-soon {
    background-color: #fd7e14 !important;
  }
  
  .request-card {
    border-left: 4px solid #e74c3c;
    transition: transform 0.2s;
  }
  
  .request-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
  <div class="container">
    <div class="row">
      <div class="col-md-10">
        <h1>
          <i class="bi bi-shield-check me-3"></i>Solicitações LGPD
        </h1>
        <p class="lead">
          Gerenciamento de solicitações de direitos dos titulares
        </p>
      </div>
      <div class="col-md-2 text-end">
        <a href="{% url 'compliance:data_request_create' %}" class="btn btn-light">
          <i class="bi bi-plus-circle me-2"></i>Nova Solicitação
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6><i class="bi bi-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
          <form method="get">
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="">Todos</option>
                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendente</option>
                <option value="under_review" {% if request.GET.status == 'under_review' %}selected{% endif %}>Em análise</option>
                <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Aprovado</option>
                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Concluído</option>
                <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejeitado</option>
              </select>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="overdue" value="true" 
                       {% if request.GET.overdue == 'true' %}checked{% endif %}>
                <label class="form-check-label">
                  Apenas em atraso
                </label>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="bi bi-search me-1"></i>Filtrar
            </button>
            <a href="{% url 'compliance:data_request_list' %}" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-x-circle me-1"></i>Limpar
            </a>
          </form>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
          <h6><i class="bi bi-info-circle me-2"></i>Resumo</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Total:</span>
            <span class="badge bg-primary">{{ requests|length }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-9">
      {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
      {% endif %}

      {% if requests %}
        {% for data_request in requests %}
        <div class="card request-card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h6 class="card-title">
                  <a href="{% url 'compliance:data_request_detail' data_request.request_id %}" class="text-decoration-none">
                    {{ data_request.request_id }}
                  </a>
                  <span class="badge status-badge ms-2 
                    {% if data_request.status == 'pending' %}bg-warning
                    {% elif data_request.status == 'completed' %}bg-success
                    {% elif data_request.status == 'rejected' %}bg-danger
                    {% elif data_request.status == 'approved' %}bg-info
                    {% else %}bg-secondary{% endif %}
                    {% if data_request.is_overdue %}overdue{% endif %}">
                    {{ data_request.get_status_display }}
                  </span>
                </h6>
                
                <p class="card-text">
                  <strong>Tipo:</strong> {{ data_request.get_request_type_display }}<br>
                  <strong>Solicitante:</strong> {{ data_request.requester_name }}<br>
                  <strong>Paciente:</strong> {{ data_request.patient_name_provided }}<br>
                  <strong>Email:</strong> {{ data_request.requester_email }}
                </p>
                
                <small class="text-muted">
                  {{ data_request.description|truncatewords:15 }}
                </small>
              </div>
              
              <div class="col-md-4 text-end">
                <div class="mb-2">
                  <small class="text-muted">Solicitado em:</small><br>
                  <strong>{{ data_request.requested_at|date:"d/m/Y H:i" }}</strong>
                </div>
                
                <div class="mb-2">
                  <small class="text-muted">Prazo:</small><br>
                  <strong class="{% if data_request.is_overdue %}text-danger{% elif data_request.days_remaining <= 3 %}text-warning{% endif %}">
                    {% if data_request.is_overdue %}
                      {{ data_request.days_remaining|add:"-1" }} dias em atraso
                    {% else %}
                      {{ data_request.days_remaining }} dias restantes
                    {% endif %}
                  </strong>
                </div>
                
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{% url 'compliance:data_request_detail' data_request.request_id %}" 
                     class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{% url 'compliance:data_request_update' data_request.request_id %}" 
                     class="btn btn-outline-secondary">
                    <i class="bi bi-pencil"></i>
                  </a>
                  {% if data_request.status == 'approved' and data_request.patient %}
                  <a href="{% url 'compliance:patient_data_export' data_request.request_id %}" 
                     class="btn btn-outline-success">
                    <i class="bi bi-download"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        
        {% if is_paginated %}
        <nav aria-label="Paginação">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1">Primeira</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
              </li>
            {% endif %}
            
            <li class="page-item active">
              <span class="page-link">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
              </span>
            </li>
            
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Próxima</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
        
      {% else %}
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="mt-3">Nenhuma solicitação encontrada</h5>
            <p class="text-muted">Não há solicitações LGPD registradas no sistema.</p>
            <a href="{% url 'compliance:data_request_create' %}" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>Criar primeira solicitação
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}