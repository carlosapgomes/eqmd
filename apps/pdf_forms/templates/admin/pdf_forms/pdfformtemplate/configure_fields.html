{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.pdf-configurator {
    display: flex;
    height: calc(100vh - 120px);
    gap: 20px;
}

.pdf-preview-container {
    flex: 1;
    border: 1px solid #ddd;
    background: #f9f9f9;
    position: relative;
    overflow: auto;
}

.pdf-canvas-container {
    position: relative;
    display: inline-block;
    margin: 20px;
}

.pdf-canvas {
    border: 1px solid #ccc;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background: white;
    cursor: crosshair;
}

.field-overlay {
    position: absolute;
    border: 2px solid #007cba;
    background: rgba(0, 124, 186, 0.1);
    cursor: move;
    min-width: 20px;
    min-height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #007cba;
    font-weight: bold;
}

.field-overlay .resize-handle {
    position: absolute;
    background: #007cba;
    cursor: nw-resize;
}

.field-overlay .resize-handle.right {
    right: -3px;
    top: 0;
    bottom: 0;
    width: 6px;
    cursor: e-resize;
}

.field-overlay .resize-handle.bottom {
    left: 0;
    right: 0;
    bottom: -3px;
    height: 6px;
    cursor: s-resize;
}

.field-overlay .resize-handle.corner {
    right: -3px;
    bottom: -3px;
    width: 6px;
    height: 6px;
    cursor: nw-resize;
}

.field-overlay:hover {
    background: rgba(0, 124, 186, 0.2);
    border-color: #005177;
}

.field-overlay.selected {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
}

.field-overlay.has-patient-mapping {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.field-overlay.has-patient-mapping .field-label::after {
    content: " üìã";
    font-size: 8px;
}

.field-item.has-patient-mapping {
    border-left: 3px solid #28a745;
}

.field-item.has-patient-mapping .field-type {
    background: #d4edda;
    color: #155724;
}

.patient-mapping-indicator {
    font-size: 10px;
    color: #28a745;
    font-weight: bold;
}

.field-overlay .field-label {
    pointer-events: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.properties-panel {
    width: 350px;
    border: 1px solid #ddd;
    background: white;
    padding: 20px;
    overflow-y: auto;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #007cba;
    box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    margin-right: 8px;
    margin-bottom: 8px;
}

.btn-primary {
    background-color: #007cba;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.toolbar {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.field-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.field-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.field-item:hover {
    background: #f8f9fa;
}

.field-item.selected {
    background: #e3f2fd;
    border-left: 3px solid #007cba;
}

.field-item .field-name {
    font-weight: bold;
    color: #333;
}

.field-item .field-type {
    font-size: 11px;
    color: #666;
    background: #f1f3f4;
    padding: 2px 6px;
    border-radius: 10px;
}

.coordinate-display {
    font-size: 11px;
    color: #666;
    margin-top: 10px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.choices-list {
    max-height: 100px;
    overflow-y: auto;
}

.choice-item {
    display: flex;
    margin-bottom: 5px;
}

.choice-item input {
    flex: 1;
    margin-right: 5px;
}

.choice-item button {
    padding: 5px 8px;
    font-size: 11px;
}

.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px;
}

.zoom-controls button {
    background: none;
    border: none;
    padding: 5px 8px;
    cursor: pointer;
    font-size: 14px;
}

.zoom-controls button:hover {
    background: #f0f0f0;
}

/* Section Management Styles */
#section-management {
    border-top: 1px solid #ddd;
    padding-top: 15px;
}

.section-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 8px;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.section-item:hover {
    background: #e9ecef;
    border-color: #007cba;
}

.section-item.dragging {
    opacity: 0.6;
    transform: scale(0.98);
}

.section-item.reorder-mode {
    cursor: move;
}

.section-info {
    flex: 1;
    display: flex;
    align-items: center;
}

.section-drag-handle {
    display: none;
    cursor: move;
    color: #6c757d;
    margin-right: 8px;
    font-size: 14px;
}

.reorder-mode .section-drag-handle {
    display: inline-block;
}

.section-icon {
    margin-right: 8px;
    font-size: 16px;
    color: #007cba;
}

.section-name {
    font-weight: bold;
    color: #495057;
    margin-right: 8px;
}

.section-field-count {
    font-size: 11px;
    color: #6c757d;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 8px;
}

.section-actions {
    display: flex;
    gap: 5px;
}

.section-actions button {
    padding: 4px 8px;
    font-size: 11px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.section-actions .btn-edit {
    background: #17a2b8;
    color: white;
}

.section-actions .btn-edit:hover {
    background: #138496;
}

.section-actions .btn-delete {
    background: #dc3545;
    color: white;
}

.section-actions .btn-delete:hover {
    background: #c82333;
}

.section-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.section-controls .btn-sm {
    font-size: 12px;
    padding: 6px 12px;
}

/* Field List Section Grouping */
.field-list-section {
    margin-bottom: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}

.field-list-section-header {
    background: #f1f3f4;
    padding: 8px 12px;
    font-weight: bold;
    color: #495057;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.field-list-section-icon {
    margin-right: 6px;
    color: #007cba;
}

.field-list-section .field-item {
    margin: 0;
    border: none;
    border-left: 3px solid #007cba;
    border-radius: 0;
}

.field-item.has-section-assignment {
    border-left: 3px solid #28a745;
}

.field-item.no-section {
    border-left: 3px solid #6c757d;
}

.field-item.has-section-assignment .field-type {
    background: #d4edda;
    color: #155724;
}

/* Modal enhancements */
.modal-dialog .form-text {
    font-size: 11px;
    color: #6c757d;
    margin-top: 4px;
}

.form-preview-section {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 10px;
    overflow: hidden;
}

.form-preview-section-header {
    background: #f8f9fa;
    padding: 12px 15px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 500;
    display: flex;
    align-items: center;
}

.form-preview-section-header i {
    margin-right: 8px;
    color: #007cba;
}

.form-preview-section-body {
    padding: 15px;
}

.form-preview-field {
    margin-bottom: 10px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 3px;
    font-size: 12px;
    border-left: 3px solid #007cba;
}

.form-preview-field-name {
    font-weight: bold;
    color: #495057;
}

.form-preview-field-type {
    color: #6c757d;
    font-size: 10px;
    text-transform: uppercase;
}

/* Modal Styles - Vanilla CSS implementation */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1055;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
    outline: 0;
    display: none; /* Hidden by default */
}

.modal.show {
    display: block !important;
}

.modal-dialog {
    position: relative;
    width: auto;
    max-width: calc(100% - 1rem);
    margin: 0.5rem;
    pointer-events: none;
}

.modal-dialog.modal-lg {
    max-width: 800px;
}

@media (min-width: 576px) {
    .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
    }
    
    .modal-dialog.modal-lg {
        max-width: min(800px, calc(100vw - 3rem));
    }
}

.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    pointer-events: auto;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 0.3rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.5);
    outline: 0;
}

.modal-header {
    display: flex;
    flex-shrink: 0;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1rem;
    border-bottom: 1px solid #dee2e6;
    border-top-left-radius: calc(0.3rem - 1px);
    border-top-right-radius: calc(0.3rem - 1px);
}

.modal-title {
    margin-bottom: 0;
    line-height: 1.5;
    font-size: 1.25rem;
    font-weight: 500;
}

.modal-body {
    position: relative;
    flex: 1 1 auto;
    padding: 1rem;
    overflow-x: hidden;
}

.modal-body * {
    box-sizing: border-box;
}

.modal-footer {
    display: flex;
    flex-wrap: wrap;
    flex-shrink: 0;
    align-items: center;
    justify-content: flex-end;
    padding: 0.75rem;
    border-top: 1px solid #dee2e6;
    border-bottom-right-radius: calc(0.3rem - 1px);
    border-bottom-left-radius: calc(0.3rem - 1px);
}

.modal-footer > * {
    margin: 0.25rem;
}

/* Modal backdrop */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100vw;
    height: 100vh;
    background-color: #000;
    opacity: 0.5;
}

/* Close button */
.btn-close {
    box-sizing: content-box;
    width: 1em;
    height: 1em;
    padding: 0.25em 0.25em;
    color: #000;
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='m.235.757 14.747 14.746L11.939 12.45 4.53 5.041 11.939 12.45 15.468 15.979 14.711 16.736 7.302 9.327 14.711 16.736z'/%3e%3c/svg%3e") center/1em auto no-repeat;
    border: 0;
    border-radius: 0.25rem;
    opacity: 0.5;
}

.btn-close:hover {
    color: #000;
    text-decoration: none;
    opacity: 0.75;
}

.btn-close:focus {
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    opacity: 1;
}

/* Form styles within modals */
.modal .form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.modal .form-control {
    display: block;
    width: 100%;
    max-width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    background-color: #fff;
    background-image: none;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    box-sizing: border-box;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.modal .form-control:focus {
    color: #212529;
    background-color: #fff;
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.modal .form-text {
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #6c757d;
}

.modal .form-check-input {
    width: 1em;
    height: 1em;
    margin-top: 0.25em;
    vertical-align: top;
    background-color: #fff;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid rgba(0, 0, 0, 0.25);
    border-radius: 0.25em;
}

.modal .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
}

/* Additional form controls */
.modal select.form-control,
.modal textarea.form-control {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.modal textarea.form-control {
    resize: vertical;
    min-height: 2.5rem;
}

.modal .mb-3 {
    margin-bottom: 1rem !important;
}

/* Ensure all inputs respect container boundaries */
.modal input,
.modal select,
.modal textarea {
    max-width: 100%;
    box-sizing: border-box;
}

/* Form group styling to prevent overflow */
.modal-body .form-group,
.modal-body .mb-3 {
    width: 100%;
    overflow: hidden;
}

/* Button styles in modals */
.modal .btn {
    display: inline-block;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: center;
    text-decoration: none;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.modal .btn-primary {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.modal .btn-primary:hover {
    color: #fff;
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.modal .btn-secondary {
    color: #fff;
    background-color: #6c757d;
    border-color: #6c757d;
}

.modal .btn-secondary:hover {
    color: #fff;
    background-color: #5c636a;
    border-color: #565e64;
}

/* Body modifications when modal is open */
body.modal-open {
    overflow: hidden;
    padding-right: 0px; /* Prevent scrollbar shift */
}
</style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="toolbar">
    <button class="btn btn-primary" id="add-field-btn">Add Field</button>
    <button class="btn btn-success" id="save-fields-btn">Save Configuration</button>
    <button class="btn btn-secondary" onclick="window.history.back()">Back to Template</button>
    
    <div style="float: right;">
        <label>
            <input type="checkbox" id="show-grid" checked> Show Grid
        </label>
        <label style="margin-left: 15px;">
            <input type="checkbox" id="snap-to-grid" checked> Snap to Grid
        </label>
    </div>
</div>

<div id="error-container"></div>
<div id="success-container"></div>

{% if not template.is_configured %}
<div class="alert alert-info" style="margin: 15px 0; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; color: #0d47a1;">
    <strong>üéØ Getting Started:</strong> This template doesn't have field configuration yet. 
    <br>‚Ä¢ <strong>Option 1:</strong> Click "Add Field" and drag-and-drop on the PDF preview below
    <br>‚Ä¢ <strong>Option 2:</strong> Use the "Manual JSON Editor" if PDF preview is not available
    <br>‚Ä¢ PDFs are generated on-the-fly from form data - no files are stored permanently
    <br>‚Ä¢ Remember to click "Save Configuration" when finished!
</div>
{% endif %}

<div class="pdf-configurator">
    <div class="pdf-preview-container">
        <div id="loading-message" class="loading">
            Loading PDF preview...
        </div>
        <div class="pdf-canvas-container" id="pdf-container" style="display: none;">
            <canvas class="pdf-canvas" id="pdf-canvas"></canvas>
            <div class="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <button id="zoom-fit">Fit</button>
            </div>
        </div>
    </div>
    
    <div class="properties-panel">
        <h3>Fields</h3>
        <div class="field-list" id="field-list">
            <div style="padding: 20px; text-align: center; color: #666;">
                No fields configured
            </div>
        </div>
        
        <!-- Section Management Panel -->
        <div id="section-management" class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Form Sections</h4>
                <button type="button" class="btn btn-outline-success btn-sm" id="add-section-btn">
                    <i class="bi bi-plus"></i> Add Section
                </button>
            </div>
            <div id="sections-list" class="mb-3">
                <div style="padding: 15px; text-align: center; color: #666; font-style: italic;">
                    No sections configured
                </div>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="reorder-sections-btn">
                    <i class="bi bi-arrow-up-down"></i> Reorder Sections
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" id="preview-sections-btn">
                    <i class="bi bi-eye"></i> Preview Form
                </button>
            </div>
        </div>
        
        <div id="manual-json-editor" style="display: none; margin-top: 20px;">
            <h3>Manual JSON Editor</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                Edit field configuration directly in JSON format. Each field requires: type, label, x, y, width, height (in cm).
                <br><strong>Note:</strong> Only form data is stored - PDFs are generated dynamically when downloaded.
            </p>
            <textarea id="json-editor" style="width: 100%; height: 200px; font-family: monospace; font-size: 12px;">
{
  "example_field": {
    "type": "text",
    "label": "Example Field",
    "x": 2.0,
    "y": 3.0, 
    "width": 6.0,
    "height": 0.7,
    "font_size": 12,
    "required": true
  }
}
            </textarea>
            <div style="margin-top: 10px;">
                <button class="btn btn-success" onclick="loadFromJSON()">
                    <i class="bi bi-upload"></i> Load from JSON
                </button>
                <button class="btn btn-secondary" onclick="exportToJSON()">
                    <i class="bi bi-download"></i> Export Current Fields
                </button>
            </div>
        </div>
        
        <div id="field-properties" style="display: none;">
            <h3>Field Properties</h3>
            <form id="field-form">
                <div class="form-group">
                    <label for="field-name">Field Name</label>
                    <input type="text" id="field-name" name="name" placeholder="e.g., patient_name">
                </div>
                
                <div class="form-group">
                    <label for="field-label">Label</label>
                    <input type="text" id="field-label" name="label" placeholder="e.g., Patient Name">
                </div>
                
                <div class="form-group">
                    <label for="field-type">Type</label>
                    <select id="field-type" name="type">
                        {% for field_type in field_types %}
                        <option value="{{ field_type.value }}">{{ field_type.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="field-required" name="required"> Required
                    </label>
                </div>
                
                <!-- Section Assignment -->
                <div class="form-group">
                    <label for="field-section">Section</label>
                    <select id="field-section" name="section" class="form-control">
                        <option value="">-- No Section --</option>
                        <!-- Dynamically populated with available sections -->
                    </select>
                    <small style="color: #666;">Assign this field to a form section for better organization</small>
                </div>
                
                <div class="form-group">
                    <label for="field-order">Order within Section</label>
                    <input type="number" id="field-order" name="field_order" class="form-control" min="1" placeholder="1">
                    <small style="color: #666;">Order of this field within its section (lower numbers appear first)</small>
                </div>
                
                <div class="form-group" id="max-length-group">
                    <label for="field-max-length">Max Length</label>
                    <input type="number" id="field-max-length" name="max_length" min="1">
                </div>
                
                <div class="form-group" id="choices-group" style="display: none;">
                    <label>Choices</label>
                    <div class="choices-list" id="choices-list"></div>
                    <button type="button" class="btn btn-secondary" id="add-choice-btn">Add Choice</button>
                </div>
                
                <div class="form-group">
                    <label for="field-auto-fill">Auto-Fill Data</label>
                    <select id="field-auto-fill" name="auto_fill_mapping">
                        {% regroup auto_fill_choices by optgroup as grouped_choices %}
                        {% for group in grouped_choices %}
                            {% if group.grouper %}
                                <optgroup label="{{ group.grouper }}">
                                    {% for option in group.list %}
                                    <option value="{{ option.value }}" data-type="{{ option.type }}">{{ option.label }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% else %}
                                {% for option in group.list %}
                                <option value="{{ option.value }}" data-type="{{ option.type }}">{{ option.label }}</option>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </select>
                    <small style="color: #666;">Automatically populate this field with patient or hospital data when form is opened</small>
                </div>
                
                <div class="form-group">
                    <label for="field-font-size">Font Size</label>
                    <input type="number" id="field-font-size" name="font_size" value="12" min="6" max="72">
                    <small style="color: #666;">Tip: Height auto-adjusts to font size</small>
                </div>
                
                <div class="form-group">
                    <label for="field-width">Width (cm)</label>
                    <input type="number" id="field-width" name="width" step="0.1" min="0.5">
                </div>
                
                <div class="form-group">
                    <label for="field-height">Height (cm)</label>
                    <input type="number" id="field-height" name="height" step="0.1" min="0.3">
                    <small style="color: #666;">Or resize by dragging field edges</small>
                </div>
                
                <div class="coordinate-display">
                    <div>Position: <span id="position-display">0, 0</span> cm</div>
                    <div>Size: <span id="size-display">0 √ó 0</span> cm</div>
                </div>
                
                <button type="button" class="btn btn-danger" id="delete-field-btn">Delete Field</button>
            </form>
        </div>
    </div>
</div>

<!-- Section Editor Modal -->
<div class="modal fade" id="sectionModal" tabindex="-1" aria-labelledby="sectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionModalLabel">Section Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="section-form">
                    <div class="mb-3">
                        <label for="section-key" class="form-label">Section Key</label>
                        <input type="text" class="form-control" id="section-key" required>
                        <div class="form-text">Unique identifier (e.g., patient_info). Only letters, numbers, and underscores allowed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="section-label" class="form-label">Section Label</label>
                        <input type="text" class="form-control" id="section-label" required>
                        <div class="form-text">Display name (e.g., Patient Information)</div>
                    </div>
                    <div class="mb-3">
                        <label for="section-description" class="form-label">Description</label>
                        <textarea class="form-control" id="section-description" rows="2" placeholder="Optional description..."></textarea>
                        <div class="form-text">Optional description shown below the section header</div>
                    </div>
                    <div class="mb-3">
                        <label for="section-icon" class="form-label">Icon</label>
                        <select class="form-control" id="section-icon">
                            <option value="">No Icon</option>
                            <option value="bi-person">üë§ Person</option>
                            <option value="bi-telephone">üìû Phone</option>
                            <option value="bi-journal-medical">üìã Medical Journal</option>
                            <option value="bi-clipboard-pulse">üè• Medical Clipboard</option>
                            <option value="bi-prescription2">üíä Prescription</option>
                            <option value="bi-hospital">üè• Hospital</option>
                            <option value="bi-exclamation-triangle">‚ö†Ô∏è Emergency</option>
                            <option value="bi-shield-check">üõ°Ô∏è Insurance</option>
                            <option value="bi-file-text">üìÑ Document</option>
                            <option value="bi-journal-text">üìù Notes</option>
                            <option value="bi-heart-pulse">üíì Vitals</option>
                            <option value="bi-clipboard-check">‚úÖ Diagnosis</option>
                            <option value="bi-capsule">üíä Treatment</option>
                            <option value="bi-box-arrow-right">‚ÜóÔ∏è Discharge</option>
                        </select>
                        <div class="form-text">Bootstrap icon to display next to the section name</div>
                    </div>
                    <div class="mb-3">
                        <label for="section-order" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="section-order" min="1" required>
                        <div class="form-text">Order in which this section appears (lower numbers first)</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="section-collapsed">
                            <label class="form-check-label" for="section-collapsed">
                                Start Collapsed
                            </label>
                            <div class="form-text">Section starts collapsed when form loads</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-section-btn">Save Section</button>
            </div>
        </div>
    </div>
</div>

<!-- Section Preview Modal -->
<div class="modal fade" id="sectionPreviewModal" tabindex="-1" aria-labelledby="sectionPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionPreviewModalLabel">Form Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="form-preview-content">
                    <div class="accordion" id="preview-accordion">
                        <!-- Preview content will be populated here by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let pdfCanvas = null;
let ctx = null;
let pdfImage = null;
let pdfScale = 1;
let fields = {};
let sections = {};
let selectedField = null;
let editingSectionKey = null;
let isReorderMode = false;
let isDragging = false;
let isResizing = false;
let resizeType = null; // 'right', 'bottom', 'corner'
let dragOffset = { x: 0, y: 0 };
let gridSize = 10; // pixels
let cmToPx = 1; // Will be calculated based on PDF size

// Initialize the configurator
document.addEventListener('DOMContentLoaded', function() {
    pdfCanvas = document.getElementById('pdf-canvas');
    ctx = pdfCanvas.getContext('2d');
    
    // Load existing fields
    loadExistingFields();
    
    // Load PDF preview
    loadPDFPreview();
    
    // Setup event listeners
    setupEventListeners();
});

function loadExistingFields() {
    try {
        const existingConfig = {{ current_fields_json|safe }};
        if (existingConfig && typeof existingConfig === 'object' && Object.keys(existingConfig).length > 0) {
            // Check if it's the new sectioned format
            if (existingConfig.sections && existingConfig.fields) {
                sections = existingConfig.sections || {};
                fields = existingConfig.fields || {};
            } else {
                // Legacy format - treat as fields only
                sections = {};
                fields = existingConfig;
            }
            updateFieldList();
            updateSectionsList();
            updateFieldSectionDropdown();
        }
    } catch (error) {
        console.warn('Error loading existing configuration:', error);
        fields = {};
        sections = {};
    }
}

function loadPDFPreview() {
    const templateId = '{{ template.id }}';
    const apiUrl = `../api/pdf-preview/`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPDFPreview(data);
            } else {
                showPDFPreviewError(data);
            }
        })
        .catch(error => {
            showError('Error loading PDF: ' + error.message);
            showManualJSONEditor();
        });
}

function showPDFPreviewError(data) {
    const loadingMessage = document.getElementById('loading-message');
    
    let errorHtml = `
        <div class="error-message" style="margin: 20px; padding: 20px;">
            <h3><i class="bi bi-exclamation-triangle"></i> PDF Preview Not Available</h3>
            <p><strong>Error:</strong> ${data.error}</p>
    `;
    
    if (data.solution) {
        errorHtml += `
            <div style="margin-top: 15px;">
                <strong>Solution:</strong>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-line;">${data.solution}</pre>
            </div>
        `;
    }
    
    if (data.alternative) {
        errorHtml += `
            <div style="margin-top: 15px;">
                <strong>Alternative:</strong> ${data.alternative}
            </div>
        `;
    }
    
    errorHtml += `
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="showManualJSONEditor()">
                    <i class="bi bi-code"></i> Use Manual JSON Editor
                </button>
                <button class="btn btn-secondary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Retry Preview
                </button>
            </div>
        </div>
    `;
    
    loadingMessage.innerHTML = errorHtml;
    
    // Also show manual JSON editor as fallback
    showManualJSONEditor();
}

function displayPDFPreview(data) {
    const img = new Image();
    img.onload = function() {
        pdfImage = img;
        
        // Calculate scale to fit in container
        const container = document.querySelector('.pdf-preview-container');
        const maxWidth = container.clientWidth - 60;
        const maxHeight = container.clientHeight - 60;
        
        pdfScale = Math.min(
            maxWidth / img.width,
            maxHeight / img.height,
            1 // Don't scale up
        );
        
        // Set canvas size
        pdfCanvas.width = img.width * pdfScale;
        pdfCanvas.height = img.height * pdfScale;
        
        // Calculate cm to px conversion (assuming 150 DPI)
        cmToPx = (150 / 2.54) * pdfScale; // 150 DPI converted to pixels per cm
        
        // Draw PDF
        drawPDF();
        
        // Show canvas container
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('pdf-container').style.display = 'block';
        
        // Draw existing fields
        drawFields();
    };
    
    img.src = data.image;
}

function drawPDF() {
    ctx.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
    
    if (pdfImage) {
        ctx.drawImage(pdfImage, 0, 0, pdfCanvas.width, pdfCanvas.height);
        
        // Draw grid if enabled
        if (document.getElementById('show-grid').checked) {
            drawGrid();
        }
    }
}

function drawGrid() {
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 0.5;
    
    // Draw vertical lines
    for (let x = 0; x <= pdfCanvas.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, pdfCanvas.height);
        ctx.stroke();
    }
    
    // Draw horizontal lines
    for (let y = 0; y <= pdfCanvas.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(pdfCanvas.width, y);
        ctx.stroke();
    }
}

function drawFields() {
    // Clear existing field overlays
    document.querySelectorAll('.field-overlay').forEach(el => el.remove());
    
    // Draw each field
    Object.entries(fields).forEach(([fieldName, fieldConfig]) => {
        drawField(fieldName, fieldConfig);
    });
}

function drawField(fieldName, fieldConfig) {
    const overlay = document.createElement('div');
    overlay.className = 'field-overlay';
    overlay.setAttribute('data-field', fieldName);
    
    // Add auto-fill mapping visual indicator
    if (fieldConfig.auto_fill_mapping || fieldConfig.patient_field_mapping) {
        overlay.classList.add('has-patient-mapping');
    }
    
    // Convert cm to pixels
    const x = fieldConfig.x * cmToPx;
    const y = fieldConfig.y * cmToPx;
    const width = fieldConfig.width * cmToPx;
    const height = fieldConfig.height * cmToPx;
    
    overlay.style.left = x + 'px';
    overlay.style.top = y + 'px';
    overlay.style.width = width + 'px';
    overlay.style.height = height + 'px';
    
    overlay.innerHTML = `
        <span class="field-label">${fieldConfig.label || fieldName}</span>
        <div class="resize-handle right"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle corner"></div>
    `;
    
    // Add event listeners
    overlay.addEventListener('click', (e) => {
        e.stopPropagation();
        selectField(fieldName);
    });
    
    overlay.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) {
            startResizing(e, fieldName);
        } else {
            startDragging(e, fieldName);
        }
    });
    
    document.getElementById('pdf-container').appendChild(overlay);
}

function setupEventListeners() {
    // Canvas click to add new field
    pdfCanvas.addEventListener('click', (e) => {
        if (!selectedField) {
            const rect = pdfCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / cmToPx;
            const y = (e.clientY - rect.top) / cmToPx;
            
            // Create new field
            createNewField(x, y);
        }
    });
    
    // Add field button
    document.getElementById('add-field-btn').addEventListener('click', () => {
        createNewField(2, 2); // Default position
    });
    
    // Save fields button
    document.getElementById('save-fields-btn').addEventListener('click', saveFields);
    
    // Field form changes
    document.getElementById('field-form').addEventListener('input', updateSelectedField);
    document.getElementById('field-type').addEventListener('change', handleFieldTypeChange);
    
    // Delete field button
    document.getElementById('delete-field-btn').addEventListener('click', deleteSelectedField);
    
    // Grid toggles
    document.getElementById('show-grid').addEventListener('change', () => {
        drawPDF();
        drawFields();
    });
    
    // Zoom controls
    document.getElementById('zoom-in').addEventListener('click', () => zoomPDF(1.2));
    document.getElementById('zoom-out').addEventListener('click', () => zoomPDF(0.8));
    document.getElementById('zoom-fit').addEventListener('click', fitPDF);
    
    // Mouse events for dragging
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Choices management
    document.getElementById('add-choice-btn').addEventListener('click', addChoice);
    
    // Section management event listeners
    document.getElementById('add-section-btn').addEventListener('click', () => showSectionModal());
    document.getElementById('save-section-btn').addEventListener('click', saveSectionConfiguration);
    document.getElementById('reorder-sections-btn').addEventListener('click', toggleReorderMode);
    document.getElementById('preview-sections-btn').addEventListener('click', showFormPreview);
    
    // Section assignment changes
    document.getElementById('field-section').addEventListener('change', handleFieldSectionChange);
    
    // Modal close functionality
    setupModalCloseHandlers();
}

function setupModalCloseHandlers() {
    // Handle modal close buttons with data-bs-dismiss="modal"
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal) {
                closeModal(modal);
            }
        });
    });
    
    // Handle clicking outside modal to close it
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });
}

function showModal(modal) {
    // Create backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.setAttribute('data-modal-id', modal.id);
    document.body.appendChild(backdrop);
    
    // Show modal
    modal.style.display = 'block';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    
    // Close modal when clicking backdrop
    backdrop.addEventListener('click', () => {
        closeModal(modal);
    });
}

function closeModal(modal) {
    modal.style.display = 'none';
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
    
    // Remove backdrop
    const backdrop = document.querySelector(`[data-modal-id="${modal.id}"]`);
    if (backdrop) {
        backdrop.remove();
    }
    
    // Reset editing state if closing section modal
    if (modal.id === 'sectionModal') {
        editingSectionKey = null;
    }
}

function createNewField(x, y) {
    let fieldName = `field_${Object.keys(fields).length + 1}`;
    
    // Ensure unique name
    while (fields[fieldName]) {
        fieldName = `field_${Object.keys(fields).length + Math.floor(Math.random() * 1000)}`;
    }
    
    const fieldConfig = {
        type: 'text',
        label: fieldName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
        x: Math.round(x * 10) / 10, // Round to 1 decimal place
        y: Math.round(y * 10) / 10,
        width: 4.0,
        height: 0.7,
        font_size: 12,
        required: false
    };
    
    fields[fieldName] = fieldConfig;
    drawFields();
    updateFieldList();
    selectField(fieldName);
}

function selectField(fieldName) {
    selectedField = fieldName;
    
    // Update visual selection
    document.querySelectorAll('.field-overlay').forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelectorAll('.field-item').forEach(el => {
        el.classList.remove('selected');
    });
    
    const overlay = document.querySelector(`[data-field="${fieldName}"]`);
    if (overlay) {
        overlay.classList.add('selected');
    }
    
    const listItem = document.querySelector(`[data-field-name="${fieldName}"]`);
    if (listItem) {
        listItem.classList.add('selected');
    }
    
    // Load field properties
    loadFieldProperties(fieldName);
    
    // Show properties panel
    document.getElementById('field-properties').style.display = 'block';
}

function loadFieldProperties(fieldName) {
    const fieldConfig = fields[fieldName];
    
    document.getElementById('field-name').value = fieldName;
    document.getElementById('field-label').value = fieldConfig.label || '';
    document.getElementById('field-type').value = fieldConfig.type || 'text';
    document.getElementById('field-required').checked = fieldConfig.required || false;
    document.getElementById('field-max-length').value = fieldConfig.max_length || '';
    document.getElementById('field-font-size').value = fieldConfig.font_size || 12;
    document.getElementById('field-width').value = fieldConfig.width || 4.0;
    document.getElementById('field-height').value = fieldConfig.height || 0.7;
    document.getElementById('field-auto-fill').value = fieldConfig.auto_fill_mapping || fieldConfig.patient_field_mapping || '';
    document.getElementById('field-section').value = fieldConfig.section || '';
    document.getElementById('field-order').value = fieldConfig.field_order || '';
    
    // Update position and size display
    document.getElementById('position-display').textContent = `${fieldConfig.x}, ${fieldConfig.y}`;
    document.getElementById('size-display').textContent = `${fieldConfig.width} √ó ${fieldConfig.height}`;
    
    // Handle field type specific options
    handleFieldTypeChange();
    
    // Load choices for choice fields
    if (fieldConfig.type === 'choice' && fieldConfig.choices) {
        loadChoices(fieldConfig.choices);
    }
}

function updateSelectedField() {
    if (!selectedField) return;
    
    const fieldConfig = fields[selectedField];
    
    // Get form values
    const newName = document.getElementById('field-name').value;
    const label = document.getElementById('field-label').value;
    const type = document.getElementById('field-type').value;
    const required = document.getElementById('field-required').checked;
    const maxLength = document.getElementById('field-max-length').value;
    const fontSize = document.getElementById('field-font-size').value;
    const width = document.getElementById('field-width').value;
    const height = document.getElementById('field-height').value;
    const autoFillMapping = document.getElementById('field-auto-fill').value;
    const sectionKey = document.getElementById('field-section').value;
    const fieldOrder = document.getElementById('field-order').value;
    
    // Handle field rename
    if (newName !== selectedField && newName && !fields[newName]) {
        fields[newName] = fieldConfig;
        delete fields[selectedField];
        selectedField = newName;
    }
    
    // Update field configuration
    fieldConfig.label = label;
    fieldConfig.type = type;
    fieldConfig.required = required;
    fieldConfig.font_size = parseInt(fontSize) || 12;
    
    // Update auto-fill mapping
    if (autoFillMapping) {
        fieldConfig.auto_fill_mapping = autoFillMapping;
        // Remove legacy patient_field_mapping if present
        delete fieldConfig.patient_field_mapping;
    } else {
        delete fieldConfig.auto_fill_mapping;
        delete fieldConfig.patient_field_mapping;
    }
    
    // Update section assignment
    if (sectionKey) {
        fieldConfig.section = sectionKey;
        if (fieldOrder) {
            fieldConfig.field_order = parseInt(fieldOrder) || 1;
        }
    } else {
        delete fieldConfig.section;
        delete fieldConfig.field_order;
    }
    
    // Update dimensions
    if (width) {
        fieldConfig.width = parseFloat(width);
    }
    if (height) {
        fieldConfig.height = parseFloat(height);
    }
    
    // Auto-adjust height based on font size for text fields
    if (['text', 'number', 'date', 'datetime', 'email'].includes(type)) {
        const fontSizeNum = parseInt(fontSize) || 12;
        const autoHeight = Math.max(0.3, (fontSizeNum * 0.06) + 0.2); // Font size in cm + padding
        if (!height || Math.abs(fieldConfig.height - autoHeight) > 0.1) {
            fieldConfig.height = Math.round(autoHeight * 10) / 10;
            document.getElementById('field-height').value = fieldConfig.height;
        }
    }
    
    if (maxLength) {
        fieldConfig.max_length = parseInt(maxLength);
    } else {
        delete fieldConfig.max_length;
    }
    
    // Update choices for choice fields
    if (type === 'choice') {
        fieldConfig.choices = getChoicesFromForm();
    } else {
        delete fieldConfig.choices;
    }
    
    // Update displays
    document.getElementById('position-display').textContent = `${fieldConfig.x}, ${fieldConfig.y}`;
    document.getElementById('size-display').textContent = `${fieldConfig.width} √ó ${fieldConfig.height}`;
    
    // Redraw fields and update list
    drawFields();
    updateFieldList();
}

function handleFieldTypeChange() {
    const fieldType = document.getElementById('field-type').value;
    
    // Show/hide max length
    const maxLengthGroup = document.getElementById('max-length-group');
    maxLengthGroup.style.display = ['text', 'textarea', 'email'].includes(fieldType) ? 'block' : 'none';
    
    // Show/hide choices
    const choicesGroup = document.getElementById('choices-group');
    choicesGroup.style.display = fieldType === 'choice' ? 'block' : 'none';
    
    if (fieldType === 'choice' && selectedField) {
        const fieldConfig = fields[selectedField];
        if (!fieldConfig.choices) {
            fieldConfig.choices = ['Option 1', 'Option 2'];
            loadChoices(fieldConfig.choices);
        }
    }
}

function loadChoices(choices) {
    const choicesList = document.getElementById('choices-list');
    choicesList.innerHTML = '';
    
    choices.forEach((choice, index) => {
        addChoiceElement(choice, index);
    });
}

function addChoice() {
    const choicesList = document.getElementById('choices-list');
    const index = choicesList.children.length;
    addChoiceElement(`Option ${index + 1}`, index);
    updateSelectedField();
}

function addChoiceElement(value, index) {
    const choicesList = document.getElementById('choices-list');
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'choice-item';
    
    choiceDiv.innerHTML = `
        <input type="text" value="${value}" onchange="updateSelectedField()">
        <button type="button" class="btn btn-danger" onclick="removeChoice(this)">√ó</button>
    `;
    
    choicesList.appendChild(choiceDiv);
}

function removeChoice(button) {
    button.parentElement.remove();
    updateSelectedField();
}

function getChoicesFromForm() {
    const choiceInputs = document.querySelectorAll('#choices-list input');
    const choices = [];
    choiceInputs.forEach(input => {
        if (input.value.trim()) {
            choices.push(input.value.trim());
        }
    });
    return choices;
}

function updateFieldList() {
    const fieldList = document.getElementById('field-list');
    
    if (Object.keys(fields).length === 0) {
        fieldList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No fields configured</div>';
        return;
    }
    
    fieldList.innerHTML = '';
    
    Object.entries(fields).forEach(([fieldName, fieldConfig]) => {
        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        fieldItem.setAttribute('data-field-name', fieldName);
        
        // Add auto-fill mapping indicator class
        if (fieldConfig.auto_fill_mapping || fieldConfig.patient_field_mapping) {
            fieldItem.classList.add('has-patient-mapping');
        }
        
        // Build auto-fill mapping display
        let autoFillDisplay = '';
        const mapping = fieldConfig.auto_fill_mapping || fieldConfig.patient_field_mapping;
        if (mapping) {
            autoFillDisplay = `<div class="patient-mapping-indicator">üìã Auto: ${mapping}</div>`;
        }
        
        fieldItem.innerHTML = `
            <div>
                <div class="field-name">${fieldConfig.label || fieldName}</div>
                <div style="font-size: 11px; color: #999;">${fieldName}</div>
                ${autoFillDisplay}
            </div>
            <div class="field-type">${fieldConfig.type}</div>
        `;
        
        fieldItem.addEventListener('click', () => selectField(fieldName));
        fieldList.appendChild(fieldItem);
    });
}

function deleteSelectedField() {
    if (!selectedField) return;
    
    if (confirm(`Delete field "${selectedField}"?`)) {
        delete fields[selectedField];
        selectedField = null;
        
        drawFields();
        updateFieldList();
        document.getElementById('field-properties').style.display = 'none';
    }
}

function startDragging(e, fieldName) {
    e.preventDefault();
    isDragging = true;
    selectedField = fieldName;
    
    const overlay = e.target.closest('.field-overlay');
    const rect = overlay.getBoundingClientRect();
    const canvasRect = pdfCanvas.getBoundingClientRect();
    
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    selectField(fieldName);
}

function startResizing(e, fieldName) {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    selectedField = fieldName;
    
    // Determine resize type based on handle class
    if (e.target.classList.contains('right')) {
        resizeType = 'right';
    } else if (e.target.classList.contains('bottom')) {
        resizeType = 'bottom';
    } else if (e.target.classList.contains('corner')) {
        resizeType = 'corner';
    }
    
    selectField(fieldName);
}

function handleMouseMove(e) {
    if ((!isDragging && !isResizing) || !selectedField) return;
    
    const canvasRect = pdfCanvas.getBoundingClientRect();
    const fieldConfig = fields[selectedField];
    
    if (isDragging) {
        // Handle dragging (moving the field)
        const x = (e.clientX - canvasRect.left - dragOffset.x) / cmToPx;
        const y = (e.clientY - canvasRect.top - dragOffset.y) / cmToPx;
        
        // Snap to grid if enabled
        if (document.getElementById('snap-to-grid').checked) {
            const gridCm = 0.1; // 0.1 cm grid (1mm precision)
            fieldConfig.x = Math.round(x / gridCm) * gridCm;
            fieldConfig.y = Math.round(y / gridCm) * gridCm;
        } else {
            fieldConfig.x = Math.round(x * 10) / 10;
            fieldConfig.y = Math.round(y * 10) / 10;
        }
        
        // Update position display
        document.getElementById('position-display').textContent = `${fieldConfig.x}, ${fieldConfig.y}`;
        
    } else if (isResizing) {
        // Handle resizing
        const mouseX = (e.clientX - canvasRect.left) / cmToPx;
        const mouseY = (e.clientY - canvasRect.top) / cmToPx;
        
        if (resizeType === 'right' || resizeType === 'corner') {
            let newWidth = mouseX - fieldConfig.x;
            if (document.getElementById('snap-to-grid').checked) {
                const gridCm = 0.1;
                newWidth = Math.round(newWidth / gridCm) * gridCm;
            } else {
                newWidth = Math.round(newWidth * 10) / 10;
            }
            fieldConfig.width = Math.max(0.5, newWidth); // Minimum width 0.5cm
        }
        
        if (resizeType === 'bottom' || resizeType === 'corner') {
            let newHeight = mouseY - fieldConfig.y;
            if (document.getElementById('snap-to-grid').checked) {
                const gridCm = 0.1;
                newHeight = Math.round(newHeight / gridCm) * gridCm;
            } else {
                newHeight = Math.round(newHeight * 10) / 10;
            }
            fieldConfig.height = Math.max(0.3, newHeight); // Minimum height 0.3cm
        }
        
        // Update size display
        document.getElementById('size-display').textContent = `${fieldConfig.width} √ó ${fieldConfig.height}`;
    }
    
    drawFields();
}

function handleMouseUp(e) {
    isDragging = false;
    isResizing = false;
    resizeType = null;
}

function zoomPDF(factor) {
    pdfScale *= factor;
    
    if (pdfImage) {
        pdfCanvas.width = pdfImage.width * pdfScale;
        pdfCanvas.height = pdfImage.height * pdfScale;
        cmToPx = (150 / 2.54) * pdfScale;
        
        drawPDF();
        drawFields();
    }
}

function fitPDF() {
    if (!pdfImage) return;
    
    const container = document.querySelector('.pdf-preview-container');
    const maxWidth = container.clientWidth - 60;
    const maxHeight = container.clientHeight - 60;
    
    pdfScale = Math.min(
        maxWidth / pdfImage.width,
        maxHeight / pdfImage.height,
        1
    );
    
    pdfCanvas.width = pdfImage.width * pdfScale;
    pdfCanvas.height = pdfImage.height * pdfScale;
    cmToPx = (150 / 2.54) * pdfScale;
    
    drawPDF();
    drawFields();
}

function saveFields() {
    const templateId = '{{ template.id }}';
    const apiUrl = `../api/save-fields/`;
    
    // Show loading state
    const saveBtn = document.getElementById('save-fields-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;
    
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            fields: Object.keys(sections).length > 0 ? {
                sections: sections,
                fields: fields
            } : fields
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('Error saving fields: ' + error.message);
    })
    .finally(() => {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    });
}

// Section Management Functions
function updateSectionsList() {
    const sectionsList = document.getElementById('sections-list');
    
    if (Object.keys(sections).length === 0) {
        sectionsList.innerHTML = '<div style="padding: 15px; text-align: center; color: #666; font-style: italic;">No sections configured</div>';
        return;
    }
    
    sectionsList.innerHTML = '';
    
    // Sort sections by order
    const sortedSections = Object.entries(sections).sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));
    
    sortedSections.forEach(([sectionKey, sectionConfig]) => {
        const sectionItem = document.createElement('div');
        sectionItem.className = 'section-item';
        sectionItem.setAttribute('data-section-key', sectionKey);
        
        const fieldCount = getFieldCountForSection(sectionKey);
        
        sectionItem.innerHTML = `
            <div class="section-drag-handle">‚ãÆ‚ãÆ</div>
            <div class="section-info">
                ${sectionConfig.icon ? `<i class="${sectionConfig.icon} section-icon"></i>` : ''}
                <span class="section-name">${sectionConfig.label}</span>
                <span class="section-field-count">${fieldCount} fields</span>
            </div>
            <div class="section-actions">
                <button class="btn-edit" onclick="editSection('${sectionKey}')">Edit</button>
                <button class="btn-delete" onclick="deleteSection('${sectionKey}')">Delete</button>
            </div>
        `;
        
        sectionsList.appendChild(sectionItem);
    });
}

function updateFieldSectionDropdown() {
    const sectionSelect = document.getElementById('field-section');
    
    // Clear existing options except the first one
    const firstOption = sectionSelect.firstElementChild;
    sectionSelect.innerHTML = '';
    sectionSelect.appendChild(firstOption);
    
    // Add section options
    const sortedSections = Object.entries(sections).sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));
    
    sortedSections.forEach(([sectionKey, sectionConfig]) => {
        const option = document.createElement('option');
        option.value = sectionKey;
        option.textContent = `${sectionConfig.icon ? sectionConfig.icon + ' ' : ''}${sectionConfig.label}`;
        sectionSelect.appendChild(option);
    });
}

function showSectionModal(sectionKey = null) {
    editingSectionKey = sectionKey;
    const modal = document.getElementById('sectionModal');
    const modalTitle = document.getElementById('sectionModalLabel');
    
    if (sectionKey) {
        // Editing existing section
        modalTitle.textContent = 'Edit Section';
        const sectionConfig = sections[sectionKey];
        
        document.getElementById('section-key').value = sectionKey;
        document.getElementById('section-key').disabled = true; // Don't allow key changes
        document.getElementById('section-label').value = sectionConfig.label || '';
        document.getElementById('section-description').value = sectionConfig.description || '';
        document.getElementById('section-icon').value = sectionConfig.icon || '';
        document.getElementById('section-order').value = sectionConfig.order || getNextSectionOrder();
        document.getElementById('section-collapsed').checked = sectionConfig.collapsed || false;
    } else {
        // Creating new section
        modalTitle.textContent = 'Add New Section';
        document.getElementById('section-form').reset();
        document.getElementById('section-key').disabled = false;
        document.getElementById('section-order').value = getNextSectionOrder();
    }
    
    // Show modal with vanilla JavaScript
    showModal(modal);
}

function saveSectionConfiguration() {
    const sectionKey = document.getElementById('section-key').value.trim();
    const sectionLabel = document.getElementById('section-label').value.trim();
    const sectionDescription = document.getElementById('section-description').value.trim();
    const sectionIcon = document.getElementById('section-icon').value;
    const sectionOrder = parseInt(document.getElementById('section-order').value) || 1;
    const sectionCollapsed = document.getElementById('section-collapsed').checked;
    
    // Validation
    if (!sectionKey || !sectionLabel) {
        showError('Section key and label are required');
        return;
    }
    
    // Validate section key format
    if (!/^[a-zA-Z0-9_]+$/.test(sectionKey)) {
        showError('Section key can only contain letters, numbers, and underscores');
        return;
    }
    
    // Check for duplicate keys (when creating new)
    if (!editingSectionKey && sections[sectionKey]) {
        showError('Section key already exists');
        return;
    }
    
    // Check for duplicate orders
    const existingOrders = Object.values(sections)
        .filter((_, key) => editingSectionKey !== Object.keys(sections)[key])
        .map(s => s.order);
    
    if (existingOrders.includes(sectionOrder)) {
        showError('Section order already in use');
        return;
    }
    
    // Save section
    sections[sectionKey] = {
        label: sectionLabel,
        description: sectionDescription,
        order: sectionOrder,
        collapsed: sectionCollapsed,
        icon: sectionIcon
    };
    
    // Update UI
    updateSectionsList();
    updateFieldSectionDropdown();
    updateFieldList();
    
    // Close modal with vanilla JavaScript
    const modal = document.getElementById('sectionModal');
    closeModal(modal);
    editingSectionKey = null;
    
    showSuccess(`Section "${sectionLabel}" ${editingSectionKey ? 'updated' : 'created'} successfully`);
}

function editSection(sectionKey) {
    showSectionModal(sectionKey);
}

function deleteSection(sectionKey) {
    const sectionName = sections[sectionKey]?.label || sectionKey;
    const fieldCount = getFieldCountForSection(sectionKey);
    
    let message = `Delete section "${sectionName}"?`;
    if (fieldCount > 0) {
        message += `\n\nThis section contains ${fieldCount} field(s). The fields will become unsectioned.`;
    }
    
    if (!confirm(message)) {
        return;
    }
    
    // Remove section assignment from fields
    Object.keys(fields).forEach(fieldName => {
        if (fields[fieldName].section === sectionKey) {
            delete fields[fieldName].section;
            delete fields[fieldName].field_order;
        }
    });
    
    // Delete section
    delete sections[sectionKey];
    
    // Update UI
    updateSectionsList();
    updateFieldSectionDropdown();
    updateFieldList();
    
    showSuccess(`Section "${sectionName}" deleted successfully`);
}

function getFieldCountForSection(sectionKey) {
    return Object.values(fields).filter(field => field.section === sectionKey).length;
}

function getNextSectionOrder() {
    const orders = Object.values(sections).map(s => s.order || 0);
    return orders.length > 0 ? Math.max(...orders) + 1 : 1;
}

function handleFieldSectionChange() {
    if (!selectedField) return;
    
    const sectionKey = document.getElementById('field-section').value;
    
    if (sectionKey) {
        fields[selectedField].section = sectionKey;
        // Set default field order within section
        const fieldsInSection = Object.values(fields).filter(f => f.section === sectionKey);
        fields[selectedField].field_order = fieldsInSection.length;
        document.getElementById('field-order').value = fields[selectedField].field_order;
    } else {
        delete fields[selectedField].section;
        delete fields[selectedField].field_order;
        document.getElementById('field-order').value = '';
    }
    
    updateFieldList();
    updateSectionsList();
}

function toggleReorderMode() {
    isReorderMode = !isReorderMode;
    const button = document.getElementById('reorder-sections-btn');
    const sectionsList = document.getElementById('sections-list');
    
    if (isReorderMode) {
        button.innerHTML = '<i class="bi bi-check"></i> Done Reordering';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        sectionsList.classList.add('reorder-mode');
        
        // Enable drag and drop
        enableSectionDragAndDrop();
    } else {
        button.innerHTML = '<i class="bi bi-arrow-up-down"></i> Reorder Sections';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
        sectionsList.classList.remove('reorder-mode');
        
        // Disable drag and drop
        disableSectionDragAndDrop();
    }
}

function enableSectionDragAndDrop() {
    const sectionItems = document.querySelectorAll('.section-item');
    
    sectionItems.forEach(item => {
        item.draggable = true;
        item.addEventListener('dragstart', handleSectionDragStart);
        item.addEventListener('dragover', handleSectionDragOver);
        item.addEventListener('drop', handleSectionDrop);
        item.addEventListener('dragend', handleSectionDragEnd);
    });
}

function disableSectionDragAndDrop() {
    const sectionItems = document.querySelectorAll('.section-item');
    
    sectionItems.forEach(item => {
        item.draggable = false;
        item.removeEventListener('dragstart', handleSectionDragStart);
        item.removeEventListener('dragover', handleSectionDragOver);
        item.removeEventListener('drop', handleSectionDrop);
        item.removeEventListener('dragend', handleSectionDragEnd);
    });
}

let draggedSectionKey = null;

function handleSectionDragStart(e) {
    draggedSectionKey = e.target.getAttribute('data-section-key');
    e.target.classList.add('dragging');
}

function handleSectionDragOver(e) {
    e.preventDefault();
}

function handleSectionDrop(e) {
    e.preventDefault();
    const targetSectionKey = e.target.closest('.section-item')?.getAttribute('data-section-key');
    
    if (draggedSectionKey && targetSectionKey && draggedSectionKey !== targetSectionKey) {
        // Swap orders
        const draggedOrder = sections[draggedSectionKey].order;
        const targetOrder = sections[targetSectionKey].order;
        
        sections[draggedSectionKey].order = targetOrder;
        sections[targetSectionKey].order = draggedOrder;
        
        // Update UI
        updateSectionsList();
        enableSectionDragAndDrop(); // Re-enable after update
    }
}

function handleSectionDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedSectionKey = null;
}

function showFormPreview() {
    const modal = document.getElementById('sectionPreviewModal');
    const previewContent = document.getElementById('preview-accordion');
    
    previewContent.innerHTML = '';
    
    if (Object.keys(sections).length === 0) {
        previewContent.innerHTML = '<div class="text-center text-muted p-4">No sections configured</div>';
    } else {
        // Sort sections by order
        const sortedSections = Object.entries(sections).sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));
        
        sortedSections.forEach(([sectionKey, sectionConfig]) => {
            const sectionFields = Object.entries(fields)
                .filter(([, fieldConfig]) => fieldConfig.section === sectionKey)
                .sort(([,a], [,b]) => (a.field_order || 999) - (b.field_order || 999));
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'form-preview-section';
            
            let fieldsHtml = '';
            if (sectionFields.length === 0) {
                fieldsHtml = '<div class="text-muted">No fields assigned to this section</div>';
            } else {
                fieldsHtml = sectionFields.map(([fieldName, fieldConfig]) => `
                    <div class="form-preview-field">
                        <div class="form-preview-field-name">${fieldConfig.label || fieldName}</div>
                        <div class="form-preview-field-type">${fieldConfig.type || 'text'}</div>
                    </div>
                `).join('');
            }
            
            sectionDiv.innerHTML = `
                <div class="form-preview-section-header">
                    ${sectionConfig.icon ? `<i class="${sectionConfig.icon}"></i>` : ''}
                    ${sectionConfig.label}
                    <span class="badge bg-primary ms-auto">${sectionFields.length}</span>
                </div>
                <div class="form-preview-section-body">
                    ${sectionConfig.description ? `<p class="text-muted mb-3">${sectionConfig.description}</p>` : ''}
                    ${fieldsHtml}
                </div>
            `;
            
            previewContent.appendChild(sectionDiv);
        });
        
        // Show unsectioned fields
        const unsectionedFields = Object.entries(fields).filter(([, fieldConfig]) => !fieldConfig.section);
        if (unsectionedFields.length > 0) {
            const unsectionedDiv = document.createElement('div');
            unsectionedDiv.className = 'form-preview-section';
            
            const fieldsHtml = unsectionedFields.map(([fieldName, fieldConfig]) => `
                <div class="form-preview-field">
                    <div class="form-preview-field-name">${fieldConfig.label || fieldName}</div>
                    <div class="form-preview-field-type">${fieldConfig.type || 'text'}</div>
                </div>
            `).join('');
            
            unsectionedDiv.innerHTML = `
                <div class="form-preview-section-header">
                    <i class="bi-gear"></i>
                    Other Fields
                    <span class="badge bg-secondary ms-auto">${unsectionedFields.length}</span>
                </div>
                <div class="form-preview-section-body">
                    ${fieldsHtml}
                </div>
            `;
            
            previewContent.appendChild(unsectionedDiv);
        }
    }
    
    // Show modal with vanilla JavaScript
    showModal(modal);
}

function showError(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `<div class="error-message">${message}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

function showSuccess(message) {
    const container = document.getElementById('success-container');
    container.innerHTML = `<div class="success-message">${message}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 3000);
}

function showManualJSONEditor() {
    const manualEditor = document.getElementById('manual-json-editor');
    manualEditor.style.display = 'block';
    
    // Load current fields into the JSON editor
    const jsonEditor = document.getElementById('json-editor');
    if (Object.keys(fields).length > 0) {
        jsonEditor.value = JSON.stringify(fields, null, 2);
    }
}

function loadFromJSON() {
    const jsonEditor = document.getElementById('json-editor');
    
    try {
        const parsedFields = JSON.parse(jsonEditor.value);
        
        // Validate the structure
        for (const [fieldName, fieldConfig] of Object.entries(parsedFields)) {
            if (!fieldConfig.type || !fieldConfig.label || 
                typeof fieldConfig.x !== 'number' || typeof fieldConfig.y !== 'number' ||
                typeof fieldConfig.width !== 'number' || typeof fieldConfig.height !== 'number') {
                throw new Error(`Field "${fieldName}" is missing required properties (type, label, x, y, width, height)`);
            }
        }
        
        // Load the fields
        fields = parsedFields;
        updateFieldList();
        
        // Try to draw fields if PDF is available
        if (pdfCanvas) {
            drawFields();
        }
        
        showSuccess('Fields loaded successfully from JSON!');
        
    } catch (error) {
        showError('Invalid JSON format: ' + error.message);
    }
}

function exportToJSON() {
    const jsonEditor = document.getElementById('json-editor');
    jsonEditor.value = JSON.stringify(fields, null, 2);
    
    // Select the text for easy copying
    jsonEditor.select();
    jsonEditor.setSelectionRange(0, 99999); // For mobile devices
    
    // Try to copy to clipboard
    try {
        document.execCommand('copy');
        showSuccess('JSON copied to clipboard!');
    } catch (error) {
        showSuccess('JSON exported to editor. You can copy it manually.');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}