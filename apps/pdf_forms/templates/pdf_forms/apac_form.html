{% extends "pdf_forms/base.html" %}
{% load static %}

{% block page_title %}Formulário APAC - {{ patient.name }}{% endblock %}

{% block app_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'apps.patients:patient_events_timeline' patient_id=patient.id %}">
        <i class="bi bi-clock-history me-1"></i>
        Timeline do Paciente
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'pdf_forms:form_select' patient.id %}">
        Formulários PDF
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      Formulário APAC
    </li>
  </ol>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Patient header -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-file-earmark-medical me-2"></i>
            Formulário APAC - {{ patient.name }}
          </h5>
        </div>
        <div class="card-body">
          <p class="mb-0">
            Formulário de Autorização de Procedimentos de Alta Complexidade
          </p>
        </div>
      </div>

      <!-- APAC Form -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-pencil-square me-2"></i>
            Preenchimento do Formulário
          </h6>
        </div>
        <div class="card-body">
          <form method="post" id="apac-form">
            {% csrf_token %}

            <!-- Identification Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#section-identification" aria-expanded="false" aria-controls="section-identification">
                  <i class="bi bi-person-badge me-2"></i>
                  Identificação
                </button>
              </div>
              <div id="section-identification" class="collapse">
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="{{ form.patient_name.id_for_label }}" class="form-label">
                          {{ form.patient_name.label }}
                        </label>
                        {{ form.patient_name }}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="{{ form.patient_gender.id_for_label }}" class="form-label">
                          {{ form.patient_gender.label }}
                        </label>
                        {{ form.patient_gender }}
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="{{ form.patient_birth_date.id_for_label }}" class="form-label">
                          {{ form.patient_birth_date.label }}
                        </label>
                        {{ form.patient_birth_date }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Requested Procedure Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#section-requested-procedure" aria-expanded="true" aria-controls="section-requested-procedure">
                  <i class="bi bi-clipboard2-pulse me-2"></i>
                  Procedimento Solicitado
                </button>
              </div>
              <div id="section-requested-procedure" class="collapse show">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.main_procedure_display.label }}
                          <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          {{ form.main_procedure_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.main_procedure }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-main" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.main_procedure_quantity.id_for_label }}" class="form-label">
                          {{ form.main_procedure_quantity.label }}
                        </label>
                        {{ form.main_procedure_quantity }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Secondary Procedures Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#section-secondary-procedures" aria-expanded="false" aria-controls="section-secondary-procedures">
                  <i class="bi bi-journal-medical me-2"></i>
                  Procedimentos Secundários
                </button>
              </div>
              <div id="section-secondary-procedures" class="collapse">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_procedure_1_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_procedure_1_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_procedure_1 }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-secondary-1" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.secondary_procedure_1_qty.id_for_label }}" class="form-label">
                          {{ form.secondary_procedure_1_qty.label }}
                        </label>
                        {{ form.secondary_procedure_1_qty }}
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_procedure_2_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_procedure_2_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_procedure_2 }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-secondary-2" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.secondary_procedure_2_qty.id_for_label }}" class="form-label">
                          {{ form.secondary_procedure_2_qty.label }}
                        </label>
                        {{ form.secondary_procedure_2_qty }}
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_procedure_3_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_procedure_3_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_procedure_3 }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-secondary-3" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.secondary_procedure_3_qty.id_for_label }}" class="form-label">
                          {{ form.secondary_procedure_3_qty.label }}
                        </label>
                        {{ form.secondary_procedure_3_qty }}
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_procedure_4_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_procedure_4_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_procedure_4 }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-secondary-4" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.secondary_procedure_4_qty.id_for_label }}" class="form-label">
                          {{ form.secondary_procedure_4_qty.label }}
                        </label>
                        {{ form.secondary_procedure_4_qty }}
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-9">
                      <div class="mb-3 procedure-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_procedure_5_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_procedure_5_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_procedure_5 }}
                        <div class="form-text">
                          Digite o código ou descrição do procedimento para buscar
                        </div>
                        <div id="procedure-results-secondary-5" class="dropdown-menu procedure-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="mb-3">
                        <label for="{{ form.secondary_procedure_5_qty.id_for_label }}" class="form-label">
                          {{ form.secondary_procedure_5_qty.label }}
                        </label>
                        {{ form.secondary_procedure_5_qty }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Diagnosis Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#section-diagnosis" aria-expanded="true" aria-controls="section-diagnosis">
                  <i class="bi bi-clipboard2-data me-2"></i>
                  Diagnóstico
                </button>
              </div>
              <div id="section-diagnosis" class="collapse show">
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-12">
                      <div class="mb-3">
                        <label for="{{ form.main_diagnosis.id_for_label }}" class="form-label">
                          {{ form.main_diagnosis.label }}
                          <span class="text-danger">*</span>
                        </label>
                        {{ form.main_diagnosis }}
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <div class="mb-3 icd10-search-group position-relative">
                        <label class="form-label">
                          {{ form.main_icd_display.label }}
                          <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          {{ form.main_icd_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.main_icd_id }}
                        <div class="form-text">
                          Digite o código ou descrição do CID 10 para buscar
                        </div>
                        <div id="icd10-results-main" class="dropdown-menu icd10-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3 icd10-search-group position-relative">
                        <label class="form-label">
                          {{ form.secondary_icd_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.secondary_icd_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.secondary_icd_id }}
                        <div class="form-text">
                          Digite o código ou descrição do CID 10 para buscar
                        </div>
                        <div id="icd10-results-secondary" class="dropdown-menu icd10-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3 icd10-search-group position-relative">
                        <label class="form-label">
                          {{ form.other_icd_display.label }}
                        </label>
                        <div class="input-group">
                          {{ form.other_icd_display }}
                          <span class="input-group-text search-spinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          </span>
                        </div>
                        {{ form.other_icd_id }}
                        <div class="form-text">
                          Digite o código ou descrição do CID 10 para buscar
                        </div>
                        <div id="icd10-results-other" class="dropdown-menu icd10-results w-100 mt-0" style="max-height: 200px; overflow-y: auto;"></div>
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-12">
                      <div class="mb-3">
                        <label for="{{ form.diagnosis_notes.id_for_label }}" class="form-label">
                          {{ form.diagnosis_notes.label }}
                        </label>
                        {{ form.diagnosis_notes }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Requesting Doctor Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#section-requesting-doctor" aria-expanded="true" aria-controls="section-requesting-doctor">
                  <i class="bi bi-person-badge me-2"></i>
                  Solicitante
                </button>
              </div>
              <div id="section-requesting-doctor" class="collapse show">
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-8">
                      <div class="mb-3">
                        <label for="{{ form.doctor_name.id_for_label }}" class="form-label">
                          {{ form.doctor_name.label }}
                        </label>
                        {{ form.doctor_name }}
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="{{ form.request_date.id_for_label }}" class="form-label">
                          {{ form.request_date.label }}
                        </label>
                        {{ form.request_date }}
                      </div>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-2">
                      <div class="form-check mt-2">
                        {{ form.doctor_doc_type_fiscal_number }}
                        <label class="form-check-label" for="{{ form.doctor_doc_type_fiscal_number.id_for_label }}">
                          {{ form.doctor_doc_type_fiscal_number.label }}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-10">
                      <div class="mb-3">
                        <label for="{{ form.doctor_doc_number_fiscal_number.id_for_label }}" class="form-label">
                          {{ form.doctor_doc_number_fiscal_number.label }}
                        </label>
                        {{ form.doctor_doc_number_fiscal_number }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="row">
              <div class="col-12">
                <hr>
                <div class="d-flex justify-content-between">
                  <a href="{% url 'pdf_forms:form_select' patient.id %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Cancelar
                  </a>
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i>
                    Salvar Formulário APAC
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const procedureInputs = Array.from(document.querySelectorAll('.procedure-search-input'));
    const resultsContainers = Array.from(document.querySelectorAll('.procedure-results'));
    const hiddenInputs = Array.from(document.querySelectorAll('.procedure-hidden-input'));
    const timeouts = new Map();
    const searchUrl = '{% url "apps.core:procedures_search_api" %}';

    function getHiddenInput(input) {
        const hiddenId = input.dataset.hiddenId;
        return hiddenId ? document.getElementById(hiddenId) : null;
    }

    function clearSelection(input) {
        const hiddenInput = getHiddenInput(input);
        if (hiddenInput) {
            hiddenInput.value = '';
        }
        input.dataset.procedureId = '';
        input.dataset.procedureCode = '';
        input.dataset.procedureDescription = '';
    }

    function getResultsContainer(input) {
        const resultsId = input.dataset.resultsId;
        if (resultsId) {
            const byId = document.getElementById(resultsId);
            if (byId) {
                return byId;
            }
        }
        const wrapper = input.closest('.procedure-search-group');
        return wrapper ? wrapper.querySelector('.procedure-results') : null;
    }

    function getSpinner(input) {
        const wrapper = input.closest('.input-group');
        return wrapper ? wrapper.querySelector('.search-spinner') : null;
    }

    function showSpinner(input) {
        const spinner = getSpinner(input);
        if (spinner) {
            spinner.style.display = 'block';
        }
    }

    function hideSpinner(input) {
        const spinner = getSpinner(input);
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    function hideAllResults() {
        resultsContainers.forEach(function(container) {
            container.classList.remove('show');
            container.style.display = 'none';
        });
    }

    function renderResults(input, results) {
        const resultsContainer = getResultsContainer(input);
        const hiddenInput = getHiddenInput(input);

        if (!resultsContainer) {
            return;
        }

        resultsContainer.innerHTML = '';

        if (!results.length) {
            resultsContainer.classList.remove('show');
            resultsContainer.style.display = 'none';
            return;
        }

        results.forEach(function(procedure) {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <strong>${procedure.code}</strong><br>
                <small class="text-muted">${procedure.short_description || procedure.description}</small>
            `;
            item.addEventListener('click', function() {
                const duplicate = hiddenInputs.some(function(hidden) {
                    return hidden !== hiddenInput && hidden.value === procedure.id;
                });

                if (duplicate) {
                    alert('Este procedimento já foi selecionado. Escolha outro.');
                    return;
                }

                input.value = `${procedure.code} - ${procedure.description}`;
                if (hiddenInput) {
                    hiddenInput.value = procedure.id;
                }
                input.dataset.procedureId = procedure.id;
                input.dataset.procedureCode = procedure.code;
                input.dataset.procedureDescription = procedure.description;
                resultsContainer.classList.remove('show');
                resultsContainer.style.display = 'none';
                hideSpinner(input);
            });

            resultsContainer.appendChild(item);
        });

        resultsContainer.classList.add('show');
        resultsContainer.style.display = 'block';
    }

    procedureInputs.forEach(function(input) {
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });

        input.addEventListener('input', function() {
            const query = input.value.trim();
            const resultsContainer = getResultsContainer(input);

            clearSelection(input);

            if (timeouts.has(input)) {
                clearTimeout(timeouts.get(input));
            }

            if (query.length < 2) {
                if (resultsContainer) {
                    resultsContainer.classList.remove('show');
                    resultsContainer.style.display = 'none';
                }
                hideSpinner(input);
                return;
            }

            const timeoutId = setTimeout(function() {
                showSpinner(input);
                const url = `${searchUrl}?q=${encodeURIComponent(query)}&limit=10`;
                fetch(url, { credentials: 'same-origin' })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        hideSpinner(input);
                        renderResults(input, (data && data.results) ? data.results : []);
                    })
                    .catch(function() {
                        hideSpinner(input);
                        console.error('Error searching procedures');
                    });
            }, 300);

            timeouts.set(input, timeoutId);
        });
    });

    document.addEventListener('click', function(event) {
        const target = event.target;
        if (!target.closest('.procedure-search-input') && !target.closest('.procedure-results')) {
            hideAllResults();
        }
    });

    document.getElementById('apac-form').addEventListener('submit', function(event) {
        for (const input of procedureInputs) {
            const required = input.dataset.required === 'true';
            const value = input.value.trim();
            const hiddenInput = getHiddenInput(input);
            const hiddenId = hiddenInput ? hiddenInput.value : '';

            if (required && !hiddenId) {
                event.preventDefault();
                alert('Selecione o procedimento principal a partir da lista.');
                input.focus();
                return;
            }

            if (value && !hiddenId) {
                event.preventDefault();
                alert('Selecione um procedimento válido da lista de sugestões.');
                input.focus();
                return;
            }
        }
    });

    // ICD-10 Code Search
    const icd10Inputs = Array.from(document.querySelectorAll('.icd10-search-input'));
    const icd10ResultsContainers = Array.from(document.querySelectorAll('.icd10-results'));
    const icd10HiddenInputs = Array.from(document.querySelectorAll('.icd10-hidden-input'));
    const icd10Timeouts = new Map();
    const icd10SearchUrl = '{% url "apps.core:icd10_search_api" %}';

    function getIcd10HiddenInput(input) {
        const hiddenId = input.dataset.hiddenId;
        return hiddenId ? document.getElementById(hiddenId) : null;
    }

    function clearIcd10Selection(input) {
        const hiddenInput = getIcd10HiddenInput(input);
        if (hiddenInput) {
            hiddenInput.value = '';
        }
        input.dataset.icd10Id = '';
        input.dataset.icd10Code = '';
        input.dataset.icd10Description = '';
    }

    function getIcd10ResultsContainer(input) {
        const resultsId = input.dataset.resultsId;
        if (resultsId) {
            const byId = document.getElementById(resultsId);
            if (byId) {
                return byId;
            }
        }
        const wrapper = input.closest('.icd10-search-group');
        return wrapper ? wrapper.querySelector('.icd10-results') : null;
    }

    function getIcd10Spinner(input) {
        const wrapper = input.closest('.input-group');
        return wrapper ? wrapper.querySelector('.search-spinner') : null;
    }

    function showIcd10Spinner(input) {
        const spinner = getIcd10Spinner(input);
        if (spinner) {
            spinner.style.display = 'block';
        }
    }

    function hideIcd10Spinner(input) {
        const spinner = getIcd10Spinner(input);
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    function hideAllIcd10Results() {
        icd10ResultsContainers.forEach(function(container) {
            container.classList.remove('show');
            container.style.display = 'none';
        });
    }

    function renderIcd10Results(input, results) {
        const resultsContainer = getIcd10ResultsContainer(input);
        const hiddenInput = getIcd10HiddenInput(input);

        if (!resultsContainer) {
            return;
        }

        resultsContainer.innerHTML = '';

        if (!results.length) {
            resultsContainer.classList.remove('show');
            resultsContainer.style.display = 'none';
            return;
        }

        results.forEach(function(code) {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <strong>${code.code}</strong><br>
                <small class="text-muted">${code.short_description || code.description}</small>
            `;
            item.addEventListener('click', function() {
                // Display only the code in the input
                input.value = code.code;
                if (hiddenInput) {
                    hiddenInput.value = code.id;
                }
                input.dataset.icd10Id = code.id;
                input.dataset.icd10Code = code.code;
                input.dataset.icd10Description = code.description;
                resultsContainer.classList.remove('show');
                resultsContainer.style.display = 'none';
                hideIcd10Spinner(input);
            });

            resultsContainer.appendChild(item);
        });

        resultsContainer.classList.add('show');
        resultsContainer.style.display = 'block';
    }

    icd10Inputs.forEach(function(input) {
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });

        input.addEventListener('input', function() {
            const query = input.value.trim();
            const resultsContainer = getIcd10ResultsContainer(input);

            clearIcd10Selection(input);

            if (icd10Timeouts.has(input)) {
                clearTimeout(icd10Timeouts.get(input));
            }

            if (query.length < 2) {
                if (resultsContainer) {
                    resultsContainer.classList.remove('show');
                    resultsContainer.style.display = 'none';
                }
                hideIcd10Spinner(input);
                return;
            }

            const timeoutId = setTimeout(function() {
                showIcd10Spinner(input);
                const url = `${icd10SearchUrl}?q=${encodeURIComponent(query)}&limit=10`;
                fetch(url, { credentials: 'same-origin' })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        hideIcd10Spinner(input);
                        renderIcd10Results(input, (data && data.results) ? data.results : []);
                    })
                    .catch(function() {
                        hideIcd10Spinner(input);
                        console.error('Error searching ICD-10 codes');
                    });
            }, 300);

            icd10Timeouts.set(input, timeoutId);
        });
    });

    document.addEventListener('click', function(event) {
        const target = event.target;
        if (!target.closest('.icd10-search-input') && !target.closest('.icd10-results')) {
            hideAllIcd10Results();
        }
    });

    document.getElementById('apac-form').addEventListener('submit', function(event) {
        for (const input of icd10Inputs) {
            const required = input.dataset.required === 'true';
            const value = input.value.trim();
            const hiddenInput = getIcd10HiddenInput(input);
            const hiddenId = hiddenInput ? hiddenInput.value : '';

            if (required && !hiddenId) {
                event.preventDefault();
                alert('Selecione o CID 10 principal a partir da lista.');
                input.focus();
                return;
            }

            if (value && !hiddenId) {
                event.preventDefault();
                alert('Selecione um CID 10 válido da lista de sugestões.');
                input.focus();
                return;
            }
        }
    });
});
</script>
{% endblock %}
