{% extends "pdf_forms/base.html" %}
{% load static %}
{% load pdf_forms_tags %}

{% block page_title %}{{ form_template.name }} - {{ patient.name }}{% endblock %}

{% block app_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'apps.patients:patient_events_timeline' patient_id=patient.id %}">
        <i class="bi bi-clock-history me-1"></i>
        Timeline do Paciente
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'pdf_forms:form_select' patient.id %}">
        Formul√°rios PDF
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ form_template.name }}
    </li>
  </ol>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-file-earmark-pdf me-2"></i>
            {{ form_template.name }}
          </h5>
          <small>Paciente: {{ patient.name }}</small>
        </div>
        {% if form_template.description %}
        <div class="card-body">
          <p class="mb-0">{{ form_template.description }}</p>
        </div>
        {% endif %}
      </div>

      <!-- Form -->
      <div class="card">
        <div class="card-body">
          <form method="post" class="pdf-form">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            {% if form|has_sections %}
            <!-- Sectioned Form Rendering -->
            <div class="accordion form-section-accordion" id="form-sections">
              {% with sections_metadata=form|get_sections_metadata %}
                <!-- Render sectioned fields -->
                {% for section_key, section_data in sections_metadata.sections.items %}
                  {% render_form_section section_key section_data form %}
                {% endfor %}
                
                <!-- Render unsectioned fields if any -->
                {% with unsectioned_fields=sections_metadata.unsectioned_fields %}
                  {% if unsectioned_fields %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-other">
                      <button class="accordion-button collapsed" 
                              type="button" 
                              data-bs-toggle="collapse" 
                              data-bs-target="#collapse-other"
                              aria-expanded="false"
                              aria-controls="collapse-other">
                        <i class="bi bi-gear me-2"></i>
                        Outros Campos
                        <span class="badge bg-secondary ms-auto me-2">
                          {{ unsectioned_fields|length }}
                        </span>
                      </button>
                    </h2>
                    <div id="collapse-other" 
                         class="accordion-collapse collapse" 
                         aria-labelledby="heading-other"
                         data-bs-parent="#form-sections">
                      <div class="accordion-body">
                        <div class="row">
                          {% for field_name in unsectioned_fields %}
                            {% with field=form|lookup:field_name %}
                              {% if field %}
                                {% render_form_field field %}
                              {% endif %}
                            {% endwith %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endwith %}
              {% endwith %}
            </div>
            {% else %}
            <!-- Legacy Form Rendering (Backward Compatibility) -->
            <div class="row">
              {% for field in form %}
                {% render_form_field field %}
              {% endfor %}
            </div>
            {% endif %}

            <div class="d-flex justify-content-between">
              <a
                href="{% url 'apps.patients:patient_events_timeline' patient_id=patient.id %}"
                class="btn btn-outline-secondary"
              >
                <i class="bi bi-arrow-left me-1"></i>
                Voltar
              </a>

              <button type="submit" class="btn btn-primary">
                <i class="bi bi-file-earmark-pdf me-1"></i>
                Gerar PDF
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
