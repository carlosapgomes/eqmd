{% extends 'base_app.html' %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Modelos de Relatório{% endblock %}

{% block app_content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'reports:template_list' %}">
        <i class="bi bi-house me-1"></i>
        Início
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'reports:template_list' %}">
        Modelos de Relatório
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {% if object %}Editar{% else %}Novo{% endif %} Modelo
    </li>
  </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">
    <i class="bi bi-file-earmark-text text-medical-primary me-2"></i>
    {% if object %}Editar{% else %}Novo{% endif %} Modelo
  </h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{% url 'reports:template_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Voltar
    </a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-medical-light">
    <h5 class="card-title mb-0">
      <i class="bi bi-pencil-square me-2"></i>
      {% if object %}Editar{% else %}Criar{% endif %} Modelo de Relatório
    </h5>
  </div>
  <div class="card-body">
    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
      {% for error in form.non_field_errors %}
        <p class="mb-0">{{ error }}</p>
      {% endfor %}
    </div>
    {% endif %}

    <form method="post" class="needs-validation" novalidate>
      {% csrf_token %}

      <div class="mb-3">
        <label for="{{ form.name.id_for_label }}" class="form-label">
          {{ form.name.label }} <span class="text-danger">*</span>
        </label>
        {{ form.name }}
        {% if form.name.errors %}
          <div class="invalid-feedback d-block">
            {% for error in form.name.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
        <div class="form-text">
          Um nome descritivo para identificar este template.
        </div>
      </div>

      <div class="mb-3">
        <label for="{{ form.markdown_body.id_for_label }}" class="form-label">
          {{ form.markdown_body.label }} <span class="text-danger">*</span>
        </label>
        {{ form.markdown_body }}
        {% if form.markdown_body.errors %}
          <div class="invalid-feedback d-block">
            {% for error in form.markdown_body.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
        <div class="form-text">
          Use os placeholders disponíveis (veja a lista completa abaixo).
          Obrigatório: <code>{% templatetag openvariable %}patient_name{% templatetag closevariable %}</code>.
          Opcionalmente, você pode usar <code>{% templatetag openvariable %}page_break{% templatetag closevariable %}</code> para quebras de página.
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <div class="form-check form-switch">
            {{ form.is_active }}
            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
              {{ form.is_active.label }}
            </label>
          </div>
          <div class="form-text">
            Modelos inativos não podem ser usados para criar relatórios.
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-check form-switch">
            {{ form.is_public }}
            <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
              {{ form.is_public.label }}
            </label>
          </div>
          <div class="form-text">
            Modelos públicos são visíveis para todos os usuários autenticados.
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <button type="submit" class="btn btn-medical-primary">
            <i class="bi bi-check-circle me-1"></i>
            {% if object %}Salvar{% else %}Criar{% endif %} Modelo
          </button>
          <a href="{% url 'reports:template_list' %}" class="btn btn-outline-secondary ms-2">
            <i class="bi bi-x-circle me-1"></i>
            Cancelar
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card mt-3 shadow-sm">
  <div class="card-header bg-light">
    <h6 class="card-title mb-0">
      <i class="bi bi-info-circle me-2"></i>
      Sobre Placeholders
    </h6>
  </div>
  <div class="card-body">
    <details>
      <summary class="fw-semibold">Ver lista completa de placeholders e como usar</summary>
      <div class="mt-3">
        <p class="mb-2">
          Placeholders são marcadores entre chaves duplas, por exemplo
          <code>{% templatetag openvariable %}patient_name{% templatetag closevariable %}</code>.
          Eles são substituídos automaticamente quando um relatório é criado a partir deste template.
        </p>
        <p class="mb-3">
          Exemplo: <code>Paciente: {% templatetag openvariable %}patient_name{% templatetag closevariable %}
          (Prontuário: {% templatetag openvariable %}patient_record_number{% templatetag closevariable %})</code>
        </p>
        <div class="row">
          <div class="col-md-6">
            <h6>Dados do paciente</h6>
            <ul class="list-unstyled mb-3">
              <li><code>{% templatetag openvariable %}patient_name{% templatetag closevariable %}</code> - Nome do paciente (obrigatório)</li>
              <li><code>{% templatetag openvariable %}patient_record_number{% templatetag closevariable %}</code> - Número do prontuário</li>
              <li><code>{% templatetag openvariable %}patient_birth_date{% templatetag closevariable %}</code> - Data de nascimento</li>
              <li><code>{% templatetag openvariable %}patient_age{% templatetag closevariable %}</code> - Idade</li>
              <li><code>{% templatetag openvariable %}patient_gender{% templatetag closevariable %}</code> - Sexo</li>
              <li><code>{% templatetag openvariable %}patient_fiscal_number{% templatetag closevariable %}</code> - CPF</li>
              <li><code>{% templatetag openvariable %}patient_healthcard_number{% templatetag closevariable %}</code> - Cartão de saúde</li>
              <li><code>{% templatetag openvariable %}patient_ward{% templatetag closevariable %}</code> - Enfermaria</li>
              <li><code>{% templatetag openvariable %}patient_bed{% templatetag closevariable %}</code> - Leito</li>
              <li><code>{% templatetag openvariable %}patient_status{% templatetag closevariable %}</code> - Status do paciente</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Dados do profissional</h6>
            <ul class="list-unstyled mb-3">
              <li><code>{% templatetag openvariable %}doctor_name{% templatetag closevariable %}</code> - Nome do profissional</li>
              <li><code>{% templatetag openvariable %}doctor_profession{% templatetag closevariable %}</code> - Profissão</li>
              <li><code>{% templatetag openvariable %}doctor_registration_number{% templatetag closevariable %}</code> - Número de registro</li>
              <li><code>{% templatetag openvariable %}doctor_specialty{% templatetag closevariable %}</code> - Especialidade</li>
            </ul>
            <h6>Documento e hospital</h6>
            <ul class="list-unstyled mb-0">
              <li><code>{% templatetag openvariable %}document_date{% templatetag closevariable %}</code> - Data do documento</li>
              <li><code>{% templatetag openvariable %}document_datetime{% templatetag closevariable %}</code> - Data e hora do documento</li>
              <li><code>{% templatetag openvariable %}hospital_name{% templatetag closevariable %}</code> - Nome do hospital</li>
              <li><code>{% templatetag openvariable %}hospital_city{% templatetag closevariable %}</code> - Cidade</li>
              <li><code>{% templatetag openvariable %}hospital_state{% templatetag closevariable %}</code> - Estado</li>
              <li><code>{% templatetag openvariable %}hospital_address{% templatetag closevariable %}</code> - Endereço</li>
              <li><code>{% templatetag openvariable %}page_break{% templatetag closevariable %}</code> - Quebra de página (útil em PDFs)</li>
            </ul>
          </div>
        </div>
        <p class="mb-0 mt-2 text-muted small">
          Obrigatório: <code>{% templatetag openvariable %}patient_name{% templatetag closevariable %}</code>.
          Recomendado: <code>{% templatetag openvariable %}patient_record_number{% templatetag closevariable %}</code>.
        </p>
      </div>
    </details>
  </div>
</div>
{% endblock %}
