{% extends "base_app.html" %}
{% load static %}

{% block title %}Evolução - {{ dailynote.patient.name }}{% endblock %}

{% block extra_head %}
<!-- Markdown rendering styles -->
<style>
  .markdown-content {
    line-height: 1.6;
  }
  
  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  
  .markdown-content p {
    margin-bottom: 1rem;
  }
  
  .markdown-content ul,
  .markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
  }
  
  .markdown-content blockquote {
    border-left: 4px solid #dee2e6;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6c757d;
  }
  
  .markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }
  
  .markdown-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
  }
  
  .patient-avatar {
    width: 48px;
    height: 48px;
    font-size: 1.25rem;
  }
</style>
{% endblock %}

{% block app_content %}
<!-- Header with breadcrumb and actions -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'dailynotes:dailynote_list' %}">
        <i class="bi bi-journal-medical me-1"></i>
        Evoluções
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ dailynote.patient.name }} - {{ dailynote.event_datetime|date:"d/m/Y H:i" }}
    </li>
  </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">
    <i class="bi bi-journal-medical text-medical-primary me-2"></i>
    Evolução Diária
  </h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <a href="{% url 'dailynotes:dailynote_print' pk=dailynote.pk %}" 
         class="btn btn-outline-primary" 
         target="_blank" 
         title="Imprimir evolução">
        <i class="bi bi-printer me-1"></i>
        Imprimir
      </a>
    </div>
    
    {% if perms.events.change_event and can_edit_dailynote %}
    <a href="{% url 'dailynotes:dailynote_update' pk=dailynote.pk %}" class="btn btn-medical-primary me-2">
      <i class="bi bi-pencil me-1"></i>
      Editar
    </a>
    {% endif %}
    {% if perms.events.delete_event and can_delete_dailynote %}
    <a href="{% url 'dailynotes:dailynote_delete' pk=dailynote.pk %}" class="btn btn-outline-danger me-2">
      <i class="bi bi-trash me-1"></i>
      Excluir
    </a>
    {% endif %}
    <a href="{% url 'dailynotes:dailynote_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Voltar
    </a>
  </div>
</div>

<div class="row">
  <!-- Patient Information Card -->
  <div class="col-lg-4 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-medical-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-person me-2"></i>
          Informações do Paciente
        </h5>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="patient-avatar bg-medical-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
            {{ dailynote.patient.name|first|upper }}
          </div>
          <div>
            <h6 class="mb-1">{{ dailynote.patient.name }}</h6>
            <small class="text-muted">ID: {{ dailynote.patient.id|slice:":8" }}...</small>
          </div>
        </div>
        
        <dl class="row mb-0">
          <dt class="col-sm-5">Data Nasc.:</dt>
          <dd class="col-sm-7">{{ dailynote.patient.birthday|date:"d/m/Y" }}</dd>
          
          {% if dailynote.patient.phone %}
          <dt class="col-sm-5">Telefone:</dt>
          <dd class="col-sm-7">{{ dailynote.patient.phone }}</dd>
          {% endif %}
          
          {% if dailynote.patient.id_number %}
          <dt class="col-sm-5">RG:</dt>
          <dd class="col-sm-7">{{ dailynote.patient.id_number }}</dd>
          {% endif %}
        </dl>
      </div>
    </div>
  </div>
  
  <!-- Evolution Details -->
  <div class="col-lg-8 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-file-text me-2"></i>
          Detalhes da Evolução
        </h5>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-3">Data e Hora:</dt>
          <dd class="col-sm-9">
            <span class="fw-medium">{{ dailynote.event_datetime|date:"d/m/Y" }}</span>
            às
            <span class="fw-medium">{{ dailynote.event_datetime|date:"H:i" }}</span>
          </dd>
          
          <dt class="col-sm-3">Descrição:</dt>
          <dd class="col-sm-9">{{ dailynote.description }}</dd>
          
          <dt class="col-sm-3">Criado por:</dt>
          <dd class="col-sm-9">
            <div class="d-flex align-items-center">
              <div class="avatar-sm bg-medical-teal text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                {{ dailynote.created_by.get_full_name|default:dailynote.created_by.username|first|upper }}
              </div>
              <div>
                <div class="fw-medium">
                  {{ dailynote.created_by.get_full_name|default:dailynote.created_by.username }}
                </div>
                <small class="text-muted">{{ dailynote.created_at|date:"d/m/Y H:i" }}</small>
              </div>
            </div>
          </dd>
          
          {% if dailynote.updated_at != dailynote.created_at %}
          <dt class="col-sm-3">Atualizado:</dt>
          <dd class="col-sm-9">
            <div class="d-flex align-items-center">
              <div class="avatar-sm bg-medical-gray text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                {{ dailynote.updated_by.get_full_name|default:dailynote.updated_by.username|first|upper }}
              </div>
              <div>
                <div class="fw-medium">
                  {{ dailynote.updated_by.get_full_name|default:dailynote.updated_by.username }}
                </div>
                <small class="text-muted">{{ dailynote.updated_at|date:"d/m/Y H:i" }}</small>
              </div>
            </div>
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>
  </div>
</div>

<!-- Content Section -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-medical-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-file-text me-2"></i>
          Conteúdo da Evolução
        </h5>
      </div>
      <div class="card-body">
        {% if dailynote.content %}
        <div class="markdown-content">
          {{ dailynote.content|linebreaks }}
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="bi bi-file-text text-muted" style="font-size: 2rem;"></i>
          <p class="text-muted mt-2 mb-0">Nenhum conteúdo foi adicionado a esta evolução.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons for Mobile -->
<div class="d-lg-none mt-4">
  <div class="d-grid gap-2">
    {% if perms.events.change_event and can_edit_dailynote %}
    <a href="{% url 'dailynotes:dailynote_update' pk=dailynote.pk %}" class="btn btn-medical-primary">
      <i class="bi bi-pencil me-1"></i>
      Editar Evolução
    </a>
    {% endif %}
    {% if perms.events.delete_event and can_delete_dailynote %}
    <a href="{% url 'dailynotes:dailynote_delete' pk=dailynote.pk %}" class="btn btn-outline-danger">
      <i class="bi bi-trash me-1"></i>
      Excluir Evolução
    </a>
    {% endif %}
    <a href="{% url 'dailynotes:dailynote_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Voltar à Lista
    </a>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<style>
  .avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 0.875rem;
  }
</style>
{% endblock %}
