{% extends "patients/patient_base.html" %}
{% load static %}
{% load patient_tags %}
{% block title %}{{ patient.name }}{% endblock %}
{% block patient_content %}
<div class="row">
  <div class="col-12">
    <!-- Header with Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'apps.patients:patient_list' %}" class="text-medical-teal text-decoration-none">
                <i class="bi bi-person-lines-fill me-1"></i>Pacientes
              </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ patient.name }}</li>
          </ol>
        </nav>
        <h1 class="h3 text-medical-dark-gray mb-0">
          <i class="bi bi-person me-2 text-medical-primary"></i>
          {{ patient.name }}
        </h1>
      </div>
      <div class="btn-group" role="group">
        <a href="{% url 'apps.patients:patient_update' patient.pk %}" class="btn btn-medical-outline-primary">
          <i class="bi bi-pencil me-2"></i>
          Editar
        </a>
        <a href="{% url 'apps.patients:patient_delete' patient.pk %}" class="btn btn-outline-danger">
          <i class="bi bi-trash me-2"></i>
          Excluir
        </a>
      </div>
    </div>

    <!-- Main Patient Information -->
    <div class="row">
      <!-- Basic Information Card -->
      <div class="col-lg-6 mb-4">
        <div class="card card-medical">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-info-circle me-2 text-medical-primary"></i>
              Informações Pessoais
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Nome Completo</label>
                <p class="form-control-plaintext text-medical-dark-gray">{{ patient.name }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Data de Nascimento</label>
                <p class="form-control-plaintext text-medical-dark-gray">
                  <i class="bi bi-calendar3 me-2"></i>
                  {{ patient.birthday|date:"d/m/Y" }}
                </p>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Telefone</label>
                <p class="form-control-plaintext text-medical-dark-gray">
                  {% if patient.phone %}
                    <i class="bi bi-telephone me-2"></i>{{ patient.phone }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Status</label>
                <p class="form-control-plaintext text-medical-dark-gray">
                  {{ patient.status|patient_status_badge }}
                </p>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label text-medical-gray">RG</label>
                <p class="form-control-plaintext text-medical-dark-gray">{{ patient.id_number|default:"-" }}</p>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label text-medical-gray">CPF</label>
                <p class="form-control-plaintext text-medical-dark-gray">{{ patient.fiscal_number|default:"-" }}</p>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label text-medical-gray">Cartão SUS</label>
                <p class="form-control-plaintext text-medical-dark-gray">{{ patient.healthcard_number|default:"-" }}</p>
              </div>
            </div>

            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label text-medical-gray">Tags</label>
                <div class="form-control-plaintext text-medical-dark-gray">
                  {% for tag in patient.tags.all %}
                  <span class="badge me-1" style="background-color: {{ tag.color }}; color: white;">
                    {{ tag.name }}
                  </span>
                  {% empty %}
                  <span class="text-muted">Nenhuma tag atribuída</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hospital Information Card -->
      <div class="col-lg-6 mb-4">
        <div class="card card-medical">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-building me-2 text-medical-primary"></i>
              Informações Hospitalares
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Hospital Atual</label>
                <p class="form-control-plaintext text-medical-dark-gray">
                  {% if patient.current_hospital %}
                    <i class="bi bi-building me-2"></i>{{ patient.current_hospital.name }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label text-medical-gray">Leito</label>
                <p class="form-control-plaintext text-medical-dark-gray">
                  {% if patient.bed %}
                    <i class="bi bi-door-open me-2"></i>{{ patient.bed }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </p>
              </div>
            </div>

            {% if patient.address or patient.city or patient.state or patient.zip_code %}
            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label text-medical-gray">Endereço</label>
                <div class="text-medical-dark-gray">
                  <i class="bi bi-geo-alt me-2"></i>
                  {% if patient.address %}
                    <div>{{ patient.address }}</div>
                  {% endif %}
                  {% if patient.city or patient.state or patient.zip_code %}
                    <div>
                      {% if patient.city %}{{ patient.city }}{% endif %}{% if patient.city and patient.state %}, {% endif %}{% if patient.state %}{{ patient.state }}{% endif %}{% if patient.zip_code %} - {{ patient.zip_code }}{% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% else %}
            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label text-medical-gray">Endereço</label>
                <p class="form-control-plaintext text-muted">-</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Related Data Sections -->
    <div class="row">
      <!-- Hospital Records Section -->
      <div class="col-lg-8 mb-4">
        <div class="card card-medical">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-file-medical me-2 text-medical-primary"></i>
              Registros Hospitalares
            </h5>
            <a href="{% url 'apps.patients:hospital_record_create' patient_id=patient.pk %}" class="btn btn-medical-outline-primary btn-sm">
              <i class="bi bi-plus me-2"></i>
              Adicionar Registro
            </a>
          </div>
          <div class="card-body">
            {% if patient.hospital_records.all %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Hospital</th>
                    <th>Número do Prontuário</th>
                    <th>Primeira Internação</th>
                    <th>Última Internação</th>
                    <th>Última Alta</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for record in patient.hospital_records.all %}
                  <tr>
                    <td>{{ record.hospital.short_name }}</td>
                    <td>{{ record.record_number }}</td>
                    <td>{{ record.first_admission_date|date:"d/m/Y"|default:"-" }}</td>
                    <td>{{ record.last_admission_date|date:"d/m/Y"|default:"-" }}</td>
                    <td>{{ record.last_discharge_date|date:"d/m/Y"|default:"-" }}</td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'apps.patients:hospital_record_update' record.pk %}" class="btn btn-outline-secondary" title="Editar">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'apps.patients:hospital_record_delete' record.pk %}" class="btn btn-outline-danger" title="Excluir">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="text-center py-4">
              <i class="bi bi-file-medical display-4 text-muted mb-3"></i>
              <h6 class="text-medical-dark-gray">Nenhum Registro Hospitalar</h6>
              <p class="text-medical-gray mb-3">
                Este paciente ainda não possui registros hospitalares cadastrados.
              </p>
              <a href="{% url 'apps.patients:hospital_record_create' patient_id=patient.pk %}" class="btn btn-medical-primary">
                <i class="bi bi-plus me-2"></i>
                Adicionar Primeiro Registro
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Metadata Card -->
      <div class="col-lg-4 mb-4">
        <div class="card card-medical">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-history me-2 text-medical-primary"></i>
              Informações do Sistema
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label text-medical-gray">Criado em</label>
              <p class="form-control-plaintext text-medical-dark-gray">
                <i class="bi bi-calendar3 me-2"></i>
                {{ patient.created_at|date:"d/m/Y à\s H:i" }}
              </p>
            </div>
            
            {% if patient.created_by %}
            <div class="mb-3">
              <label class="form-label text-medical-gray">Criado por</label>
              <p class="form-control-plaintext text-medical-dark-gray">
                <i class="bi bi-person me-2"></i>
                {{ patient.created_by.profile.display_name|default:patient.created_by.username }}
              </p>
            </div>
            {% endif %}
            
            <div class="mb-3">
              <label class="form-label text-medical-gray">Última atualização</label>
              <p class="form-control-plaintext text-medical-dark-gray">
                <i class="bi bi-clock me-2"></i>
                {{ patient.updated_at|date:"d/m/Y à\s H:i" }}
              </p>
            </div>
            
            {% if patient.updated_by %}
            <div class="mb-3">
              <label class="form-label text-medical-gray">Atualizado por</label>
              <p class="form-control-plaintext text-medical-dark-gray">
                <i class="bi bi-person me-2"></i>
                {{ patient.updated_by.profile.display_name|default:patient.updated_by.username }}
              </p>
            </div>
            {% endif %}
            
            <div class="mb-0">
              <label class="form-label text-medical-gray">ID Único</label>
              <p class="form-control-plaintext text-medical-gray" style="font-family: monospace; font-size: 0.875rem;">
                {{ patient.id }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions & Recent Events -->
    <div class="row">
      <div class="col-md-6">
        <div class="card card-medical">
          <div class="card-header bg-medical-teal text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-lightning-charge me-2"></i>
              Ações Rápidas
            </h5>
            <a href="{% url 'patients:patient_events_timeline' patient.pk %}" 
               class="btn btn-sm btn-outline-light">
              <i class="bi bi-clock-history me-1"></i>
              Timeline Completa
            </a>
          </div>
          <div class="card-body">
            <!-- Quick Action Buttons -->
            <div class="row g-2 mb-3">
              <div class="col-6">
                <a href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}" 
                   class="btn btn-medical-success btn-sm w-100">
                  <i class="bi bi-journal-text d-block fs-4 mb-1"></i>
                  <small>Nova Evolução</small>
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}" 
                   class="btn btn-medical-warning btn-sm w-100">
                  <i class="bi bi-clipboard2-data d-block fs-4 mb-1"></i>
                  <small>Novo Exame</small>
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}" 
                   class="btn btn-medical-info btn-sm w-100">
                  <i class="bi bi-camera d-block fs-4 mb-1"></i>
                  <small>Adicionar Foto</small>
                </a>
              </div>
              <div class="col-6">
                <a href="{% url 'apps.dailynotes:patient_dailynote_create' patient.pk %}" 
                   class="btn btn-medical-danger btn-sm w-100">
                  <i class="bi bi-scissors d-block fs-4 mb-1"></i>
                  <small>Procedimento</small>
                </a>
              </div>
            </div>

            <!-- Recent Events Widget -->
            <div class="border-top pt-3">
              <h6 class="text-medical-primary mb-2">
                <i class="bi bi-clock me-1"></i>
                Eventos Recentes
              </h6>
              <div id="recent-events-widget">
                {% include 'events/widgets/recent_events.html' with patient=patient limit=3 %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
