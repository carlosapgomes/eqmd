{% load static %}
{% if ward_data %}
<div class="ward-tree">
  {% for ward_info in ward_data %}
  <div class="ward-branch mb-4">
    <!-- Ward Header -->
    <div class="ward-header p-3 bg-light rounded">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="d-flex align-items-center mb-2 mb-md-0">
          <button
            class="btn btn-sm btn-link p-0 me-2 ward-toggle"
            type="button"
            data-ward="{{ ward_info.ward.id }}"
            aria-expanded="false"
          >
            <i class="bi bi-chevron-right"></i>
          </button>
          <i class="bi bi-building text-medical-primary me-2"></i>
          <div>
            <h5 class="mb-0">
              {{ ward_info.ward.abbreviation }} - {{ ward_info.ward.name }}
            </h5>
            {% if ward_info.ward.floor %}
            <small class="text-muted">{{ ward_info.ward.floor }}</small>
            {% endif %}
          </div>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="badge bg-medical-primary">
            {{ ward_info.patient_count }}{% if ward_info.capacity_estimate %} / {{ ward_info.capacity_estimate }}{% endif %} pacientes
          </span>
          {% if ward_info.utilization_percentage %}
          <span
            class="badge {% if ward_info.utilization_percentage > 90 %}bg-danger{% elif ward_info.utilization_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}"
          >
            {{ ward_info.utilization_percentage }}%
          </span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Patients List -->
    <div
      class="ward-patients collapse"
      id="ward-{{ ward_info.ward.id }}"
    >
      {% if ward_info.patients %}
      <div class="ps-4 pt-2">
        {% for patient_info in ward_info.patients %}
        <div class="patient-item p-3 mb-2 bg-white border rounded">
          <div class="d-flex flex-column flex-md-row justify-content-between">
            <!-- Patient Info Section -->
            <div class="flex-grow-1 mb-2 mb-md-0">
              <div class="d-flex align-items-start">
                <i class="bi bi-hospital text-medical-secondary me-2 mt-1"></i>
                <div class="flex-grow-1">
                  <!-- Bed and Name -->
                  <div class="mb-1">
                    <strong class="text-medical-primary">{{ patient_info.bed }}</strong>
                    <span class="mx-2">â€¢</span>
                    <span class="fw-medium">{{ patient_info.patient.name }}</span>
                  </div>
                  <!-- Admission Duration -->
                  {% if patient_info.admission_duration %}
                  <div class="mb-2">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>
                      {{ patient_info.admission_duration }}
                    </small>
                  </div>
                  {% endif %}
                  <!-- Tags -->
                  {% if patient_info.tags %}
                  <div class="d-flex flex-wrap gap-1">
                    {% for tag in patient_info.tags %}
                    <span
                      class="badge"
                      style="background-color: {{ tag.allowed_tag.color }}; font-size: 0.7rem;"
                    >
                      {{ tag.allowed_tag.name }}
                    </span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            <!-- Timeline Button -->
            <div class="d-flex align-items-start align-items-md-center">
              <a
                href="{% url 'apps.patients:patient_events_timeline' patient_id=patient_info.patient.pk %}"
                class="btn btn-sm btn-outline-medical-primary w-100 w-md-auto"
              >
                <i class="bi bi-clock-history me-1"></i>
                Timeline
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="ps-4 pt-2">
        <div class="text-muted fst-italic p-3">
          <i class="bi bi-info-circle me-2"></i>
          Nenhum paciente internado nesta ala
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
  <i class="bi bi-building display-4 text-muted mb-3"></i>
  <h4>Nenhuma ala cadastrada</h4>
  <p class="text-muted">
    Configure as alas do hospital para visualizar o mapa de pacientes.
  </p>
  {% if perms.patients.add_ward %}
  <a
    href="{% url 'apps.patients:ward_create' %}"
    class="btn btn-medical-primary"
  >
    <i class="bi bi-plus-circle me-2"></i>
    Adicionar Ala
  </a>
  {% endif %}
</div>
{% endif %}