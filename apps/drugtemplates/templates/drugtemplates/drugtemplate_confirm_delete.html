{% extends "drugtemplates/base.html" %}
{% load static %}

{% block title %}Excluir Template - {{ drugtemplate.name }}{% endblock %}

{% block extra_head %}
<style>
  .danger-zone {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 0.375rem;
    padding: 1.5rem;
  }
  
  .danger-icon {
    width: 64px;
    height: 64px;
    font-size: 2rem;
  }
  
  .creator-avatar {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
  
  .template-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .usage-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 0.375rem;
    padding: 1rem;
  }
</style>
{% endblock %}

{% block drug_template_content %}
<!-- Header with breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'drugtemplates:list' %}">
        <i class="bi bi-capsule me-1"></i>
        Templates de Medicamentos
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'drugtemplates:detail' pk=drugtemplate.pk %}">
        {{ drugtemplate.name }}
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Excluir</li>
  </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">
    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
    Confirmar Exclusão
  </h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{% url 'drugtemplates:detail' pk=drugtemplate.pk %}" class="btn btn-outline-secondary me-2">
      <i class="bi bi-eye me-1"></i>
      Ver Detalhes
    </a>
    <a href="{% url 'drugtemplates:list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Lista de Templates
    </a>
  </div>
</div>

<!-- Warning Section -->
<div class="danger-zone mb-4">
  <div class="row align-items-center">
    <div class="col-auto">
      <div class="danger-icon bg-danger text-white rounded-circle d-flex align-items-center justify-content-center">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
    </div>
    <div class="col">
      <h4 class="text-danger mb-2">Atenção: Ação Irreversível</h4>
      <p class="mb-0">
        Você está prestes a excluir permanentemente este template de medicamento. 
        <strong>Esta ação não pode ser desfeita</strong> e todos os dados serão perdidos.
      </p>
    </div>
  </div>
</div>

<!-- Usage Information -->
{% if usage_count > 0 %}
<div class="alert alert-info mb-4">
  <div class="row align-items-center">
    <div class="col-auto">
      <i class="bi bi-info-circle text-info fs-2"></i>
    </div>
    <div class="col">
      <h5 class="text-info mb-2">Informações de Uso</h5>
      <p class="mb-0">
        <strong>Este template foi usado em {{ usage_count }} prescrição(ões).</strong>
        A exclusão é segura - os dados do template já foram copiados para as prescrições existentes.
      </p>
    </div>
  </div>
</div>
{% endif %}

<!-- Template Details to be Deleted -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">
      <i class="bi bi-capsule me-2"></i>
      Template que será excluído
    </h5>
  </div>
  <div class="card-body">
    <div class="row">
      <!-- Template Information -->
      <div class="col-md-6">
        <h6 class="text-muted mb-3">Informações do Template</h6>
        <dl class="row">
          <dt class="col-sm-4">Nome:</dt>
          <dd class="col-sm-8">{{ drugtemplate.name }}</dd>
          
          <dt class="col-sm-4">Apresentação:</dt>
          <dd class="col-sm-8">{{ drugtemplate.presentation }}</dd>
          
          <dt class="col-sm-4">Contador de Uso:</dt>
          <dd class="col-sm-8">
            <span class="badge bg-info">{{ drugtemplate.usage_count }} vez{{ drugtemplate.usage_count|pluralize:"es" }}</span>
          </dd>
          
          <dt class="col-sm-4">Visibilidade:</dt>
          <dd class="col-sm-8">
            {% if drugtemplate.is_public %}
              <span class="badge bg-success">Público</span>
            {% else %}
              <span class="badge bg-secondary">Privado</span>
            {% endif %}
          </dd>
        </dl>
      </div>
      
      <!-- Creator Information -->
      <div class="col-md-6">
        <h6 class="text-muted mb-3">Informações de Criação</h6>
        <div class="d-flex align-items-center mb-3">
          <div class="creator-avatar bg-medical-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
            {{ drugtemplate.creator.get_full_name|first|upper }}
          </div>
          <div>
            <div class="fw-medium">{{ drugtemplate.creator.get_full_name|default:drugtemplate.creator.username }}</div>
            <small class="text-muted">Criador do template</small>
          </div>
        </div>
        
        <dl class="row">
          <dt class="col-sm-5">Criado em:</dt>
          <dd class="col-sm-7">{{ drugtemplate.created_at|date:"d/m/Y H:i" }}</dd>
          
          <dt class="col-sm-5">Atualizado em:</dt>
          <dd class="col-sm-7">{{ drugtemplate.updated_at|date:"d/m/Y H:i" }}</dd>
        </dl>
      </div>
    </div>
    
    <!-- Usage Instructions -->
    {% if drugtemplate.usage_instructions %}
    <div class="mt-3">
      <h6 class="text-muted mb-2">Instruções de Uso</h6>
      <div class="template-preview">
        {{ drugtemplate.usage_instructions|linebreaks|truncatewords:50 }}
        {% if drugtemplate.usage_instructions|wordcount > 50 %}
        <div class="text-muted mt-2">
          <small>
            <i class="bi bi-three-dots"></i>
            Conteúdo truncado. Total: {{ drugtemplate.usage_instructions|wordcount }} palavras.
          </small>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Confirmation Form -->
<div class="card shadow-sm">
  <div class="card-header bg-danger text-white">
    <h5 class="card-title mb-0">
      <i class="bi bi-trash me-2"></i>
      Confirmar Exclusão
    </h5>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      
      <div class="alert alert-warning" role="alert">
        <h6 class="alert-heading">
          <i class="bi bi-info-circle me-2"></i>
          Antes de continuar, confirme:
        </h6>
        <ul class="mb-0">
          <li>Você tem certeza de que deseja excluir este template?</li>
          <li>Você entende que esta ação é irreversível?</li>
          <li>Prescrições existentes não serão afetadas (dados já foram copiados).</li>
          {% if drugtemplate.is_public %}
          <li><strong>Este é um template público</strong> - outros usuários podem estar usando-o.</li>
          {% endif %}
        </ul>
      </div>
      
      <div class="form-check mb-4">
        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
        <label class="form-check-label" for="confirmDelete">
          <strong>Sim, eu entendo que esta ação é irreversível e desejo excluir este template permanentemente.</strong>
        </label>
        <div class="invalid-feedback">
          Você deve confirmar que entende as consequências desta ação.
        </div>
      </div>
      
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <button type="submit" class="btn btn-danger" id="deleteButton" disabled>
            <i class="bi bi-trash me-1"></i>
            Sim, Excluir Permanentemente
          </button>
        </div>
        <div>
          <a href="{% url 'drugtemplates:detail' pk=drugtemplate.pk %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-x-circle me-1"></i>
            Cancelar
          </a>
          <a href="{% url 'drugtemplates:update' pk=drugtemplate.pk %}" class="btn btn-medical-primary">
            <i class="bi bi-pencil me-1"></i>
            Editar ao invés de excluir
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Additional Information -->
<div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h6 class="card-title mb-0">
      <i class="bi bi-info-circle me-2"></i>
      Informações Importantes
    </h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6>O que acontece quando você exclui:</h6>
        <ul class="list-unstyled">
          <li><i class="bi bi-x-circle text-danger me-2"></i>O template é removido permanentemente</li>
          <li><i class="bi bi-x-circle text-danger me-2"></i>Todas as configurações são perdidas</li>
          <li><i class="bi bi-x-circle text-danger me-2"></i>Não é possível recuperar os dados</li>
          <li><i class="bi bi-check-circle text-success me-2"></i>Prescrições existentes permanecem intactas</li>
        </ul>
      </div>
      <div class="col-md-6">
        <h6>Alternativas à exclusão:</h6>
        <ul class="list-unstyled">
          <li><i class="bi bi-pencil text-primary me-2"></i>Editar o template existente</li>
          <li><i class="bi bi-eye-slash text-info me-2"></i>Tornar o template privado</li>
          <li><i class="bi bi-copy text-warning me-2"></i>Criar uma nova versão</li>
          <li><i class="bi bi-archive text-secondary me-2"></i>Desativar temporariamente</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteButton = document.getElementById('deleteButton');
    
    // Enable/disable delete button based on checkbox
    confirmCheckbox.addEventListener('change', function() {
      deleteButton.disabled = !this.checked;
      
      if (this.checked) {
        deleteButton.classList.remove('btn-secondary');
        deleteButton.classList.add('btn-danger');
      } else {
        deleteButton.classList.remove('btn-danger');
        deleteButton.classList.add('btn-secondary');
      }
    });
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
      if (!confirmCheckbox.checked) {
        event.preventDefault();
        event.stopPropagation();
        confirmCheckbox.classList.add('is-invalid');
      } else {
        // Double confirmation
        const confirmed = confirm(
          'ÚLTIMA CONFIRMAÇÃO: Tem certeza absoluta de que deseja excluir este template? ' +
          'Esta ação NÃO PODE ser desfeita.'
        );
        
        if (!confirmed) {
          event.preventDefault();
          event.stopPropagation();
        }
      }
    });
  });
</script>
{% endblock %}